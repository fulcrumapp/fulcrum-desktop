"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _progress = _interopRequireDefault(require("progress"));

var _util = require("util");

var _app = _interopRequireDefault(require("../../app"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Task {
  constructor({
    synchronizer,
    syncState
  }) {
    this._synchronizer = synchronizer;
    this._syncState = syncState;
    this._isSimpleShell = _app.default.args.simpleOutput || process.platform === 'win32';
    this._noProgress = _app.default.args.progress === false || !process.stdout.isTTY;
  }

  get synchronizer() {
    return this._synchronizer;
  }

  getSyncState(resource, scope = null) {
    return this._syncState.find(object => {
      return object.resource === resource && (object.scope == null && scope === '' || object.scope === scope);
    });
  }

  async checkSyncState() {
    const scope = this.syncResourceScope || '';
    const resource = this.syncResourceName;
    const oldState = await this.account.findSyncState({
      resource,
      scope
    });
    const newState = this.getSyncState(resource, scope || '');
    let needsUpdate = true;

    if (oldState && newState && oldState.hash === newState.hash) {
      needsUpdate = false;
    }

    const update = async () => {
      if (oldState && newState) {
        oldState.hash = newState.hash;
        oldState.scope = oldState.scope || '';
        await oldState.save();
      }
    };

    return {
      needsUpdate,
      state: oldState,
      update
    };
  }

  async execute({
    account,
    dataSource
  }) {
    this.account = account;
    this.db = account.db;
    const syncName = this.syncResourceName;

    if (syncName) {
      await this.trigger(`${syncName}:start`, {
        task: this
      });
    }

    const result = await this.run({
      account,
      dataSource
    });

    if (this.bar) {
      console.log('');
    }

    if (syncName) {
      await this.trigger(`${syncName}:finish`, {
        task: this
      });
    }

    return result;
  }

  trigger(name, args) {
    return _app.default.emit(name, {
      account: this.account,
      ...args
    });
  }

  get downloading() {
    return this._isSimpleShell ? '[downloading]' : 'ðŸ˜€ ';
  }

  get processing() {
    return this._isSimpleShell ? '[processing]' : 'ðŸ¤” ';
  }

  get finished() {
    return this._isSimpleShell ? '[finished]' : 'ðŸ˜Ž ';
  }

  progress({
    message,
    count,
    total
  }) {
    if (this._noProgress) {
      if (message !== this._lastMessage) {
        fulcrum.logger.log(message);
        this._lastMessage = message;
      }

      return;
    }

    let fmt = '';

    if (total === -1) {
      fmt = (0, _util.format)('%s (:current) :elapsed', message.green);
    } else if (count != null) {
      fmt = (0, _util.format)('%s :bar :percent (:current/:total) :etas :elapsed', message.green);
    } else {
      fmt = (0, _util.format)('%s', message.green);
    } // const fmt = count != null ? format('%s :bar :percent (:current/:total) :etas :elapsed', message.green)
    //                           : format('%s', message.green);


    if (!this.bar) {
      const options = {
        width: 40,
        total: total || 1,
        complete: 'â–‡'.green,
        incomplete: '-',
        clear: false
      };
      this.bar = new _progress.default(fmt, options);
      this.bar.tick(0);
    }

    this.bar.fmt = fmt;

    if (total != null) {
      this.bar.total = total || 1;
    }

    if (this._message !== message) {
      this.bar.curr = 0;
      this.bar.render();
      this._message = message;
    }

    if (count != null) {
      this.bar.curr = count;
      this.bar.render();
    }
  }

  async markDeletedObjects(localObjects, newObjects, typeName, propName) {
    // delete all objects that don't exist on the server anymore
    for (const object of localObjects) {
      let objectExistsOnServer = false;

      for (const attributes of newObjects) {
        if (attributes.id === object.id) {
          objectExistsOnServer = true;
          break;
        }
      }

      if (!objectExistsOnServer) {
        const isChanged = object._deletedAt == null;
        object._deletedAt = object._deletedAt ? object._deletedAt : new Date();
        await object.save();

        if (isChanged) {
          await this.trigger(`${typeName}:delete`, {
            [propName || typeName]: object
          });
        }
      }
    }
  }

  async lookup(record, resourceID, propName, getter) {
    if (resourceID) {
      const object = await new Promise(resolve => {
        this.dataSource[getter](resourceID, (err, object) => resolve(object));
      });

      if (object) {
        record[propName] = object.rowID;
      }
    }
  }

}

exports.default = Task;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zeW5jL3Rhc2tzL3Rhc2suanMiXSwibmFtZXMiOlsiVGFzayIsImNvbnN0cnVjdG9yIiwic3luY2hyb25pemVyIiwic3luY1N0YXRlIiwiX3N5bmNocm9uaXplciIsIl9zeW5jU3RhdGUiLCJfaXNTaW1wbGVTaGVsbCIsImFwcCIsImFyZ3MiLCJzaW1wbGVPdXRwdXQiLCJwcm9jZXNzIiwicGxhdGZvcm0iLCJfbm9Qcm9ncmVzcyIsInByb2dyZXNzIiwic3Rkb3V0IiwiaXNUVFkiLCJnZXRTeW5jU3RhdGUiLCJyZXNvdXJjZSIsInNjb3BlIiwiZmluZCIsIm9iamVjdCIsImNoZWNrU3luY1N0YXRlIiwic3luY1Jlc291cmNlU2NvcGUiLCJzeW5jUmVzb3VyY2VOYW1lIiwib2xkU3RhdGUiLCJhY2NvdW50IiwiZmluZFN5bmNTdGF0ZSIsIm5ld1N0YXRlIiwibmVlZHNVcGRhdGUiLCJoYXNoIiwidXBkYXRlIiwic2F2ZSIsInN0YXRlIiwiZXhlY3V0ZSIsImRhdGFTb3VyY2UiLCJkYiIsInN5bmNOYW1lIiwidHJpZ2dlciIsInRhc2siLCJyZXN1bHQiLCJydW4iLCJiYXIiLCJjb25zb2xlIiwibG9nIiwibmFtZSIsImVtaXQiLCJkb3dubG9hZGluZyIsInByb2Nlc3NpbmciLCJmaW5pc2hlZCIsIm1lc3NhZ2UiLCJjb3VudCIsInRvdGFsIiwiX2xhc3RNZXNzYWdlIiwiZnVsY3J1bSIsImxvZ2dlciIsImZtdCIsImdyZWVuIiwib3B0aW9ucyIsIndpZHRoIiwiY29tcGxldGUiLCJpbmNvbXBsZXRlIiwiY2xlYXIiLCJQcm9ncmVzc0JhciIsInRpY2siLCJfbWVzc2FnZSIsImN1cnIiLCJyZW5kZXIiLCJtYXJrRGVsZXRlZE9iamVjdHMiLCJsb2NhbE9iamVjdHMiLCJuZXdPYmplY3RzIiwidHlwZU5hbWUiLCJwcm9wTmFtZSIsIm9iamVjdEV4aXN0c09uU2VydmVyIiwiYXR0cmlidXRlcyIsImlkIiwiaXNDaGFuZ2VkIiwiX2RlbGV0ZWRBdCIsIkRhdGUiLCJsb29rdXAiLCJyZWNvcmQiLCJyZXNvdXJjZUlEIiwiZ2V0dGVyIiwiUHJvbWlzZSIsInJlc29sdmUiLCJlcnIiLCJyb3dJRCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOzs7O0FBRWUsTUFBTUEsSUFBTixDQUFXO0FBQ3hCQyxFQUFBQSxXQUFXLENBQUM7QUFBQ0MsSUFBQUEsWUFBRDtBQUFlQyxJQUFBQTtBQUFmLEdBQUQsRUFBNEI7QUFDckMsU0FBS0MsYUFBTCxHQUFxQkYsWUFBckI7QUFDQSxTQUFLRyxVQUFMLEdBQWtCRixTQUFsQjtBQUVBLFNBQUtHLGNBQUwsR0FBc0JDLGFBQUlDLElBQUosQ0FBU0MsWUFBVCxJQUF5QkMsT0FBTyxDQUFDQyxRQUFSLEtBQXFCLE9BQXBFO0FBQ0EsU0FBS0MsV0FBTCxHQUFtQkwsYUFBSUMsSUFBSixDQUFTSyxRQUFULEtBQXNCLEtBQXRCLElBQStCLENBQUNILE9BQU8sQ0FBQ0ksTUFBUixDQUFlQyxLQUFsRTtBQUNEOztBQUVlLE1BQVpiLFlBQVksR0FBRztBQUNqQixXQUFPLEtBQUtFLGFBQVo7QUFDRDs7QUFFRFksRUFBQUEsWUFBWSxDQUFDQyxRQUFELEVBQVdDLEtBQUssR0FBRyxJQUFuQixFQUF5QjtBQUNuQyxXQUFPLEtBQUtiLFVBQUwsQ0FBZ0JjLElBQWhCLENBQXNCQyxNQUFELElBQVk7QUFDdEMsYUFBT0EsTUFBTSxDQUFDSCxRQUFQLEtBQW9CQSxRQUFwQixLQUFrQ0csTUFBTSxDQUFDRixLQUFQLElBQWdCLElBQWhCLElBQXdCQSxLQUFLLEtBQUssRUFBbkMsSUFBMENFLE1BQU0sQ0FBQ0YsS0FBUCxLQUFpQkEsS0FBNUYsQ0FBUDtBQUNELEtBRk0sQ0FBUDtBQUdEOztBQUVtQixRQUFkRyxjQUFjLEdBQUc7QUFDckIsVUFBTUgsS0FBSyxHQUFHLEtBQUtJLGlCQUFMLElBQTBCLEVBQXhDO0FBQ0EsVUFBTUwsUUFBUSxHQUFHLEtBQUtNLGdCQUF0QjtBQUVBLFVBQU1DLFFBQVEsR0FBRyxN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RCxRQUFJRCxVQUFKLEVBQWdCO0FBQ2QsWUFBTTVELE1BQU0sR0FBRyxNQUFNLElBQUk4RCxPQUFKLENBQWFDLE9BQUQsSUFBYTtBQUM1QyxhQUFLakQsVUFBTCxDQUFnQitDLE1BQWhCLEVBQXdCRCxVQUF4QixFQUFvQyxDQUFDSSxHQUFELEVBQU1oRSxNQUFOLEtBQWlCK0QsT0FBTyxDQUFDL0QsTUFBRCxDQUE1RDtBQUNELE9BRm9CLENBQXJCOztBQUlBLFVBQUlBLE1BQUosRUFBWTtBQUNWMkQsUUFBQUEsTUFBTSxDQUFDUixRQUFELENBQU4sR0FBbUJuRCxNQUFNLENBQUNpRSxLQUExQjtBQUNEO0FBQ0Y7QUFDRjs7QUE1S3VCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb2dyZXNzQmFyIGZyb20gJ3Byb2dyZXNzJztcbmltcG9ydCB7Zm9ybWF0fSBmcm9tICd1dGlsJztcbmltcG9ydCBhcHAgZnJvbSAnLi4vLi4vYXBwJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVGFzayB7XG4gIGNvbnN0cnVjdG9yKHtzeW5jaHJvbml6ZXIsIHN5bmNTdGF0ZX0pIHtcbiAgICB0aGlzLl9zeW5jaHJvbml6ZXIgPSBzeW5jaHJvbml6ZXI7XG4gICAgdGhpcy5fc3luY1N0YXRlID0gc3luY1N0YXRlO1xuXG4gICAgdGhpcy5faXNTaW1wbGVTaGVsbCA9IGFwcC5hcmdzLnNpbXBsZU91dHB1dCB8fCBwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInO1xuICAgIHRoaXMuX25vUHJvZ3Jlc3MgPSBhcHAuYXJncy5wcm9ncmVzcyA9PT0gZmFsc2UgfHwgIXByb2Nlc3Muc3Rkb3V0LmlzVFRZO1xuICB9XG5cbiAgZ2V0IHN5bmNocm9uaXplcigpIHtcbiAgICByZXR1cm4gdGhpcy5fc3luY2hyb25pemVyO1xuICB9XG5cbiAgZ2V0U3luY1N0YXRlKHJlc291cmNlLCBzY29wZSA9IG51bGwpIHtcbiAgICByZXR1cm4gdGhpcy5fc3luY1N0YXRlLmZpbmQoKG9iamVjdCkgPT4ge1xuICAgICAgcmV0dXJuIG9iamVjdC5yZXNvdXJjZSA9PT0gcmVzb3VyY2UgJiYgKChvYmplY3Quc2NvcGUgPT0gbnVsbCAmJiBzY29wZSA9PT0gJycpIHx8IG9iamVjdC5zY29wZSA9PT0gc2NvcGUpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgY2hlY2tTeW5jU3RhdGUoKSB7XG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLnN5bmNSZXNvdXJjZVNjb3BlIHx8ICcnO1xuICAgIGNvbnN0IHJlc291cmNlID0gdGhpcy5zeW5jUmVzb3VyY2VOYW1lO1xuXG4gICAgY29uc3Qgb2xkU3RhdGUgPSBhd2FpdCB0aGlzLmFjY291bnQuZmluZFN5bmNTdGF0ZSh7cmVzb3VyY2UsIHNjb3BlfSk7XG4gICAgY29uc3QgbmV3U3RhdGUgPSB0aGlzLmdldFN5bmNTdGF0ZShyZXNvdXJjZSwgc2NvcGUgfHwgJycpO1xuXG4gICAgbGV0IG5lZWRzVXBkYXRlID0gdHJ1ZTtcblxuICAgIGlmIChvbGRTdGF0ZSAmJiBuZXdTdGF0ZSAmJiBvbGRTdGF0ZS5oYXNoID09PSBuZXdTdGF0ZS5oYXNoKSB7XG4gICAgICBuZWVkc1VwZGF0ZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IHVwZGF0ZSA9IGFzeW5jICgpID0+IHtcbiAgICAgIGlmIChvbGRTdGF0ZSAmJiBuZXdTdGF0ZSkge1xuICAgICAgICBvbGRTdGF0ZS5oYXNoID0gbmV3U3RhdGUuaGFzaDtcbiAgICAgICAgb2xkU3RhdGUuc2NvcGUgPSBvbGRTdGF0ZS5zY29wZSB8fCAnJztcblxuICAgICAgICBhd2FpdCBvbGRTdGF0ZS5zYXZlKCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiB7IG5lZWRzVXBkYXRlLCBzdGF0ZTogb2xkU3RhdGUsIHVwZGF0ZSB9O1xuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZSh7YWNjb3VudCwgZGF0YVNvdXJjZX0pIHtcbiAgICB0aGlzLmFjY291bnQgPSBhY2NvdW50O1xuICAgIHRoaXMuZGIgPSBhY2NvdW50LmRiO1xuXG4gICAgY29uc3Qgc3luY05hbWUgPSB0aGlzLnN5bmNSZXNvdXJjZU5hbWU7XG5cbiAgICBpZiAoc3luY05hbWUpIHtcbiAgICAgIGF3YWl0IHRoaXMudHJpZ2dlcihgJHtzeW5jTmFtZX06c3RhcnRgLCB7dGFzazogdGhpc30pO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMucnVuKHthY2NvdW50LCBkYXRhU291cmNlfSk7XG5cbiAgICBpZiAodGhpcy5iYXIpIHtcbiAgICAgIGNvbnNvbGUubG9nKCcnKTtcbiAgICB9XG5cbiAgICBpZiAoc3luY05hbWUpIHtcbiAgICAgIGF3YWl0IHRoaXMudHJpZ2dlcihgJHtzeW5jTmFtZX06ZmluaXNoYCwge3Rhc2s6IHRoaXN9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgdHJpZ2dlcihuYW1lLCBhcmdzKSB7XG4gICAgcmV0dXJuIGFwcC5lbWl0KG5hbWUsIHthY2NvdW50OiB0aGlzLmFjY291bnQsIC4uLmFyZ3N9KTtcbiAgfVxuXG4gIGdldCBkb3dubG9hZGluZygpIHtcbiAgICByZXR1cm4gdGhpcy5faXNTaW1wbGVTaGVsbCA/ICdbZG93bmxvYWRpbmddJyA6ICfwn5iAICc7XG4gIH1cblxuICBnZXQgcHJvY2Vzc2luZygpIHtcbiAgICByZXR1cm4gdGhpcy5faXNTaW1wbGVTaGVsbCA/ICdbcHJvY2Vzc2luZ10nIDogJ/CfpJQgJztcbiAgfVxuXG4gIGdldCBmaW5pc2hlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5faXNTaW1wbGVTaGVsbCA/ICdbZmluaXNoZWRdJyA6ICfwn5iOICc7XG4gIH1cblxuICBwcm9ncmVzcyh7bWVzc2FnZSwgY291bnQsIHRvdGFsfSkge1xuICAgIGlmICh0aGlzLl9ub1Byb2dyZXNzKSB7XG4gICAgICBpZiAobWVzc2FnZSAhPT0gdGhpcy5fbGFzdE1lc3NhZ2UpIHtcbiAgICAgICAgZnVsY3J1bS5sb2dnZXIubG9nKG1lc3NhZ2UpO1xuICAgICAgICB0aGlzLl9sYXN0TWVzc2FnZSA9IG1lc3NhZ2U7XG4gICAgICB9XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgZm10ID0gJyc7XG5cbiAgICBpZiAodG90YWwgPT09IC0xKSB7XG4gICAgICBmbXQgPSBmb3JtYXQoJyVzICg6Y3VycmVudCkgOmVsYXBzZWQnLCBtZXNzYWdlLmdyZWVuKTtcbiAgICB9IGVsc2UgaWYgKGNvdW50ICE9IG51bGwpIHtcbiAgICAgIGZtdCA9IGZvcm1hdCgnJXMgOmJhciA6cGVyY2VudCAoOmN1cnJlbnQvOnRvdGFsKSA6ZXRhcyA6ZWxhcHNlZCcsIG1lc3NhZ2UuZ3JlZW4pO1xuICAgIH0gZWxzZSB7XG4gICAgICBmbXQgPSBmb3JtYXQoJyVzJywgbWVzc2FnZS5ncmVlbik7XG4gICAgfVxuICAgIC8vIGNvbnN0IGZtdCA9IGNvdW50ICE9IG51bGwgPyBmb3JtYXQoJyVzIDpiYXIgOnBlcmNlbnQgKDpjdXJyZW50Lzp0b3RhbCkgOmV0YXMgOmVsYXBzZWQnLCBtZXNzYWdlLmdyZWVuKVxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBmb3JtYXQoJyVzJywgbWVzc2FnZS5ncmVlbik7XG5cbiAgICBpZiAoIXRoaXMuYmFyKSB7XG4gICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICB3aWR0aDogNDAsXG4gICAgICAgIHRvdGFsOiB0b3RhbCB8fCAxLFxuICAgICAgICBjb21wbGV0ZTogJ+KWhycuZ3JlZW4sXG4gICAgICAgIGluY29tcGxldGU6ICctJyxcbiAgICAgICAgY2xlYXI6IGZhbHNlXG4gICAgICB9O1xuXG4gICAgICB0aGlzLmJhciA9IG5ldyBQcm9ncmVzc0JhcihmbXQsIG9wdGlvbnMpO1xuICAgICAgdGhpcy5iYXIudGljaygwKTtcbiAgICB9XG5cbiAgICB0aGlzLmJhci5mbXQgPSBmbXQ7XG5cbiAgICBpZiAodG90YWwgIT0gbnVsbCkge1xuICAgICAgdGhpcy5iYXIudG90YWwgPSB0b3RhbCB8fCAxO1xuICAgIH1cblxuICAgIGlmICh0aGlzLl9tZXNzYWdlICE9PSBtZXNzYWdlKSB7XG4gICAgICB0aGlzLmJhci5jdXJyID0gMDtcbiAgICAgIHRoaXMuYmFyLnJlbmRlcigpO1xuICAgICAgdGhpcy5fbWVzc2FnZSA9IG1lc3NhZ2U7XG4gICAgfVxuXG4gICAgaWYgKGNvdW50ICE9IG51bGwpIHtcbiAgICAgIHRoaXMuYmFyLmN1cnIgPSBjb3VudDtcbiAgICAgIHRoaXMuYmFyLnJlbmRlcigpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIG1hcmtEZWxldGVkT2JqZWN0cyhsb2NhbE9iamVjdHMsIG5ld09iamVjdHMsIHR5cGVOYW1lLCBwcm9wTmFtZSkge1xuICAgIC8vIGRlbGV0ZSBhbGwgb2JqZWN0cyB0aGF0IGRvbid0IGV4aXN0IG9uIHRoZSBzZXJ2ZXIgYW55bW9yZVxuICAgIGZvciAoY29uc3Qgb2JqZWN0IG9mIGxvY2FsT2JqZWN0cykge1xuICAgICAgbGV0IG9iamVjdEV4aXN0c09uU2VydmVyID0gZmFsc2U7XG5cbiAgICAgIGZvciAoY29uc3QgYXR0cmlidXRlcyBvZiBuZXdPYmplY3RzKSB7XG4gICAgICAgIGlmIChhdHRyaWJ1dGVzLmlkID09PSBvYmplY3QuaWQpIHtcbiAgICAgICAgICBvYmplY3RFeGlzdHNPblNlcnZlciA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKCFvYmplY3RFeGlzdHNPblNlcnZlcikge1xuICAgICAgICBjb25zdCBpc0NoYW5nZWQgPSBvYmplY3QuX2RlbGV0ZWRBdCA9PSBudWxsO1xuXG4gICAgICAgIG9iamVjdC5fZGVsZXRlZEF0ID0gb2JqZWN0Ll9kZWxldGVkQXQgPyBvYmplY3QuX2RlbGV0ZWRBdCA6IG5ldyBEYXRlKCk7XG5cbiAgICAgICAgYXdhaXQgb2JqZWN0LnNhdmUoKTtcblxuICAgICAgICBpZiAoaXNDaGFuZ2VkKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy50cmlnZ2VyKGAkeyB0eXBlTmFtZSB9OmRlbGV0ZWAsIHtbcHJvcE5hbWUgfHwgdHlwZU5hbWVdOiBvYmplY3R9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGxvb2t1cChyZWNvcmQsIHJlc291cmNlSUQsIHByb3BOYW1lLCBnZXR0ZXIpIHtcbiAgICBpZiAocmVzb3VyY2VJRCkge1xuICAgICAgY29uc3Qgb2JqZWN0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgdGhpcy5kYXRhU291cmNlW2dldHRlcl0ocmVzb3VyY2VJRCwgKGVyciwgb2JqZWN0KSA9PiByZXNvbHZlKG9iamVjdCkpO1xuICAgICAgfSk7XG5cbiAgICAgIGlmIChvYmplY3QpIHtcbiAgICAgICAgcmVjb3JkW3Byb3BOYW1lXSA9IG9iamVjdC5yb3dJRDtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _downloadResource = _interopRequireDefault(require("./download-resource"));

var _client = _interopRequireDefault(require("../../api/client"));

var _fs = _interopRequireDefault(require("fs"));

var _tempy = _interopRequireDefault(require("tempy"));

var _jsonseq = require("../../jsonseq");

var _util = require("util");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const QUERY_PAGE_SIZE = 5000;

class DownloadQuerySequence extends _downloadResource.default {
  get useRestAPI() {
    return true;
  }

  async run({
    dataSource
  }) {
    const state = await this.checkSyncState();

    if (!state.needsUpdate) {
      return;
    }

    const lastSync = this.lastSync;
    const sequence = lastSync ? lastSync.getTime() : null;
    this.dataSource = dataSource;
    await this.download(lastSync, sequence, state);
  }

  async download(lastSync, sequence, state) {
    let nextSequence = sequence || 0;

    while (nextSequence != null) {
      if (this.useRestAPI && lastSync != null) {
        nextSequence = await this.downloadRestAPIPage(lastSync, nextSequence, state);
      } else {
        nextSequence = await this.downloadQueryAPIPage(lastSync, nextSequence, state);
      }

      await this.account.save();
    }

    await state.update();
    await this.finish();
  }

  async downloadRestAPIPage(lastSync, sequence, state) {
    const beginFetchTime = new Date();
    this.progress({
      message: this.downloading + ' ' + this.syncLabel.blue
    });
    const results = await this.fetchObjects(lastSync, sequence);
    const totalFetchTime = new Date().getTime() - beginFetchTime.getTime();

    if (results.statusCode !== 200) {
      this.fail(results);
      return null;
    }

    const data = JSON.parse(results.body);
    const objects = data[this.resourceName];
    const db = this.db;
    let now = new Date();
    this.progress({
      message: this.processing + ' ' + this.syncLabel.blue,
      count: 0,
      total: objects.length
    });
    await db.transaction(async database => {
      for (let index = 0; index < objects.length; ++index) {
        const attributes = objects[index];
        const object = await this.findOrCreate(database, attributes);
        await this.process(object, attributes);
        this.progress({
          message: this.processing + ' ' + this.syncLabel.blue,
          count: index + 1,
          total: objects.length
        });
      }
    });
    const totalTime = new Date().getTime() - now.getTime();
    const message = (0, _util.format)(this.finished + ' %s | %s | %s', this.syncLabel.blue, (totalFetchTime + 'ms').cyan, (totalTime + 'ms').red);
    this.progress({
      message,
      count: objects.length,
      total: objects.length
    });
    return data.next_sequence;
  }

  async downloadQueryAPIPage(lastSync, sequence, state) {
    const sql = this.generateQuery(sequence || 0, QUERY_PAGE_SIZE);

    const options = _client.default.getQueryURL(this.account, sql);

    const filePath = _tempy.default.file({
      extension: 'jsonseq'
    });

    this.progress({
      message: this.downloading + ' ' + this.syncLabel.blue
    });
    await this.downloadQuery(options, filePath);
    const {
      count,
      lastObject
    } = await this.processQueryResponse(filePath);
    const message = (0, _util.format)(this.finished + ' %s', this.syncLabel.blue);
    this.progress({
      message,
      count: count,
      total: -1
    });

    if (count >= QUERY_PAGE_SIZE) {
      return Math.ceil(lastObject.updatedAt.getTime() - 1);
    }

    return null;
  }

  async processQueryResponse(filePath) {
    this.progress({
      message: this.processing + ' ' + this.syncLabel.blue,
      count: 0,
      total: -1
    });
    let index = 0;
    let lastObject = null;
    await this.db.transaction(async database => {
      await new Promise((resolve, reject) => {
        const onObject = (json, done) => {
          if (json.row) {
            this.processQueryObject(json, database, (err, object) => {
              if (err) {
                fulcrum.logger.error('Error', err.message, err.stack);
                return done(err);
              }

              lastObject = object;
              this.progress({
                message: this.processing + ' ' + this.syncLabel.blue,
                count: index + 1,
                total: -1
              });
              ++index;
              done();
            });
          } else {
            done();
          }
        };

        const onInvalid = (data, done) => {
          fulcrum.logger.error('Invalid', data && data.toString());
          done(new Error('invalid JSON sequence'));
        };

        const onTruncated = (data, done) => {
          fulcrum.logger.error('Truncated:', data && data.toString());
          done(new Error('truncated JSON sequence'));
        };

        const onEnd = () => {
          resolve();
        };

        const onError = err => {
          reject(err);
        };

        (0, _jsonseq.parseFile)(filePath, {
          onObject,
          onInvalid,
          onTruncated
        }).on('end', onEnd).on('error', onError);
      });
    });
    return {
      count: index,
      lastObject
    };
  }

  processQueryObject(attributes, database, done) {
    this.processObjectAsync(attributes, database).then(o => done(null, o)).catch(done);
  }

  async processObjectAsync(json, database) {
    const attributes = this.attributesForQueryRow(json.row);
    const object = await this.findOrCreate(database, attributes);
    await this.process(object, attributes);
    return object;
  }

  async downloadQuery(options, to) {
    return new Promise((resolve, reject) => {
      const rq = _client.default.rawRequest(options).pipe(_fs.default.createWriteStream(to));

      rq.on('close', () => resolve(rq));
      rq.on('error', reject);
    });
  }

  async finish() {
    await this.account.save();
  }

}

exports.default = DownloadQuerySequence;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zeW5jL3Rhc2tzL2Rvd25sb2FkLXF1ZXJ5LXNlcXVlbmNlLmpzIl0sIm5hbWVzIjpbIlFVRVJZX1BBR0VfU0laRSIsIkRvd25sb2FkUXVlcnlTZXF1ZW5jZSIsIkRvd25sb2FkUmVzb3VyY2UiLCJ1c2VSZXN0QVBJIiwicnVuIiwiZGF0YVNvdXJjZSIsInN0YXRlIiwiY2hlY2tTeW5jU3RhdGUiLCJuZWVkc1VwZGF0ZSIsImxhc3RTeW5jIiwic2VxdWVuY2UiLCJnZXRUaW1lIiwiZG93bmxvYWQiLCJuZXh0U2VxdWVuY2UiLCJkb3dubG9hZFJlc3RBUElQYWdlIiwiZG93bmxvYWRRdWVyeUFQSVBhZ2UiLCJhY2NvdW50Iiwic2F2ZSIsInVwZGF0ZSIsImZpbmlzaCIsImJlZ2luRmV0Y2hUaW1lIiwiRGF0ZSIsInByb2dyZXNzIiwibWVzc2FnZSIsImRvd25sb2FkaW5nIiwic3luY0xhYmVsIiwiYmx1ZSIsInJlc3VsdHMiLCJmZXRjaE9iamVjdHMiLCJ0b3RhbEZldGNoVGltZSIsInN0YXR1c0NvZGUiLCJmYWlsIiwiZGF0YSIsIkpTT04iLCJwYXJzZSIsImJvZHkiLCJvYmplY3RzIiwicmVzb3VyY2VOYW1lIiwiZGIiLCJub3ciLCJwcm9jZXNzaW5nIiwiY291bnQiLCJ0b3RhbCIsImxlbmd0aCIsInRyYW5zYWN0aW9uIiwiZGF0YWJhc2UiLCJpbmRleCIsImF0dHJpYnV0ZXMiLCJvYmplY3QiLCJmaW5kT3JDcmVhdGUiLCJwcm9jZXNzIiwidG90YWxUaW1lIiwiZmluaXNoZWQiLCJjeWFuIiwicmVkIiwibmV4dF9zZXF1ZW5jZSIsInNxbCIsImdlbmVyYXRlUXVlcnkiLCJvcHRpb25zIiwiQ2xpZW50IiwiZ2V0UXVlcnlVUkwiLCJmaWxlUGF0aCIsInRlbXB5IiwiZmlsZSIsImV4dGVuc2lvbiIsImRvd25sb2FkUXVlcnkiLCJsYXN0T2JqZWN0IiwicHJvY2Vzc1F1ZXJ5UmVzcG9uc2UiLCJNYXRoIiwiY2VpbCIsInVwZGF0ZWRBdCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwib25PYmplY3QiLCJqc29uIiwiZG9uZSIsInJvdyIsInByb2Nlc3NRdWVyeU9iamVjdCIsImVyciIsImZ1bGNydW0iLCJsb2dnZXIiLCJlcnJvciIsInN0YWNrIiwib25JbnZhbGlkIiwidG9TdHJpbmciLCJFcnJvciIsIm9uVHJ1bmNhdGVkIiwib25FbmQiLCJvbkVycm9yIiwib24iLCJwcm9jZXNzT2JqZWN0QXN5bmMiLCJ0aGVuIiwibyIsImNhdGNoIiwiYXR0cmlidXRlc0ZvclF1ZXJ5Um93IiwidG8iLCJycSIsInJhd1JlcXVlc3QiLCJwaXBlIiwiZnMiLCJjcmVhdGVXcml0ZVN0cmVhbSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsZUFBZSxHQUFHLElBQXhCOztBQUVlLE1BQU1DLHFCQUFOLFNBQW9DQyx5QkFBcEMsQ0FBcUQ7QUFDcEQsTUFBVkMsVUFBVSxHQUFHO0FBQ2YsV0FBTyxJQUFQO0FBQ0Q7O0FBRVEsUUFBSEMsR0FBRyxDQUFDO0FBQUNDLElBQUFBO0FBQUQsR0FBRCxFQUFlO0FBQ3RCLFVBQU1DLEtBQUssR0FBRyxNQUFNLEtBQUtDLGNBQUwsRUFBcEI7O0FBRUEsUUFBSSxDQUFDRCxLQUFLLENBQUNFLFdBQVgsRUFBd0I7QUFDdEI7QUFDRDs7QUFFRCxVQUFNQyxRQUFRLEdBQUcsS0FBS0EsUUFBdEI7QUFFQSxVQUFNQyxRQUFRLEdBQUdELFFBQVEsR0FBR0EsUUFBUSxDQUFDRSxPQUFULEVBQUgsR0FBd0IsSUFBakQ7QUFFQSxTQUFLTixVQUFMLEdBQWtCQSxVQUFsQjtBQUVBLFVBQU0sS0FBS08sUUFBTCxDQUFjSCxRQUFkLEVBQXdCQyxRQUF4QixFQUFrQ0osS0FBbEMsQ0FBTjtBQUNEOztBQUVhLFFBQVJNLFFBQVEsQ0FBQ0gsUUFBRCxFQUFXQyxRQUFYLEVBQXFCSixLQUFyQixFQUE0QjtBQUN4QyxRQUFJTyxZQUFZLEdBQUdILFFB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eUMsSUFBM0IsQ0FBZ0NDLFlBQUdDLGlCQUFILENBQXFCTCxFQUFyQixDQUFoQyxDQUFYOztBQUNBQyxNQUFBQSxFQUFFLENBQUNQLEVBQUgsQ0FBTSxPQUFOLEVBQWUsTUFBTWxCLE9BQU8sQ0FBQ3lCLEVBQUQsQ0FBNUI7QUFDQUEsTUFBQUEsRUFBRSxDQUFDUCxFQUFILENBQU0sT0FBTixFQUFlakIsTUFBZjtBQUNELEtBSk0sQ0FBUDtBQUtEOztBQUVXLFFBQU50RCxNQUFNLEdBQUc7QUFDYixVQUFNLEtBQUtILE9BQUwsQ0FBYUMsSUFBYixFQUFOO0FBQ0Q7O0FBNUxpRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBEb3dubG9hZFJlc291cmNlIGZyb20gJy4vZG93bmxvYWQtcmVzb3VyY2UnO1xuaW1wb3J0IENsaWVudCBmcm9tICcuLi8uLi9hcGkvY2xpZW50JztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgdGVtcHkgZnJvbSAndGVtcHknO1xuaW1wb3J0IHsgcGFyc2VGaWxlIH0gZnJvbSAnLi4vLi4vanNvbnNlcSc7XG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tICd1dGlsJztcblxuY29uc3QgUVVFUllfUEFHRV9TSVpFID0gNTAwMDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRG93bmxvYWRRdWVyeVNlcXVlbmNlIGV4dGVuZHMgRG93bmxvYWRSZXNvdXJjZSB7XG4gIGdldCB1c2VSZXN0QVBJKCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgcnVuKHtkYXRhU291cmNlfSkge1xuICAgIGNvbnN0IHN0YXRlID0gYXdhaXQgdGhpcy5jaGVja1N5bmNTdGF0ZSgpO1xuXG4gICAgaWYgKCFzdGF0ZS5uZWVkc1VwZGF0ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGxhc3RTeW5jID0gdGhpcy5sYXN0U3luYztcblxuICAgIGNvbnN0IHNlcXVlbmNlID0gbGFzdFN5bmMgPyBsYXN0U3luYy5nZXRUaW1lKCkgOiBudWxsO1xuXG4gICAgdGhpcy5kYXRhU291cmNlID0gZGF0YVNvdXJjZTtcblxuICAgIGF3YWl0IHRoaXMuZG93bmxvYWQobGFzdFN5bmMsIHNlcXVlbmNlLCBzdGF0ZSk7XG4gIH1cblxuICBhc3luYyBkb3dubG9hZChsYXN0U3luYywgc2VxdWVuY2UsIHN0YXRlKSB7XG4gICAgbGV0IG5leHRTZXF1ZW5jZSA9IHNlcXVlbmNlIHx8IDA7XG5cbiAgICB3aGlsZSAobmV4dFNlcXVlbmNlICE9IG51bGwpIHtcbiAgICAgIGlmICh0aGlzLnVzZVJlc3RBUEkgJiYgbGFzdFN5bmMgIT0gbnVsbCkge1xuICAgICAgICBuZXh0U2VxdWVuY2UgPSBhd2FpdCB0aGlzLmRvd25sb2FkUmVzdEFQSVBhZ2UobGFzdFN5bmMsIG5leHRTZXF1ZW5jZSwgc3RhdGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV4dFNlcXVlbmNlID0gYXdhaXQgdGhpcy5kb3dubG9hZFF1ZXJ5QVBJUGFnZShsYXN0U3luYywgbmV4dFNlcXVlbmNlLCBzdGF0ZSk7XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMuYWNjb3VudC5zYXZlKCk7XG4gICAgfVxuXG4gICAgYXdhaXQgc3RhdGUudXBkYXRlKCk7XG4gICAgYXdhaXQgdGhpcy5maW5pc2goKTtcbiAgfVxuXG4gIGFzeW5jIGRvd25sb2FkUmVzdEFQSVBhZ2UobGFzdFN5bmMsIHNlcXVlbmNlLCBzdGF0ZSkge1xuICAgIGNvbnN0IGJlZ2luRmV0Y2hUaW1lID0gbmV3IERhdGUoKTtcblxuICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMuZG93bmxvYWRpbmcgKyAnICcgKyB0aGlzLnN5bmNMYWJlbC5ibHVlfSk7XG5cbiAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgdGhpcy5mZXRjaE9iamVjdHMobGFzdFN5bmMsIHNlcXVlbmNlKTtcblxuICAgIGNvbnN0IHRvdGFsRmV0Y2hUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBiZWdpbkZldGNoVGltZS5nZXRUaW1lKCk7XG5cbiAgICBpZiAocmVzdWx0cy5zdGF0dXNDb2RlICE9PSAyMDApIHtcbiAgICAgIHRoaXMuZmFpbChyZXN1bHRzKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHJlc3VsdHMuYm9keSk7XG5cbiAgICBjb25zdCBvYmplY3RzID0gZGF0YVt0aGlzLnJlc291cmNlTmFtZV07XG5cbiAgICBjb25zdCBkYiA9IHRoaXMuZGI7XG5cbiAgICBsZXQgbm93ID0gbmV3IERhdGUoKTtcblxuICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMucHJvY2Vzc2luZyArICcgJyArIHRoaXMuc3luY0xhYmVsLmJsdWUsIGNvdW50OiAwLCB0b3RhbDogb2JqZWN0cy5sZW5ndGh9KTtcblxuICAgIGF3YWl0IGRiLnRyYW5zYWN0aW9uKGFzeW5jIChkYXRhYmFzZSkgPT4ge1xuICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IG9iamVjdHMubGVuZ3RoOyArK2luZGV4KSB7XG4gICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBvYmplY3RzW2luZGV4XTtcblxuICAgICAgICBjb25zdCBvYmplY3QgPSBhd2FpdCB0aGlzLmZpbmRPckNyZWF0ZShkYXRhYmFzZSwgYXR0cmlidXRlcyk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5wcm9jZXNzKG9iamVjdCwgYXR0cmlidXRlcyk7XG5cbiAgICAgICAgdGhpcy5wcm9ncmVzcyh7bWVzc2FnZTogdGhpcy5wcm9jZXNzaW5nICsgJyAnICsgdGhpcy5zeW5jTGFiZWwuYmx1ZSwgY291bnQ6IGluZGV4ICsgMSwgdG90YWw6IG9iamVjdHMubGVuZ3RofSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCB0b3RhbFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIG5vdy5nZXRUaW1lKCk7XG5cbiAgICBjb25zdCBtZXNzYWdlID0gZm9ybWF0KHRoaXMuZmluaXNoZWQgKyAnICVzIHwgJXMgfCAlcycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN5bmNMYWJlbC5ibHVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRvdGFsRmV0Y2hUaW1lICsgJ21zJykuY3lhbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICh0b3RhbFRpbWUgKyAnbXMnKS5yZWQpO1xuXG4gICAgdGhpcy5wcm9ncmVzcyh7bWVzc2FnZSwgY291bnQ6IG9iamVjdHMubGVuZ3RoLCB0b3RhbDogb2JqZWN0cy5sZW5ndGh9KTtcblxuICAgIHJldHVybiBkYXRhLm5leHRfc2VxdWVuY2U7XG4gIH1cblxuICBhc3luYyBkb3dubG9hZFF1ZXJ5QVBJUGFnZShsYXN0U3luYywgc2VxdWVuY2UsIHN0YXRlKSB7XG4gICAgY29uc3Qgc3FsID0gdGhpcy5nZW5lcmF0ZVF1ZXJ5KHNlcXVlbmNlIHx8IDAsIFFVRVJZX1BBR0VfU0laRSk7XG5cbiAgICBjb25zdCBvcHRpb25zID0gQ2xpZW50LmdldFF1ZXJ5VVJMKHRoaXMuYWNjb3VudCwgc3FsKTtcblxuICAgIGNvbnN0IGZpbGVQYXRoID0gdGVtcHkuZmlsZSh7ZXh0ZW5zaW9uOiAnanNvbnNlcSd9KTtcblxuICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMuZG93bmxvYWRpbmcgKyAnICcgKyB0aGlzLnN5bmNMYWJlbC5ibHVlfSk7XG5cbiAgICBhd2FpdCB0aGlzLmRvd25sb2FkUXVlcnkob3B0aW9ucywgZmlsZVBhdGgpO1xuXG4gICAgY29uc3Qge2NvdW50LCBsYXN0T2JqZWN0fSA9IGF3YWl0IHRoaXMucHJvY2Vzc1F1ZXJ5UmVzcG9uc2UoZmlsZVBhdGgpO1xuXG4gICAgY29uc3QgbWVzc2FnZSA9IGZvcm1hdCh0aGlzLmZpbmlzaGVkICsgJyAlcycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN5bmNMYWJlbC5ibHVlKTtcblxuICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2UsIGNvdW50OiBjb3VudCwgdG90YWw6IC0xfSk7XG5cbiAgICBpZiAoY291bnQgPj0gUVVFUllfUEFHRV9TSVpFKSB7XG4gICAgICByZXR1cm4gTWF0aC5jZWlsKGxhc3RPYmplY3QudXBkYXRlZEF0LmdldFRpbWUoKSAtIDEpO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgYXN5bmMgcHJvY2Vzc1F1ZXJ5UmVzcG9uc2UoZmlsZVBhdGgpIHtcbiAgICB0aGlzLnByb2dyZXNzKHttZXNzYWdlOiB0aGlzLnByb2Nlc3NpbmcgKyAnICcgKyB0aGlzLnN5bmNMYWJlbC5ibHVlLCBjb3VudDogMCwgdG90YWw6IC0xfSk7XG5cbiAgICBsZXQgaW5kZXggPSAwO1xuICAgIGxldCBsYXN0T2JqZWN0ID0gbnVsbDtcblxuICAgIGF3YWl0IHRoaXMuZGIudHJhbnNhY3Rpb24oYXN5bmMgKGRhdGFiYXNlKSA9PiB7XG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IG9uT2JqZWN0ID0gKGpzb24sIGRvbmUpID0+IHtcbiAgICAgICAgICBpZiAoanNvbi5yb3cpIHtcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1F1ZXJ5T2JqZWN0KGpzb24sIGRhdGFiYXNlLCAoZXJyLCBvYmplY3QpID0+IHtcbiAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGZ1bGNydW0ubG9nZ2VyLmVycm9yKCdFcnJvcicsIGVyci5tZXNzYWdlLCBlcnIuc3RhY2spO1xuICAgICAgICAgICAgICAgIHJldHVybiBkb25lKGVycik7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBsYXN0T2JqZWN0ID0gb2JqZWN0O1xuICAgICAgICAgICAgICB0aGlzLnByb2dyZXNzKHttZXNzYWdlOiB0aGlzLnByb2Nlc3NpbmcgKyAnICcgKyB0aGlzLnN5bmNMYWJlbC5ibHVlLCBjb3VudDogaW5kZXggKyAxLCB0b3RhbDogLTF9KTtcbiAgICAgICAgICAgICAgKytpbmRleDtcbiAgICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgb25JbnZhbGlkID0gKGRhdGEsIGRvbmUpID0+IHtcbiAgICAgICAgICBmdWxjcnVtLmxvZ2dlci5lcnJvcignSW52YWxpZCcsIGRhdGEgJiYgZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICBkb25lKG5ldyBFcnJvcignaW52YWxpZCBKU09OIHNlcXVlbmNlJykpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IG9uVHJ1bmNhdGVkID0gKGRhdGEsIGRvbmUpID0+IHtcbiAgICAgICAgICBmdWxjcnVtLmxvZ2dlci5lcnJvcignVHJ1bmNhdGVkOicsIGRhdGEgJiYgZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICBkb25lKG5ldyBFcnJvcigndHJ1bmNhdGVkIEpTT04gc2VxdWVuY2UnKSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgb25FbmQgPSAoKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IG9uRXJyb3IgPSAoZXJyKSA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH07XG5cbiAgICAgICAgcGFyc2VGaWxlKGZpbGVQYXRoLCB7b25PYmplY3QsIG9uSW52YWxpZCwgb25UcnVuY2F0ZWR9KVxuICAgICAgICAgIC5vbignZW5kJywgb25FbmQpXG4gICAgICAgICAgLm9uKCdlcnJvcicsIG9uRXJyb3IpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4ge2NvdW50OiBpbmRleCwgbGFzdE9iamVjdH07XG4gIH1cblxuICBwcm9jZXNzUXVlcnlPYmplY3QoYXR0cmlidXRlcywgZGF0YWJhc2UsIGRvbmUpIHtcbiAgICB0aGlzLnByb2Nlc3NPYmplY3RBc3luYyhhdHRyaWJ1dGVzLCBkYXRhYmFzZSkudGhlbihvID0+IGRvbmUobnVsbCwgbykpLmNhdGNoKGRvbmUpO1xuICB9XG5cbiAgYXN5bmMgcHJvY2Vzc09iamVjdEFzeW5jKGpzb24sIGRhdGFiYXNlKSB7XG4gICAgY29uc3QgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlc0ZvclF1ZXJ5Um93KGpzb24ucm93KTtcblxuICAgIGNvbnN0IG9iamVjdCA9IGF3YWl0IHRoaXMuZmluZE9yQ3JlYXRlKGRhdGFiYXNlLCBhdHRyaWJ1dGVzKTtcblxuICAgIGF3YWl0IHRoaXMucHJvY2VzcyhvYmplY3QsIGF0dHJpYnV0ZXMpO1xuXG4gICAgcmV0dXJuIG9iamVjdDtcbiAgfVxuXG4gIGFzeW5jIGRvd25sb2FkUXVlcnkob3B0aW9ucywgdG8pIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgcnEgPSBDbGllbnQucmF3UmVxdWVzdChvcHRpb25zKS5waXBlKGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHRvKSk7XG4gICAgICBycS5vbignY2xvc2UnLCAoKSA9PiByZXNvbHZlKHJxKSk7XG4gICAgICBycS5vbignZXJyb3InLCByZWplY3QpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZmluaXNoKCkge1xuICAgIGF3YWl0IHRoaXMuYWNjb3VudC5zYXZlKCk7XG4gIH1cbn1cbiJdfQ==
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _downloadQuerySequence = _interopRequireDefault(require("./download-query-sequence"));

var _client = _interopRequireDefault(require("../../api/client"));

var _record = _interopRequireDefault(require("../../models/record"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class DownloadRecords extends _downloadQuerySequence.default {
  constructor({
    form,
    ...args
  }) {
    super(args);
    this.form = form;
  }

  get syncResourceScope() {
    return this.form.id;
  }

  get syncLabel() {
    return this.form.name;
  }

  get resourceName() {
    return 'records';
  }

  get typeName() {
    return 'record';
  }

  get lastSync() {
    return this.form._lastSync;
  }

  async fetchObjects(lastSync, sequence) {
    return lastSync == null ? await _client.default.getRecords(this.account, this.form, sequence, this.pageSize) : await _client.default.getRecordsHistory(this.account, this.form, sequence, this.pageSize);
  }

  findOrCreate(database, attributes) {
    return _record.default.findOrCreate(database, {
      account_id: this.account.rowID,
      resource_id: attributes.id
    });
  }

  async process(object, attributes) {
    if (attributes.history_change_type === 'd') {
      if (object) {
        object._form = this.form;
        object._formRowID = this.form.rowID;
        await object.delete();
        this._hasChanges = true;
        await this.trigger('record:delete', {
          record: object
        });
      }
    } else {
      const isChanged = !object.isPersisted || attributes.version !== object.version;
      object.updateFromAPIAttributes(attributes);
      object._form = this.form;
      object._formRowID = this.form.rowID;
      this.form._lastSync = object.updatedAt;
      await this.lookup(object, attributes.project_id, '_projectRowID', 'getProject');
      await this.lookup(object, attributes.assigned_to_id, '_assignedToRowID', 'getUser');
      await this.lookup(object, attributes.created_by_id, '_createdByRowID', 'getUser');
      await this.lookup(object, attributes.updated_by_id, '_updatedByRowID', 'getUser');
      await this.lookup(object, attributes.changeset_id, '_changesetRowID', 'getChangeset');
      await object.save();

      if (isChanged) {
        this._hasChanges = true;
        this.synchronizer.incrementRecordCount();
        await this.trigger('record:save', {
          record: object
        });
      }
    }
  }

  async finish() {
    // update the lastSync date
    await this.form.save();

    if (this._hasChanges) {
      await this.trigger('records:finish', {
        form: this.form
      });
    }
  }

  attributesForQueryRow(row) {
    const hasCreatedLocation = row[28] != null || row[29] != null || row[30] != null || row[31] != null;
    const hasUpdatedLocation = row[32] != null || row[33] != null || row[34] != null || row[35] != null;
    return {
      status: row[0],
      version: row[1],
      id: row[2],
      created_at: row[3],
      updated_at: row[4],
      client_created_at: row[5],
      client_updated_at: row[6],
      created_by_id: row[7],
      updated_by_id: row[8],
      form_id: row[9],
      project_id: row[10],
      assigned_to_id: row[11],
      form_values: JSON.parse(row[12]),
      latitude: row[13],
      longitude: row[14],
      altitude: row[15],
      speed: row[16],
      course: row[17],
      horizontal_accuracy: row[18],
      vertical_accuracy: row[19],
      edited_duration: row[20],
      updated_duration: row[21],
      created_duration: row[22],
      created_by: row[23],
      updated_by: row[24],
      assigned_to: row[25],
      project: row[26],
      changeset_id: row[27],
      created_location: hasCreatedLocation && {
        latitude: row[28],
        longitude: row[29],
        altitude: row[30],
        horizontal_accuracy: row[31]
      },
      updated_location: hasUpdatedLocation && {
        latitude: row[32],
        longitude: row[33],
        altitude: row[34],
        horizontal_accuracy: row[35]
      }
    };
  }

  generateQuery(sequence, limit) {
    const sequenceString = new Date(+sequence).toISOString();
    return `
SELECT
  "_status" AS "status",
  "_version" AS "version",
  "_record_id" AS "id",
  to_char(pg_catalog.timezone('UTC', "_server_created_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "created_at",
  to_char(pg_catalog.timezone('UTC', "_server_updated_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "updated_at",
  to_char(pg_catalog.timezone('UTC', "_created_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "client_created_at",
  to_char(pg_catalog.timezone('UTC', "_updated_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "client_updated_at",
  "_created_by_id" AS "created_by_id",
  "_updated_by_id" AS "updated_by_id",
  '${this.form.id}'::text AS "form_id",
  "_project_id" AS "project_id",
  "_assigned_to_id" AS "assigned_to_id",
  "_form_values" AS "form_values",
  "_latitude" AS "latitude",
  "_longitude" AS "longitude",
  "_altitude" AS "altitude",
  "_speed" AS "speed",
  "_course" AS "course",
  "_horizontal_accuracy" AS "horizontal_accuracy",
  "_vertical_accuracy" AS "vertical_accuracy",
  "_edited_duration" AS "edited_duration",
  "_updated_duration" AS "updated_duration",
  "_created_duration" AS "created_duration",
  NULL AS "created_by",
  NULL AS "updated_by",
  NULL AS "assigned_to",
  NULL AS "project",
  "_changeset_id" AS "changeset_id",
  "_created_latitude" AS "created_latitude",
  "_created_longitude" AS "created_longitude",
  "_created_altitude" AS "created_altitude",
  "_created_horizontal_accuracy" AS "created_horizontal_accuracy",
  "_updated_latitude" AS "updated_latitude",
  "_updated_longitude" AS "updated_longitude",
  "_updated_altitude" AS "updated_altitude",
  "_updated_horizontal_accuracy" AS "updated_horizontal_accuracy"
FROM "${this.form.id}/_full" AS "records"
WHERE
  _server_updated_at > '${sequenceString}'
ORDER BY
  _server_updated_at ASC
LIMIT ${limit} OFFSET 0
`;
  }

}

exports.default = DownloadRecords;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zeW5jL3Rhc2tzL2Rvd25sb2FkLXJlY29yZHMuanMiXSwibmFtZXMiOlsiRG93bmxvYWRSZWNvcmRzIiwiRG93bmxvYWRRdWVyeVNlcXVlbmNlIiwiY29uc3RydWN0b3IiLCJmb3JtIiwiYXJncyIsInN5bmNSZXNvdXJjZVNjb3BlIiwiaWQiLCJzeW5jTGFiZWwiLCJuYW1lIiwicmVzb3VyY2VOYW1lIiwidHlwZU5hbWUiLCJsYXN0U3luYyIsIl9sYXN0U3luYyIsImZldGNoT2JqZWN0cyIsInNlcXVlbmNlIiwiQ2xpZW50IiwiZ2V0UmVjb3JkcyIsImFjY291bnQiLCJwYWdlU2l6ZSIsImdldFJlY29yZHNIaXN0b3J5IiwiZmluZE9yQ3JlYXRlIiwiZGF0YWJhc2UiLCJhdHRyaWJ1dGVzIiwiUmVjb3JkIiwiYWNjb3VudF9pZCIsInJvd0lEIiwicmVzb3VyY2VfaWQiLCJwcm9jZXNzIiwib2JqZWN0IiwiaGlzdG9yeV9jaGFuZ2VfdHlwZSIsIl9mb3JtIiwiX2Zvcm1Sb3dJRCIsImRlbGV0ZSIsIl9oYXNDaGFuZ2VzIiwidHJpZ2dlciIsInJlY29yZCIsImlzQ2hhbmdlZCIsImlzUGVyc2lzdGVkIiwidmVyc2lvbiIsInVwZGF0ZUZyb21BUElBdHRyaWJ1dGVzIiwidXBkYXRlZEF0IiwibG9va3VwIiwicHJvamVjdF9pZCIsImFzc2lnbmVkX3RvX2lkIiwiY3JlYXRlZF9ieV9pZCIsInVwZGF0ZWRfYnlfaWQiLCJjaGFuZ2VzZXRfaWQiLCJzYXZlIiwic3luY2hyb25pemVyIiwiaW5jcmVtZW50UmVjb3JkQ291bnQiLCJmaW5pc2giLCJhdHRyaWJ1dGVzRm9yUXVlcnlSb3ciLCJyb3ciLCJoYXNDcmVhdGVkTG9jYXRpb24iLCJoYXNVcGRhdGVkTG9jYXRpb24iLCJzdGF0dXMiLCJjcmVhdGVkX2F0IiwidXBkYXRlZF9hdCIsImNsaWVudF9jcmVhdGVkX2F0IiwiY2xpZW50X3VwZGF0ZWRfYXQiLCJmb3JtX2lkIiwiZm9ybV92YWx1ZXMiLCJKU09OIiwicGFyc2UiLCJsYXRpdHVkZSIsImxvbmdpdHVkZSIsImFsdGl0dWRlIiwic3BlZWQiLCJjb3Vyc2UiLCJob3Jpem9udGFsX2FjY3VyYWN5IiwidmVydGljYWxfYWNjdXJhY3kiLCJlZGl0ZWRfZHVyYXRpb24iLCJ1cGRhdGVkX2R1cmF0aW9uIiwiY3JlYXRlZF9kdXJhdGlvbiIsImNyZWF0ZWRfYnkiLCJ1cGRhdGVkX2J5IiwiYXNzaWduZWRfdG8iLCJwcm9qZWN0IiwiY3JlYXRlZF9sb2NhdGlvbiIsInVwZGF0ZWRfbG9jYXRpb24iLCJnZW5lcmF0ZVF1ZXJ5IiwibGltaXQiLCJzZXF1ZW5jZVN0cmluZyIsIkRhdGUiLCJ0b0lTT1N0cmluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOzs7O0FBRWUsTUFBTUEsZUFBTixTQUE4QkMsOEJBQTlCLENBQW9EO0FBQ2pFQyxFQUFBQSxXQUFXLENBQUM7QUFBQ0MsSUFBQUEsSUFBRDtBQUFPLE9BQUdDO0FBQVYsR0FBRCxFQUFrQjtBQUMzQixVQUFNQSxJQUFOO0FBRUEsU0FBS0QsSUFBTCxHQUFZQSxJQUFaO0FBQ0Q7O0FBRW9CLE1BQWpCRSxpQkFBaUIsR0FBRztBQUN0QixXQUFPLEtBQUtGLElBQUwsQ0FBVUcsRUFBakI7QUFDRDs7QUFFWSxNQUFUQyxTQUFTLEdBQUc7QUFDZCxXQUFPLEtBQUtKLElBQUwsQ0FBVUssSUFBakI7QUFDRDs7QUFFZSxNQUFaQyxZQUFZLEdBQUc7QUFDakIsV0FBTyxTQUFQO0FBQ0Q7O0FBRVcsTUFBUkMsUUFBUSxHQUFHO0FBQ2IsV0FBTyxRQUFQO0FBQ0Q7O0FBRVcsTUFBUkMsUUFBUSxHQUFHO0FBQ2IsV0FBTyxLQUFLUixJQUFMLENBQVVTLFNBQWpCO0FBQ0Q7O0FBRWlCLFFBQVpDLFlBQVksQ0FBQ0YsUUFBRCxFQUFXRyxRQUFYLEVBQXFCO0FBQ3JDLFdBQU9ILFFBQVEsSUFBSSxJQUFaLEdBQW9CLE1BQU1JLGdCQUFPQyxVQUFQLENBQWtCLEtBQUtDLE9BQXZCLEVBQWdD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YWQtcXVlcnktc2VxdWVuY2UnO1xuaW1wb3J0IENsaWVudCBmcm9tICcuLi8uLi9hcGkvY2xpZW50JztcbmltcG9ydCBSZWNvcmQgZnJvbSAnLi4vLi4vbW9kZWxzL3JlY29yZCc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERvd25sb2FkUmVjb3JkcyBleHRlbmRzIERvd25sb2FkUXVlcnlTZXF1ZW5jZSB7XG4gIGNvbnN0cnVjdG9yKHtmb3JtLCAuLi5hcmdzfSkge1xuICAgIHN1cGVyKGFyZ3MpO1xuXG4gICAgdGhpcy5mb3JtID0gZm9ybTtcbiAgfVxuXG4gIGdldCBzeW5jUmVzb3VyY2VTY29wZSgpIHtcbiAgICByZXR1cm4gdGhpcy5mb3JtLmlkO1xuICB9XG5cbiAgZ2V0IHN5bmNMYWJlbCgpIHtcbiAgICByZXR1cm4gdGhpcy5mb3JtLm5hbWU7XG4gIH1cblxuICBnZXQgcmVzb3VyY2VOYW1lKCkge1xuICAgIHJldHVybiAncmVjb3Jkcyc7XG4gIH1cblxuICBnZXQgdHlwZU5hbWUoKSB7XG4gICAgcmV0dXJuICdyZWNvcmQnO1xuICB9XG5cbiAgZ2V0IGxhc3RTeW5jKCkge1xuICAgIHJldHVybiB0aGlzLmZvcm0uX2xhc3RTeW5jO1xuICB9XG5cbiAgYXN5bmMgZmV0Y2hPYmplY3RzKGxhc3RTeW5jLCBzZXF1ZW5jZSkge1xuICAgIHJldHVybiBsYXN0U3luYyA9PSBudWxsID8gKGF3YWl0IENsaWVudC5nZXRSZWNvcmRzKHRoaXMuYWNjb3VudCwgdGhpcy5mb3JtLCBzZXF1ZW5jZSwgdGhpcy5wYWdlU2l6ZSkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAoYXdhaXQgQ2xpZW50LmdldFJlY29yZHNIaXN0b3J5KHRoaXMuYWNjb3VudCwgdGhpcy5mb3JtLCBzZXF1ZW5jZSwgdGhpcy5wYWdlU2l6ZSkpO1xuICB9XG5cbiAgZmluZE9yQ3JlYXRlKGRhdGFiYXNlLCBhdHRyaWJ1dGVzKSB7XG4gICAgcmV0dXJuIFJlY29yZC5maW5kT3JDcmVhdGUoZGF0YWJhc2UsIHthY2NvdW50X2lkOiB0aGlzLmFjY291bnQucm93SUQsIHJlc291cmNlX2lkOiBhdHRyaWJ1dGVzLmlkfSk7XG4gIH1cblxuICBhc3luYyBwcm9jZXNzKG9iamVjdCwgYXR0cmlidXRlcykge1xuICAgIGlmIChhdHRyaWJ1dGVzLmhpc3RvcnlfY2hhbmdlX3R5cGUgPT09ICdkJykge1xuICAgICAgaWYgKG9iamVjdCkge1xuICAgICAgICBvYmplY3QuX2Zvcm0gPSB0aGlzLmZvcm07XG4gICAgICAgIG9iamVjdC5fZm9ybVJvd0lEID0gdGhpcy5mb3JtLnJvd0lEO1xuXG4gICAgICAgIGF3YWl0IG9iamVjdC5kZWxldGUoKTtcblxuICAgICAgICB0aGlzLl9oYXNDaGFuZ2VzID0gdHJ1ZTtcblxuICAgICAgICBhd2FpdCB0aGlzLnRyaWdnZXIoJ3JlY29yZDpkZWxldGUnLCB7cmVjb3JkOiBvYmplY3R9KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgaXNDaGFuZ2VkID0gIW9iamVjdC5pc1BlcnNpc3RlZCB8fCBhdHRyaWJ1dGVzLnZlcnNpb24gIT09IG9iamVjdC52ZXJzaW9uO1xuXG4gICAgICBvYmplY3QudXBkYXRlRnJvbUFQSUF0dHJpYnV0ZXMoYXR0cmlidXRlcyk7XG4gICAgICBvYmplY3QuX2Zvcm0gPSB0aGlzLmZvcm07XG4gICAgICBvYmplY3QuX2Zvcm1Sb3dJRCA9IHRoaXMuZm9ybS5yb3dJRDtcblxuICAgICAgdGhpcy5mb3JtLl9sYXN0U3luYyA9IG9iamVjdC51cGRhdGVkQXQ7XG5cbiAgICAgIGF3YWl0IHRoaXMubG9va3VwKG9iamVjdCwgYXR0cmlidXRlcy5wcm9qZWN0X2lkLCAnX3Byb2plY3RSb3dJRCcsICdnZXRQcm9qZWN0Jyk7XG4gICAgICBhd2FpdCB0aGlzLmxvb2t1cChvYmplY3QsIGF0dHJpYnV0ZXMuYXNzaWduZWRfdG9faWQsICdfYXNzaWduZWRUb1Jvd0lEJywgJ2dldFVzZXInKTtcbiAgICAgIGF3YWl0IHRoaXMubG9va3VwKG9iamVjdCwgYXR0cmlidXRlcy5jcmVhdGVkX2J5X2lkLCAnX2NyZWF0ZWRCeVJvd0lEJywgJ2dldFVzZXInKTtcbiAgICAgIGF3YWl0IHRoaXMubG9va3VwKG9iamVjdCwgYXR0cmlidXRlcy51cGRhdGVkX2J5X2lkLCAnX3VwZGF0ZWRCeVJvd0lEJywgJ2dldFVzZXInKTtcbiAgICAgIGF3YWl0IHRoaXMubG9va3VwKG9iamVjdCwgYXR0cmlidXRlcy5jaGFuZ2VzZXRfaWQsICdfY2hhbmdlc2V0Um93SUQnLCAnZ2V0Q2hhbmdlc2V0Jyk7XG5cbiAgICAgIGF3YWl0IG9iamVjdC5zYXZlKCk7XG5cbiAgICAgIGlmIChpc0NoYW5nZWQpIHtcbiAgICAgICAgdGhpcy5faGFzQ2hhbmdlcyA9IHRydWU7XG4gICAgICAgIHRoaXMuc3luY2hyb25pemVyLmluY3JlbWVudFJlY29yZENvdW50KCk7XG4gICAgICAgIGF3YWl0IHRoaXMudHJpZ2dlcigncmVjb3JkOnNhdmUnLCB7cmVjb3JkOiBvYmplY3R9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBmaW5pc2goKSB7XG4gICAgLy8gdXBkYXRlIHRoZSBsYXN0U3luYyBkYXRlXG4gICAgYXdhaXQgdGhpcy5mb3JtLnNhdmUoKTtcblxuICAgIGlmICh0aGlzLl9oYXNDaGFuZ2VzKSB7XG4gICAgICBhd2FpdCB0aGlzLnRyaWdnZXIoJ3JlY29yZHM6ZmluaXNoJywge2Zvcm06IHRoaXMuZm9ybX0pO1xuICAgIH1cbiAgfVxuXG4gIGF0dHJpYnV0ZXNGb3JRdWVyeVJvdyhyb3cpIHtcbiAgICBjb25zdCBoYXNDcmVhdGVkTG9jYXRpb24gPVxuICAgICAgcm93WzI4XSAhPSBudWxsIHx8XG4gICAgICByb3dbMjldICE9IG51bGwgfHxcbiAgICAgIHJvd1szMF0gIT0gbnVsbCB8fFxuICAgICAgcm93WzMxXSAhPSBudWxsO1xuXG4gICAgY29uc3QgaGFzVXBkYXRlZExvY2F0aW9uID1cbiAgICAgIHJvd1szMl0gIT0gbnVsbCB8fFxuICAgICAgcm93WzMzXSAhPSBudWxsIHx8XG4gICAgICByb3dbMzRdICE9IG51bGwgfHxcbiAgICAgIHJvd1szNV0gIT0gbnVsbDtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXM6IHJvd1swXSxcbiAgICAgIHZlcnNpb246IHJvd1sxXSxcbiAgICAgIGlkOiByb3dbMl0sXG4gICAgICBjcmVhdGVkX2F0OiByb3dbM10sXG4gICAgICB1cGRhdGVkX2F0OiByb3dbNF0sXG4gICAgICBjbGllbnRfY3JlYXRlZF9hdDogcm93WzVdLFxuICAgICAgY2xpZW50X3VwZGF0ZWRfYXQ6IHJvd1s2XSxcbiAgICAgIGNyZWF0ZWRfYnlfaWQ6IHJvd1s3XSxcbiAgICAgIHVwZGF0ZWRfYnlfaWQ6IHJvd1s4XSxcbiAgICAgIGZvcm1faWQ6IHJvd1s5XSxcbiAgICAgIHByb2plY3RfaWQ6IHJvd1sxMF0sXG4gICAgICBhc3NpZ25lZF90b19pZDogcm93WzExXSxcbiAgICAgIGZvcm1fdmFsdWVzOiBKU09OLnBhcnNlKHJvd1sxMl0pLFxuICAgICAgbGF0aXR1ZGU6IHJvd1sxM10sXG4gICAgICBsb25naXR1ZGU6IHJvd1sxNF0sXG4gICAgICBhbHRpdHVkZTogcm93WzE1XSxcbiAgICAgIHNwZWVkOiByb3dbMTZdLFxuICAgICAgY291cnNlOiByb3dbMTddLFxuICAgICAgaG9yaXpvbnRhbF9hY2N1cmFjeTogcm93WzE4XSxcbiAgICAgIHZlcnRpY2FsX2FjY3VyYWN5OiByb3dbMTldLFxuICAgICAgZWRpdGVkX2R1cmF0aW9uOiByb3dbMjBdLFxuICAgICAgdXBkYXRlZF9kdXJhdGlvbjogcm93WzIxXSxcbiAgICAgIGNyZWF0ZWRfZHVyYXRpb246IHJvd1syMl0sXG4gICAgICBjcmVhdGVkX2J5OiByb3dbMjNdLFxuICAgICAgdXBkYXRlZF9ieTogcm93WzI0XSxcbiAgICAgIGFzc2lnbmVkX3RvOiByb3dbMjVdLFxuICAgICAgcHJvamVjdDogcm93WzI2XSxcbiAgICAgIGNoYW5nZXNldF9pZDogcm93WzI3XSxcbiAgICAgIGNyZWF0ZWRfbG9jYXRpb246IGhhc0NyZWF0ZWRMb2NhdGlvbiAmJiB7XG4gICAgICAgIGxhdGl0dWRlOiByb3dbMjhdLFxuICAgICAgICBsb25naXR1ZGU6IHJvd1syOV0sXG4gICAgICAgIGFsdGl0dWRlOiByb3dbMzBdLFxuICAgICAgICBob3Jpem9udGFsX2FjY3VyYWN5OiByb3dbMzFdXG4gICAgICB9LFxuICAgICAgdXBkYXRlZF9sb2NhdGlvbjogaGFzVXBkYXRlZExvY2F0aW9uICYmIHtcbiAgICAgICAgbGF0aXR1ZGU6IHJvd1szMl0sXG4gICAgICAgIGxvbmdpdHVkZTogcm93WzMzXSxcbiAgICAgICAgYWx0aXR1ZGU6IHJvd1szNF0sXG4gICAgICAgIGhvcml6b250YWxfYWNjdXJhY3k6IHJvd1szNV1cbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgZ2VuZXJhdGVRdWVyeShzZXF1ZW5jZSwgbGltaXQpIHtcbiAgICBjb25zdCBzZXF1ZW5jZVN0cmluZyA9IG5ldyBEYXRlKCtzZXF1ZW5jZSkudG9JU09TdHJpbmcoKTtcblxuICAgIHJldHVybiBgXG5TRUxFQ1RcbiAgXCJfc3RhdHVzXCIgQVMgXCJzdGF0dXNcIixcbiAgXCJfdmVyc2lvblwiIEFTIFwidmVyc2lvblwiLFxuICBcIl9yZWNvcmRfaWRcIiBBUyBcImlkXCIsXG4gIHRvX2NoYXIocGdfY2F0YWxvZy50aW1lem9uZSgnVVRDJywgXCJfc2VydmVyX2NyZWF0ZWRfYXRcIiksICdZWVlZLU1NLUREXCJUXCJISDI0Ok1JOlNTXCJaXCInKSBBUyBcImNyZWF0ZWRfYXRcIixcbiAgdG9fY2hhcihwZ19jYXRhbG9nLnRpbWV6b25lKCdVVEMnLCBcIl9zZXJ2ZXJfdXBkYXRlZF9hdFwiKSwgJ1lZWVktTU0tRERcIlRcIkhIMjQ6TUk6U1NcIlpcIicpIEFTIFwidXBkYXRlZF9hdFwiLFxuICB0b19jaGFyKHBnX2NhdGFsb2cudGltZXpvbmUoJ1VUQycsIFwiX2NyZWF0ZWRfYXRcIiksICdZWVlZLU1NLUREXCJUXCJISDI0Ok1JOlNTXCJaXCInKSBBUyBcImNsaWVudF9jcmVhdGVkX2F0XCIsXG4gIHRvX2NoYXIocGdfY2F0YWxvZy50aW1lem9uZSgnVVRDJywgXCJfdXBkYXRlZF9hdFwiKSwgJ1lZWVktTU0tRERcIlRcIkhIMjQ6TUk6U1NcIlpcIicpIEFTIFwiY2xpZW50X3VwZGF0ZWRfYXRcIixcbiAgXCJfY3JlYXRlZF9ieV9pZFwiIEFTIFwiY3JlYXRlZF9ieV9pZFwiLFxuICBcIl91cGRhdGVkX2J5X2lkXCIgQVMgXCJ1cGRhdGVkX2J5X2lkXCIsXG4gICckeyB0aGlzLmZvcm0uaWQgfSc6OnRleHQgQVMgXCJmb3JtX2lkXCIsXG4gIFwiX3Byb2plY3RfaWRcIiBBUyBcInByb2plY3RfaWRcIixcbiAgXCJfYXNzaWduZWRfdG9faWRcIiBBUyBcImFzc2lnbmVkX3RvX2lkXCIsXG4gIFwiX2Zvcm1fdmFsdWVzXCIgQVMgXCJmb3JtX3ZhbHVlc1wiLFxuICBcIl9sYXRpdHVkZVwiIEFTIFwibGF0aXR1ZGVcIixcbiAgXCJfbG9uZ2l0dWRlXCIgQVMgXCJsb25naXR1ZGVcIixcbiAgXCJfYWx0aXR1ZGVcIiBBUyBcImFsdGl0dWRlXCIsXG4gIFwiX3NwZWVkXCIgQVMgXCJzcGVlZFwiLFxuICBcIl9jb3Vyc2VcIiBBUyBcImNvdXJzZVwiLFxuICBcIl9ob3Jpem9udGFsX2FjY3VyYWN5XCIgQVMgXCJob3Jpem9udGFsX2FjY3VyYWN5XCIsXG4gIFwiX3ZlcnRpY2FsX2FjY3VyYWN5XCIgQVMgXCJ2ZXJ0aWNhbF9hY2N1cmFjeVwiLFxuICBcIl9lZGl0ZWRfZHVyYXRpb25cIiBBUyBcImVkaXRlZF9kdXJhdGlvblwiLFxuICBcIl91cGRhdGVkX2R1cmF0aW9uXCIgQVMgXCJ1cGRhdGVkX2R1cmF0aW9uXCIsXG4gIFwiX2NyZWF0ZWRfZHVyYXRpb25cIiBBUyBcImNyZWF0ZWRfZHVyYXRpb25cIixcbiAgTlVMTCBBUyBcImNyZWF0ZWRfYnlcIixcbiAgTlVMTCBBUyBcInVwZGF0ZWRfYnlcIixcbiAgTlVMTCBBUyBcImFzc2lnbmVkX3RvXCIsXG4gIE5VTEwgQVMgXCJwcm9qZWN0XCIsXG4gIFwiX2NoYW5nZXNldF9pZFwiIEFTIFwiY2hhbmdlc2V0X2lkXCIsXG4gIFwiX2NyZWF0ZWRfbGF0aXR1ZGVcIiBBUyBcImNyZWF0ZWRfbGF0aXR1ZGVcIixcbiAgXCJfY3JlYXRlZF9sb25naXR1ZGVcIiBBUyBcImNyZWF0ZWRfbG9uZ2l0dWRlXCIsXG4gIFwiX2NyZWF0ZWRfYWx0aXR1ZGVcIiBBUyBcImNyZWF0ZWRfYWx0aXR1ZGVcIixcbiAgXCJfY3JlYXRlZF9ob3Jpem9udGFsX2FjY3VyYWN5XCIgQVMgXCJjcmVhdGVkX2hvcml6b250YWxfYWNjdXJhY3lcIixcbiAgXCJfdXBkYXRlZF9sYXRpdHVkZVwiIEFTIFwidXBkYXRlZF9sYXRpdHVkZVwiLFxuICBcIl91cGRhdGVkX2xvbmdpdHVkZVwiIEFTIFwidXBkYXRlZF9sb25naXR1ZGVcIixcbiAgXCJfdXBkYXRlZF9hbHRpdHVkZVwiIEFTIFwidXBkYXRlZF9hbHRpdHVkZVwiLFxuICBcIl91cGRhdGVkX2hvcml6b250YWxfYWNjdXJhY3lcIiBBUyBcInVwZGF0ZWRfaG9yaXpvbnRhbF9hY2N1cmFjeVwiXG5GUk9NIFwiJHsgdGhpcy5mb3JtLmlkIH0vX2Z1bGxcIiBBUyBcInJlY29yZHNcIlxuV0hFUkVcbiAgX3NlcnZlcl91cGRhdGVkX2F0ID4gJyR7c2VxdWVuY2VTdHJpbmd9J1xuT1JERVIgQllcbiAgX3NlcnZlcl91cGRhdGVkX2F0IEFTQ1xuTElNSVQgJHtsaW1pdH0gT0ZGU0VUIDBcbmA7XG4gIH1cbn1cbiJdfQ==
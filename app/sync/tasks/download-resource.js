"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _task = _interopRequireDefault(require("./task"));

var _fulcrumCore = require("fulcrum-core");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const PAGE_SIZE = 500;

class DownloadResource extends _task.default {
  get syncResourceName() {
    return this.resourceName;
  }

  get pageSize() {
    return PAGE_SIZE;
  }

  get syncResourceScope() {
    return null;
  }

  get resourceName() {
    throw new Error('must implement resourceName');
  }

  get typeName() {
    throw new Error('must implement typeName');
  }

  get propertyName() {
    return this.typeName;
  }

  get syncLabel() {
    return this.resourceName.replace('_', ' ');
  }

  fetchObjects(lastSync, sequence) {
    throw new Error('must implement fetchObjects');
  }

  fetchLocalObjects() {
    throw new Error('must implement fetchLocalObjects');
  }

  findOrCreate(database, attributes) {
    throw new Error('must implement findOrCreate');
  }

  loadObject(object, attributes) {}

  async process(object, attributes) {
    const isChanged = !object.isPersisted || _fulcrumCore.DateUtils.parseISOTimestamp(attributes.updated_at).getTime() !== object.updatedAt.getTime();
    object.updateFromAPIAttributes(attributes);

    if (object._deletedAt != null) {
      object._deletedAt = null;
    }

    await this.loadObject(object, attributes);
    await object.save();

    if (isChanged) {
      await this.triggerEvent('save', {
        [this.propertyName]: object
      });
    }
  }

  triggerEvent(name, args) {
    return this.trigger(`${this.typeName}:${name}`, args);
  }

  fail(account, results) {
    fulcrum.logger.log(account.organizationName.green, 'failed'.red);
  }

  async run({
    dataSource
  }) {
    const sync = await this.checkSyncState();

    if (!sync.needsUpdate) {
      return;
    }

    this.progress({
      message: this.downloading + ' ' + this.syncLabel
    });
    const response = await this.fetchObjects();
    const objects = JSON.parse(response.body)[this.resourceName];
    this.progress({
      message: this.processing + ' ' + this.syncLabel,
      count: 0,
      total: objects.length
    });
    const localObjects = await this.fetchLocalObjects();
    this.markDeletedObjects(localObjects, objects, this.typeName, this.propertyName);

    for (let index = 0; index < objects.length; ++index) {
      const attributes = objects[index];
      const object = await this.findOrCreate(this.account.db, attributes);
      await this.process(object, attributes);
      this.progress({
        message: this.processing + ' ' + this.syncLabel,
        count: index + 1,
        total: objects.length
      });
    }

    await sync.update();
    dataSource.source.invalidate(this.resourceName);
    this.progress({
      message: this.finished + ' ' + this.syncLabel,
      count: objects.length,
      total: objects.length
    });
  }

}

exports.default = DownloadResource;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zeW5jL3Rhc2tzL2Rvd25sb2FkLXJlc291cmNlLmpzIl0sIm5hbWVzIjpbIlBBR0VfU0laRSIsIkRvd25sb2FkUmVzb3VyY2UiLCJUYXNrIiwic3luY1Jlc291cmNlTmFtZSIsInJlc291cmNlTmFtZSIsInBhZ2VTaXplIiwic3luY1Jlc291cmNlU2NvcGUiLCJFcnJvciIsInR5cGVOYW1lIiwicHJvcGVydHlOYW1lIiwic3luY0xhYmVsIiwicmVwbGFjZSIsImZldGNoT2JqZWN0cyIsImxhc3RTeW5jIiwic2VxdWVuY2UiLCJmZXRjaExvY2FsT2JqZWN0cyIsImZpbmRPckNyZWF0ZSIsImRhdGFiYXNlIiwiYXR0cmlidXRlcyIsImxvYWRPYmplY3QiLCJvYmplY3QiLCJwcm9jZXNzIiwiaXNDaGFuZ2VkIiwiaXNQZXJzaXN0ZWQiLCJEYXRlVXRpbHMiLCJwYXJzZUlTT1RpbWVzdGFtcCIsInVwZGF0ZWRfYXQiLCJnZXRUaW1lIiwidXBkYXRlZEF0IiwidXBkYXRlRnJvbUFQSUF0dHJpYnV0ZXMiLCJfZGVsZXRlZEF0Iiwic2F2ZSIsInRyaWdnZXJFdmVudCIsIm5hbWUiLCJhcmdzIiwidHJpZ2dlciIsImZhaWwiLCJhY2NvdW50IiwicmVzdWx0cyIsImZ1bGNydW0iLCJsb2dnZXIiLCJsb2ciLCJvcmdhbml6YXRpb25OYW1lIiwiZ3JlZW4iLCJyZWQiLCJydW4iLCJkYXRhU291cmNlIiwic3luYyIsImNoZWNrU3luY1N0YXRlIiwibmVlZHNVcGRhdGUiLCJwcm9ncmVzcyIsIm1lc3NhZ2UiLCJkb3dubG9hZGluZyIsInJlc3BvbnNlIiwib2JqZWN0cyIsIkpTT04iLCJwYXJzZSIsImJvZHkiLCJwcm9jZXNzaW5nIiwiY291bnQiLCJ0b3RhbCIsImxlbmd0aCIsImxvY2FsT2JqZWN0cyIsIm1hcmtEZWxldGVkT2JqZWN0cyIsImluZGV4IiwiZGIiLCJ1cGRhdGUiLCJzb3VyY2UiLCJpbnZhbGlkYXRlIiwiZmluaXNoZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUVBLE1BQU1BLFNBQVMsR0FBRyxHQUFsQjs7QUFFZSxNQUFNQyxnQkFBTixTQUErQkMsYUFBL0IsQ0FBb0M7QUFDN0IsTUFBaEJDLGdCQUFnQixHQUFHO0FBQ3JCLFdBQU8sS0FBS0MsWUFBWjtBQUNEOztBQUVXLE1BQVJDLFFBQVEsR0FBRztBQUNiLFdBQU9MLFNBQVA7QUFDRDs7QUFFb0IsTUFBakJNLGlCQUFpQixHQUFHO0FBQ3RCLFdBQU8sSUFBUDtBQUNEOztBQUVlLE1BQVpGLFlBQVksR0FBRztBQUNqQixVQUFNLElBQUlHLEtBQUosQ0FBVSw2QkFBVixDQUFOO0FBQ0Q7O0FBRVcsTUFBUkMsUUFBUSxHQUFHO0FBQ2IsVUFBTSxJQUFJRCxLQUFKLENBQVUseUJBQVYsQ0FBTjtBQUNEOztBQUVlLE1BQVpFLFlBQVksR0FBRztBQUNqQixXQUFPLEtBQUtELFFBQVo7QUFDRDs7QUFFWSxNQUFURSxTQUFTLEdBQUc7QUFDZCxXQUFPLEtBQUtOLFlBQUwsQ0FBa0JPLE9BQWxCLENBQTBCLEdBQTFCLEVBQStCLEdBQS9CLENBQVA7QUFDRDs7QUFFREMsRUFBQUEsWUFBWSxDQUFDQyxRQUFELEVBQVdDLFFBQVgsRUFBcUI7QUFDL0IsVUFBTSxJQUFJUCxLQUFKLENBQVUsNkJBQVYsQ0FBTjtBQUNEOztBQUVEUSxFQUFBQSxpQkFBaUIsR0FBRztBQUNsQixVQUFNLElBQUlSLEtBQUosQ0FBVSxrQ0FBVixDQUFOO0FBQ0Q7O0FBRURTLEVBQUFBLFlBQVksQ0FBQ0MsUUFBRCxFQUFXQyxVQUFYLEVBQXVCO0FBQ2pDLFVBQU0sSUFBSVgsS0FBSixDQUFVLDZCQUFWLENBQU47QUFDRDs7QUFFRFksRUFBQUEsVUFBVSxDQUFDQyxNQUFELEVBQVNGLFVBQVQsRUFBcUIsQ0FDOUI7O0FBRVksUUFBUEcsT0FBTyxDQUFDRCxNQUFELEVBQVNGLFVBQVQsRUFBcUI7QUFDaEMsVUFBTUksU0FBUyxHQUFHLENBQUNGLE1BQU0sQ0FBQ0csV0FBUixJQUNBQyx1QkFBVUMsaUJBQVYsQ0FBNEJQLFVBQVUsQ0FBQ1EsVUFBdkMsRUFBbURDLE9BQW5ELE9BQWlFUCxNQUFNLENBQUNRLFNBQVAsQ0FBaUJELE9BQWpCLEVBRG5GO0FBR0FQLElBQUFBLE1BQU0sQ0FBQ1MsdUJBQVAsQ0FBK0JYLFVBQS9COztBQUVBLFFBQUlFLE1BQU0sQ0FBQ1UsVUFBUCxJQUFxQixJQUF6QixFQUErQjtBQUM3QlYsTUFBQUEsTUFBTSxDQUFDVSxVQUFQLEdBQW9CLElBQXBCO0FBQ0Q7O0FBRUQsVUFBTSxLQUFLWCxVQUFMLENBQWdCQyxNQUFoQixFQUF3QkYsVUFBeEIsQ0FBTjtBQUVBLFVBQU1FLE1BQU0sQ0FBQ1csSUFBUCxFQUFOOztBQUVBLFFBQUlULFNBQUosRUFBZTtBQUNiLFlBQU0sS0FBS1UsWUFBTCxDQUFrQixNQUFsQixFQUEwQjtBQUFDLFNBQUMsS0FBS3ZCLFlBQU4sR0FBcUJXO0FBQXRCLE9BQTFCLENBQU47QUFDRDtBQUNGOztBQUVEWSxFQUFBQSxZQUFZLENBQUNDLElBQUQsRUFBT0MsSUFBUCxFQUFhO0FBQ3ZCLFdBQU8sS0FBS0MsT0FBTCxDQUFjLEdBQUcsS0FBSzNCLFFBQVUsSUFBSXlCLElBQU0sRUFBMUMsRUFBNkNDLElBQTdDLENBQVA7QUFDRDs7QUFFREUsRUFBQUEsSUFBSSxDQUFDQyxPQUFELEVBQVVDLE9BQVYsRUFBbUI7QUFDckJDLElBQUFBLE9BQU8sQ0FBQ0MsTUFBUixDQUFlQyxHQUFmLENBQW1CSixPQUFPLENBQUNLLGdCQUFSLENBQXlCQyxLQUE1QyxFQUFtRCxTQUFTQyxHQUE1RDtBQUNEOztBQUVRLFFBQUhDLEdBQUcsQ0FBQztBQUFDQyxJQUFBQTtBQUFELEdBQUQsRUFBZTtBQUN0QixVQUFNQyxJQUFJLEdBQUcsTUFBTSxLQUFLQyxjQUFMLEVBQW5COztBQUVBLFFBQUksQ0FBQ0QsSUFBSSxDQUFDRSxXQUFWLEVBQXVCO0FBQ3JCO0FBQ0Q7O0FBRUQsU0FBS0MsUUFBTCxDQUFjO0FBQUNDLE1BQUFBLE9BQU8sRUFBRSxLQUFLQyxXQUFMLEdBQW1CLEdBQW5CLEdBQXlCLEtBQUsxQztBQUF4QyxLQUFkO0FBRUEsVUFBTTJDLFFBQVEsR0FBRyxNQUFNLEtBQUt6QyxZQUFMLEVBQXZCO0FBRUEsVUFBTTBDLE9BQU8sR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdILFFBQVEsQ0FBQ0ksSUFBcEIsRUFBMEIsS0FBS3JELFlBQS9CLENBQWhCO0FBRUEsU0FBSzhDLFFBQUwsQ0FBYztBQUFDQyxNQUFBQSxPQUFPLEVBQUUsS0FBS08sVUFBTCxHQUFrQixHQUFsQixHQUF3QixLQUFLaEQsU0FBdkM7QUFBa0RpRCxNQUFBQSxLQUFLLEVBQUUsQ0FBekQ7QUFBNERDLE1BQUFBLEtBQUssRUFBRU4sT0FBTyxDQUFDTztBQUEzRSxLQUFkO0FBRUEsVUFBTUMsWUFBWSxHQUFHLE1BQU0sS0FBSy9DLGlCQUFMLEVBQTNCO0FBRUEsU0FBS2dELGtCQUFMLENBQXdCRCxZQUF4QixFQUFzQ1IsT0FBdEMsRUFBK0MsS0FBSzlDLFFBQXBELEVBQThELEtBQUtDLFlBQW5FOztBQUVBLFNBQUssSUFBSXVELEtBQUssR0FBRyxDQUFqQixFQUFvQkEsS0FBSyxHQUFHVixPQUFPLENBQUNPLE1BQXBDLEVBQTRDLEVBQUVHLEtBQTlDLEVBQXFEO0FBQ25ELFlBQU05QyxVQUFVLEdBQUdvQyxPQUFPLENBQUNVLEtBQUQsQ0FBMUI7QUFFQSxZQUFNNUMsTUFBTSxHQUFHLE1BQU0sS0FBS0osWUFBTCxDQUFrQixLQUFLcUIsT0FBTCxDQUFhNEIsRUFBL0IsRUFBbUMvQyxVQUFuQyxDQUFyQjtBQUVBLFlBQU0sS0FBS0csT0FBTCxDQUFhRCxNQUFiLEVBQXFCRixVQUFyQixDQUFOO0FBRUEsV0FBS2dDLFFBQUwsQ0FBYztBQUFDQyxRQUFBQSxPQUFPLEVBQUUsS0FBS08sVUFBTCxHQUFrQixHQUFsQixHQUF3QixLQUFLaEQsU0FBdkM7QUFBa0RpRCxRQUFBQSxLQUFLLEVBQUVLLEtBQUssR0FBRyxDQUFqRTtBQUFvRUosUUFBQUEsS0FBSyxFQUFFTixPQUFPLENBQUNPO0FBQW5GLE9BQWQ7QUFDRDs7QUFFRCxVQUFNZCxJQUFJLENBQUNtQixNQUFMLEVBQU47QUFFQXBCLElBQUFBLFVBQVUsQ0FBQ3FCLE1BQVgsQ0FBa0JDLFVBQWxCLENBQTZCLEtBQUtoRSxZQUFsQztBQUVBLFNBQUs4QyxRQUFMLENBQWM7QUFBQ0MsTUFBQUEsT0FBTyxFQUFFLEtBQUtrQixRQUFMLEdBQWdCLEdBQWhCLEdBQXNCLEtBQUszRCxTQUFyQztBQUFnRGlELE1BQUFBLEtBQUssRUFBRUwsT0FBTyxDQUFDTyxNQUEvRDtBQUF1RUQsTUFBQUEsS0FBSyxFQUFFTixPQUFPLENBQUNPO0FBQXRGLEtBQWQ7QUFDRDs7QUF6R2dEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFRhc2sgZnJvbSAnLi90YXNrJztcbmltcG9ydCB7IERhdGVVdGlscyB9IGZyb20gJ2Z1bGNydW0tY29yZSc7XG5cbmNvbnN0IFBBR0VfU0laRSA9IDUwMDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRG93bmxvYWRSZXNvdXJjZSBleHRlbmRzIFRhc2sge1xuICBnZXQgc3luY1Jlc291cmNlTmFtZSgpIHtcbiAgICByZXR1cm4gdGhpcy5yZXNvdXJjZU5hbWU7XG4gIH1cblxuICBnZXQgcGFnZVNpemUoKSB7XG4gICAgcmV0dXJuIFBBR0VfU0laRTtcbiAgfVxuXG4gIGdldCBzeW5jUmVzb3VyY2VTY29wZSgpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGdldCByZXNvdXJjZU5hbWUoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdtdXN0IGltcGxlbWVudCByZXNvdXJjZU5hbWUnKTtcbiAgfVxuXG4gIGdldCB0eXBlTmFtZSgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ211c3QgaW1wbGVtZW50IHR5cGVOYW1lJyk7XG4gIH1cblxuICBnZXQgcHJvcGVydHlOYW1lKCkge1xuICAgIHJldHVybiB0aGlzLnR5cGVOYW1lO1xuICB9XG5cbiAgZ2V0IHN5bmNMYWJlbCgpIHtcbiAgICByZXR1cm4gdGhpcy5yZXNvdXJjZU5hbWUucmVwbGFjZSgnXycsICcgJyk7XG4gIH1cblxuICBmZXRjaE9iamVjdHMobGFzdFN5bmMsIHNlcXVlbmNlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdtdXN0IGltcGxlbWVudCBmZXRjaE9iamVjdHMnKTtcbiAgfVxuXG4gIGZldGNoTG9jYWxPYmplY3RzKCkge1xuICAgIHRocm93IG5ldyBFcnJvcignbXVzdCBpbXBsZW1lbnQgZmV0Y2hMb2NhbE9iamVjdHMnKTtcbiAgfVxuXG4gIGZpbmRPckNyZWF0ZShkYXRhYmFzZSwgYXR0cmlidXRlcykge1xuICAgIHRocm93IG5ldyBFcnJvcignbXVzdCBpbXBsZW1lbnQgZmluZE9yQ3JlYXRlJyk7XG4gIH1cblxuICBsb2FkT2JqZWN0KG9iamVjdCwgYXR0cmlidXRlcykge1xuICB9XG5cbiAgYXN5bmMgcHJvY2VzcyhvYmplY3QsIGF0dHJpYnV0ZXMpIHtcbiAgICBjb25zdCBpc0NoYW5nZWQgPSAhb2JqZWN0LmlzUGVyc2lzdGVkIHx8XG4gICAgICAgICAgICAgICAgICAgICAgRGF0ZVV0aWxzLnBhcnNlSVNPVGltZXN0YW1wKGF0dHJpYnV0ZXMudXBkYXRlZF9hdCkuZ2V0VGltZSgpICE9PSBvYmplY3QudXBkYXRlZEF0LmdldFRpbWUoKTtcblxuICAgIG9iamVjdC51cGRhdGVGcm9tQVBJQXR0cmlidXRlcyhhdHRyaWJ1dGVzKTtcblxuICAgIGlmIChvYmplY3QuX2RlbGV0ZWRBdCAhPSBudWxsKSB7XG4gICAgICBvYmplY3QuX2RlbGV0ZWRBdCA9IG51bGw7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5sb2FkT2JqZWN0KG9iamVjdCwgYXR0cmlidXRlcyk7XG5cbiAgICBhd2FpdCBvYmplY3Quc2F2ZSgpO1xuXG4gICAgaWYgKGlzQ2hhbmdlZCkge1xuICAgICAgYXdhaXQgdGhpcy50cmlnZ2VyRXZlbnQoJ3NhdmUnLCB7W3RoaXMucHJvcGVydHlOYW1lXTogb2JqZWN0fSk7XG4gICAgfVxuICB9XG5cbiAgdHJpZ2dlckV2ZW50KG5hbWUsIGFyZ3MpIHtcbiAgICByZXR1cm4gdGhpcy50cmlnZ2VyKGAkeyB0aGlzLnR5cGVOYW1lIH06JHsgbmFtZSB9YCwgYXJncyk7XG4gIH1cblxuICBmYWlsKGFjY291bnQsIHJlc3VsdHMpIHtcbiAgICBmdWxjcnVtLmxvZ2dlci5sb2coYWNjb3VudC5vcmdhbml6YXRpb25OYW1lLmdyZWVuLCAnZmFpbGVkJy5yZWQpO1xuICB9XG5cbiAgYXN5bmMgcnVuKHtkYXRhU291cmNlfSkge1xuICAgIGNvbnN0IHN5bmMgPSBhd2FpdCB0aGlzLmNoZWNrU3luY1N0YXRlKCk7XG5cbiAgICBpZiAoIXN5bmMubmVlZHNVcGRhdGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnByb2dyZXNzKHttZXNzYWdlOiB0aGlzLmRvd25sb2FkaW5nICsgJyAnICsgdGhpcy5zeW5jTGFiZWx9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5mZXRjaE9iamVjdHMoKTtcblxuICAgIGNvbnN0IG9iamVjdHMgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmJvZHkpW3RoaXMucmVzb3VyY2VOYW1lXTtcblxuICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMucHJvY2Vzc2luZyArICcgJyArIHRoaXMuc3luY0xhYmVsLCBjb3VudDogMCwgdG90YWw6IG9iamVjdHMubGVuZ3RofSk7XG5cbiAgICBjb25zdCBsb2NhbE9iamVjdHMgPSBhd2FpdCB0aGlzLmZldGNoTG9jYWxPYmplY3RzKCk7XG5cbiAgICB0aGlzLm1hcmtEZWxldGVkT2JqZWN0cyhsb2NhbE9iamVjdHMsIG9iamVjdHMsIHRoaXMudHlwZU5hbWUsIHRoaXMucHJvcGVydHlOYW1lKTtcblxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBvYmplY3RzLmxlbmd0aDsgKytpbmRleCkge1xuICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG9iamVjdHNbaW5kZXhdO1xuXG4gICAgICBjb25zdCBvYmplY3QgPSBhd2FpdCB0aGlzLmZpbmRPckNyZWF0ZSh0aGlzLmFjY291bnQuZGIsIGF0dHJpYnV0ZXMpO1xuXG4gICAgICBhd2FpdCB0aGlzLnByb2Nlc3Mob2JqZWN0LCBhdHRyaWJ1dGVzKTtcblxuICAgICAgdGhpcy5wcm9ncmVzcyh7bWVzc2FnZTogdGhpcy5wcm9jZXNzaW5nICsgJyAnICsgdGhpcy5zeW5jTGFiZWwsIGNvdW50OiBpbmRleCArIDEsIHRvdGFsOiBvYmplY3RzLmxlbmd0aH0pO1xuICAgIH1cblxuICAgIGF3YWl0IHN5bmMudXBkYXRlKCk7XG5cbiAgICBkYXRhU291cmNlLnNvdXJjZS5pbnZhbGlkYXRlKHRoaXMucmVzb3VyY2VOYW1lKTtcblxuICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMuZmluaXNoZWQgKyAnICcgKyB0aGlzLnN5bmNMYWJlbCwgY291bnQ6IG9iamVjdHMubGVuZ3RoLCB0b3RhbDogb2JqZWN0cy5sZW5ndGh9KTtcbiAgfVxufVxuIl19
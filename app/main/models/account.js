"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _minidb = require("minidb");

var _project = _interopRequireDefault(require("./project"));

var _choiceList = _interopRequireDefault(require("./choice-list"));

var _classificationSet = _interopRequireDefault(require("./classification-set"));

var _form = _interopRequireDefault(require("./form"));

var _record = _interopRequireDefault(require("./record"));

var _role = _interopRequireDefault(require("./role"));

var _membership = _interopRequireDefault(require("./membership"));

var _changeset = _interopRequireDefault(require("./changeset"));

var _photo = _interopRequireDefault(require("./photo"));

var _video = _interopRequireDefault(require("./video"));

var _audio = _interopRequireDefault(require("./audio"));

var _signature = _interopRequireDefault(require("./signature"));

var _syncState = _interopRequireDefault(require("./sync-state"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Account {
  static get tableName() {
    return 'accounts';
  }

  static get columns() {
    return [{
      name: 'userResourceID',
      column: 'user_resource_id',
      type: 'string',
      null: false
    }, {
      name: 'organizationResourceID',
      column: 'organization_resource_id',
      type: 'string',
      null: false
    }, {
      name: 'organizationName',
      column: 'organization_name',
      type: 'string',
      null: false
    }, {
      name: 'email',
      column: 'email',
      type: 'string',
      null: false
    }, {
      name: 'description',
      column: 'description',
      type: 'string'
    }, {
      name: 'firstName',
      column: 'first_name',
      type: 'string'
    }, {
      name: 'lastName',
      column: 'last_name',
      type: 'string'
    }, {
      name: 'lastSyncPhotos',
      column: 'last_sync_photos',
      type: 'datetime'
    }, {
      name: 'lastSyncVideos',
      column: 'last_sync_videos',
      type: 'datetime'
    }, {
      name: 'lastSyncAudio',
      column: 'last_sync_audio',
      type: 'datetime'
    }, {
      name: 'lastSyncSignatures',
      column: 'last_sync_signatures',
      type: 'datetime'
    }, {
      name: 'lastSyncChangesets',
      column: 'last_sync_changesets',
      type: 'datetime'
    }, {
      name: 'token',
      column: 'token',
      type: 'string'
    }, {
      name: 'deletedAt',
      column: 'deleted_at',
      type: 'datetime'
    }];
  }

  get userResourceID() {
    return this._userResourceID;
  }

  get organizationResourceID() {
    return this._organizationResourceID;
  }

  get organizationName() {
    return this._organizationName;
  }

  get email() {
    return this._email;
  }

  get firstName() {
    return this._firstName;
  }

  get lastName() {
    return this._lastName;
  }

  get token() {
    return this._token;
  }

  static findByUserAndOrganization(userID, organizationID, callback) {
    return Account.findFirst({
      user_resource_id: userID,
      organization_resource_id: organizationID
    }, callback);
  }

  findForms(where) {
    return _form.default.findAll(this.db, { ...where,
      account_id: this.rowID
    }, 'name ASC');
  }

  findProjects(where) {
    return _project.default.findAll(this.db, { ...where,
      account_id: this.rowID
    }, 'name ASC');
  }

  findChoiceLists(where) {
    return _choiceList.default.findAll(this.db, { ...where,
      account_id: this.rowID
    }, 'name ASC');
  }

  findClassificationSets(where) {
    return _classificationSet.default.findAll(this.db, { ...where,
      account_id: this.rowID
    }, 'name ASC');
  }

  findRoles(where) {
    return _role.default.findAll(this.db, { ...where,
      account_id: this.rowID
    }, 'name ASC');
  }

  findMemberships(where) {
    return _membership.default.findAll(this.db, { ...where,
      account_id: this.rowID
    }, 'email ASC');
  }

  findFirstForm(where) {
    return _form.default.findFirst(this.db, { ...where,
      account_id: this.rowID
    }, 'name ASC');
  }

  findFirstRecord(where) {
    return _record.default.findFirst(this.db, { ...where,
      account_id: this.rowID
    });
  }

  findEachRecord(where, callback) {
    return _record.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachPhoto(where, callback) {
    return _photo.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachVideo(where, callback) {
    return _video.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachAudio(where, callback) {
    return _audio.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachSignature(where, callback) {
    return _signature.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachChangeset(where, callback) {
    return _changeset.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachRole(where, callback) {
    return _role.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachChoiceList(where, callback) {
    return _choiceList.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachClassificationSet(where, callback) {
    return _classificationSet.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachForm(where, callback) {
    return _form.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachProject(where, callback) {
    return _project.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachMembership(where, callback) {
    return _membership.default.findEach(this.db, {
      where: { ...where,
        account_id: this.rowID
      }
    }, callback);
  }

  findEachBySQL(sql, values, callback) {
    return this.db.each(sql, values, callback);
  }

  findBySQL(sql, values, callback) {
    return this.db.all(sql, values, callback);
  }

  findActiveForms(where) {
    return _form.default.findAll(this.db, { ...where,
      account_id: this.rowID,
      deleted_at: null
    }, 'name ASC');
  }

  projectByResourceID(projectId) {
    return _project.default.findFirst(this.db, {
      account_id: this.rowID
    });
  }

  findSyncState(where) {
    return _syncState.default.findOrCreate(this.db, { ...where,
      account_id: this.rowID
    });
  }

  async reset() {
    await this.db.execute(`
      DELETE FROM columns WHERE table_name IN (
        SELECT name FROM tables WHERE name LIKE 'account_${this.rowID}_%'
      );
    `);
    await this.db.execute(`
      DELETE FROM tables WHERE name LIKE 'account_${this.rowID}_%';
    `);
    const viewNames = (await this.db.all(`
      SELECT tbl_name AS name FROM sqlite_master
      WHERE type = 'view' AND tbl_name LIKE 'account_${this.rowID}_%'
      ORDER BY tbl_name;
    `)).map(o => o.name);

    for (const viewName of viewNames) {
      await this.db.execute(`DROP VIEW ${this.db.ident(viewName)};`);
    }

    const tableNames = (await this.db.all(`
      SELECT tbl_name AS name FROM sqlite_master
      WHERE type = 'table' AND tbl_name LIKE 'account_${this.rowID}_%'
      ORDER BY tbl_name;
    `)).map(o => o.name);

    for (const tableName of tableNames) {
      await this.db.execute(`DROP TABLE ${this.db.ident(tableName)};`);
    }

    const accountTables = ['audio', 'changesets', 'choice_lists', 'classification_sets', 'forms', 'memberships', 'photos', 'projects', 'records', 'roles', 'signatures', 'videos'];

    for (const tableName of accountTables) {
      await this.db.execute(`DELETE FROM ${this.db.ident(tableName)} WHERE account_id = ${this.rowID};`);
    }

    await this.db.execute(`DELETE FROM sync_state WHERE account_id = ${this.rowID};`);
    this._lastSyncPhotos = null;
    this._lastSyncVideos = null;
    this._lastSyncAudio = null;
    this._lastSyncSignatures = null;
    this._lastSyncChangesets = null;
    await this.save();
    await this.db.execute('VACUUM');
  }

}

exports.default = Account;

_minidb.PersistentObject.register(Account);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYWluL21vZGVscy9hY2NvdW50LmpzIl0sIm5hbWVzIjpbIkFjY291bnQiLCJ0YWJsZU5hbWUiLCJjb2x1bW5zIiwibmFtZSIsImNvbHVtbiIsInR5cGUiLCJudWxsIiwidXNlclJlc291cmNlSUQiLCJfdXNlclJlc291cmNlSUQiLCJvcmdhbml6YXRpb25SZXNvdXJjZUlEIiwiX29yZ2FuaXphdGlvblJlc291cmNlSUQiLCJvcmdhbml6YXRpb25OYW1lIiwiX29yZ2FuaXphdGlvbk5hbWUiLCJlbWFpbCIsIl9lbWFpbCIsImZpcnN0TmFtZSIsIl9maXJzdE5hbWUiLCJsYXN0TmFtZSIsIl9sYXN0TmFtZSIsInRva2VuIiwiX3Rva2VuIiwiZmluZEJ5VXNlckFuZE9yZ2FuaXphdGlvbiIsInVzZXJJRCIsIm9yZ2FuaXphdGlvbklEIiwiY2FsbGJhY2siLCJmaW5kRmlyc3QiLCJ1c2VyX3Jlc291cmNlX2lkIiwib3JnYW5pemF0aW9uX3Jlc291cmNlX2lkIiwiZmluZEZvcm1zIiwid2hlcmUiLCJGb3JtIiwiZmluZEFsbCIsImRiIiwiYWNjb3VudF9pZCIsInJvd0lEIiwiZmluZFByb2plY3RzIiwiUHJvamVjdCIsImZpbmRDaG9pY2VMaXN0cyIsIkNob2ljZUxpc3QiLCJmaW5kQ2xhc3NpZmljYXRpb25TZXRzIiwiQ2xhc3NpZmljYXRpb25TZXQiLCJmaW5kUm9sZXMiLCJSb2xlIiwiZmluZE1lbWJlcnNoaXBzIiwiTWVtYmVyc2hpcCIsImZpbmRGaXJzdEZvcm0iLCJmaW5kRmlyc3RSZWNvcmQiLCJSZWNvcmQiLCJmaW5kRWFjaFJlY29yZCIsImZpbmRFYWNoIiwiZmluZEVhY2hQaG90byIsIlBob3RvIiwiZmluZEVhY2hWaWRlbyIsIlZpZGVvIiwiZmluZEVhY2hBdWRpbyIsIkF1ZGlvIiwiZmluZEVhY2hTaWduYXR1cmUiLCJTaWduYXR1cmUiLCJmaW5kRWFjaENoYW5nZXNldCIsIkNoYW5nZXNldCIsImZpbmRFYWNoUm9sZSIsImZpbmRFYWNoQ2hvaWNlTGlzdCIsImZpbmRFYWNoQ2xhc3NpZmljYXRpb25TZXQiLCJmaW5kRWFjaEZvcm0iLCJmaW5kRWFjaFByb2plY3QiLCJmaW5kRWFjaE1lbWJlcnNoaXAiLCJmaW5kRWFjaEJ5U1FMIiwic3FsIiwidmFsdWVzIiwiZWFjaCIsImZpbmRCeVNRTCIsImFsbCIsImZpbmRBY3RpdmVGb3JtcyIsImRlbGV0ZWRfYXQiLCJwcm9qZWN0QnlSZXNvdXJjZUlEIiwicHJvamVjdElkIiwiZmluZFN5bmNTdGF0ZSIsIlN5bmNTdGF0ZSIsImZpbmRPckNyZWF0ZSIsInJlc2V0IiwiZXhlY3V0ZSIsInZpZXdOYW1lcyIsIm1hcCIsIm8iLCJ2aWV3TmFtZSIsImlkZW50IiwidGFibGVOYW1lcyIsImFjY291bnRUYWJsZXMiLCJfbGFzdFN5bmNQaG90b3MiLCJfbGFzdFN5bmNWaWRlb3MiLCJfbGFzdFN5bmNBdWRpbyIsIl9sYXN0U3luY1NpZ25hdHVyZXMiLCJfbGFzdFN5bmNDaGFuZ2VzZXRzIiwic2F2ZSIsIlBlcnNpc3RlbnRPYmplY3QiLCJyZWdpc3RlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRWUsTUFBTUEsT0FBTixDQUFjO0FBQ1AsYUFBVEMsU0FBUyxHQUFHO0FBQ3JCLFdBQU8sVUFBUDtBQUNEOztBQUVpQixhQUFQQyxPQUFPLEdBQUc7QUFDbkIsV0FBTyxDQUNMO0FBQUVDLE1BQUFBLElBQUksRUFBRSxnQkFBUjtBQUEwQkMsTUFBQUEsTUFBTSxFQUFFLGtCQUFsQztBQUFzREMsTUFBQUEsSUFBSSxFQUFFLFFBQTVEO0FBQXNFQyxNQUFBQSxJQUFJLEVBQUU7QUFBNUUsS0FESyxFQUVMO0FBQUVILE1BQUFBLElBQUksRUFBRSx3QkFBUjtBQUFrQ0MsTUFBQUEsTUFBTSxFQUFFLDBCQUExQztBQUFzRUMsTUFBQUEsSUFBSSxF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RUFRcEIsVUFSb0IsRUFTcEIsU0FUb0IsRUFVcEIsT0FWb0IsRUFXcEIsWUFYb0IsRUFZcEIsUUFab0IsQ0FBdEI7O0FBZUEsU0FBSyxNQUFNdEYsU0FBWCxJQUF3QnNGLGFBQXhCLEVBQXVDO0FBQ3JDLFlBQU0sS0FBS3ZELEVBQUwsQ0FBUWdELE9BQVIsQ0FBaUIsZUFBYyxLQUFLaEQsRUFBTCxDQUFRcUQsS0FBUixDQUFjcEYsU0FBZCxDQUF5Qix1QkFBc0IsS0FBS2lDLEtBQU0sR0FBekYsQ0FBTjtBQUNEOztBQUVELFVBQU0sS0FBS0YsRUFBTCxDQUFRZ0QsT0FBUixDQUFpQiw2Q0FBNEMsS0FBSzlDLEtBQU0sR0FBeEUsQ0FBTjtBQUVBLFNBQUtzRCxlQUFMLEdBQXVCLElBQXZCO0FBQ0EsU0FBS0MsZUFBTCxHQUF1QixJQUF2QjtBQUNBLFNBQUtDLGNBQUwsR0FBc0IsSUFBdEI7QUFDQSxTQUFLQyxtQkFBTCxHQUEyQixJQUEzQjtBQUNBLFNBQUtDLG1CQUFMLEdBQTJCLElBQTNCO0FBRUEsVUFBTSxLQUFLQyxJQUFMLEVBQU47QUFFQSxVQUFNLEtBQUs3RCxFQUFMLENBQVFnRCxPQUFSLENBQWdCLFFBQWhCLENBQU47QUFDRDs7QUExTjBCOzs7O0FBNk43QmMseUJBQWlCQyxRQUFqQixDQUEwQi9GLE9BQTFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGVyc2lzdGVudE9iamVjdCB9IGZyb20gJ21pbmlkYic7XG5pbXBvcnQgUHJvamVjdCBmcm9tICcuL3Byb2plY3QnO1xuaW1wb3J0IENob2ljZUxpc3QgZnJvbSAnLi9jaG9pY2UtbGlzdCc7XG5pbXBvcnQgQ2xhc3NpZmljYXRpb25TZXQgZnJvbSAnLi9jbGFzc2lmaWNhdGlvbi1zZXQnO1xuaW1wb3J0IEZvcm0gZnJvbSAnLi9mb3JtJztcbmltcG9ydCBSZWNvcmQgZnJvbSAnLi9yZWNvcmQnO1xuaW1wb3J0IFJvbGUgZnJvbSAnLi9yb2xlJztcbmltcG9ydCBNZW1iZXJzaGlwIGZyb20gJy4vbWVtYmVyc2hpcCc7XG5pbXBvcnQgQ2hhbmdlc2V0IGZyb20gJy4vY2hhbmdlc2V0JztcbmltcG9ydCBQaG90byBmcm9tICcuL3Bob3RvJztcbmltcG9ydCBWaWRlbyBmcm9tICcuL3ZpZGVvJztcbmltcG9ydCBBdWRpbyBmcm9tICcuL2F1ZGlvJztcbmltcG9ydCBTaWduYXR1cmUgZnJvbSAnLi9zaWduYXR1cmUnO1xuaW1wb3J0IFN5bmNTdGF0ZSBmcm9tICcuL3N5bmMtc3RhdGUnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBY2NvdW50IHtcbiAgc3RhdGljIGdldCB0YWJsZU5hbWUoKSB7XG4gICAgcmV0dXJuICdhY2NvdW50cyc7XG4gIH1cblxuICBzdGF0aWMgZ2V0IGNvbHVtbnMoKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIHsgbmFtZTogJ3VzZXJSZXNvdXJjZUlEJywgY29sdW1uOiAndXNlcl9yZXNvdXJjZV9pZCcsIHR5cGU6ICdzdHJpbmcnLCBudWxsOiBmYWxzZSB9LFxuICAgICAgeyBuYW1lOiAnb3JnYW5pemF0aW9uUmVzb3VyY2VJRCcsIGNvbHVtbjogJ29yZ2FuaXphdGlvbl9yZXNvdXJjZV9pZCcsIHR5cGU6ICdzdHJpbmcnLCBudWxsOiBmYWxzZSB9LFxuICAgICAgeyBuYW1lOiAnb3JnYW5pemF0aW9uTmFtZScsIGNvbHVtbjogJ29yZ2FuaXphdGlvbl9uYW1lJywgdHlwZTogJ3N0cmluZycsIG51bGw6IGZhbHNlIH0sXG4gICAgICB7IG5hbWU6ICdlbWFpbCcsIGNvbHVtbjogJ2VtYWlsJywgdHlwZTogJ3N0cmluZycsIG51bGw6IGZhbHNlIH0sXG4gICAgICB7IG5hbWU6ICdkZXNjcmlwdGlvbicsIGNvbHVtbjogJ2Rlc2NyaXB0aW9uJywgdHlwZTogJ3N0cmluZycgfSxcbiAgICAgIHsgbmFtZTogJ2ZpcnN0TmFtZScsIGNvbHVtbjogJ2ZpcnN0X25hbWUnLCB0eXBlOiAnc3RyaW5nJyB9LFxuICAgICAgeyBuYW1lOiAnbGFzdE5hbWUnLCBjb2x1bW46ICdsYXN0X25hbWUnLCB0eXBlOiAnc3RyaW5nJyB9LFxuICAgICAgeyBuYW1lOiAnbGFzdFN5bmNQaG90b3MnLCBjb2x1bW46ICdsYXN0X3N5bmNfcGhvdG9zJywgdHlwZTogJ2RhdGV0aW1lJyB9LFxuICAgICAgeyBuYW1lOiAnbGFzdFN5bmNWaWRlb3MnLCBjb2x1bW46ICdsYXN0X3N5bmNfdmlkZW9zJywgdHlwZTogJ2RhdGV0aW1lJyB9LFxuICAgICAgeyBuYW1lOiAnbGFzdFN5bmNBdWRpbycsIGNvbHVtbjogJ2xhc3Rfc3luY19hdWRpbycsIHR5cGU6ICdkYXRldGltZScgfSxcbiAgICAgIHsgbmFtZTogJ2xhc3RTeW5jU2lnbmF0dXJlcycsIGNvbHVtbjogJ2xhc3Rfc3luY19zaWduYXR1cmVzJywgdHlwZTogJ2RhdGV0aW1lJyB9LFxuICAgICAgeyBuYW1lOiAnbGFzdFN5bmNDaGFuZ2VzZXRzJywgY29sdW1uOiAnbGFzdF9zeW5jX2NoYW5nZXNldHMnLCB0eXBlOiAnZGF0ZXRpbWUnIH0sXG4gICAgICB7IG5hbWU6ICd0b2tlbicsIGNvbHVtbjogJ3Rva2VuJywgdHlwZTogJ3N0cmluZycgfSxcbiAgICAgIHsgbmFtZTogJ2RlbGV0ZWRBdCcsIGNvbHVtbjogJ2RlbGV0ZWRfYXQnLCB0eXBlOiAnZGF0ZXRpbWUnIH1cbiAgICBdO1xuICB9XG5cbiAgZ2V0IHVzZXJSZXNvdXJjZUlEKCkge1xuICAgIHJldHVybiB0aGlzLl91c2VyUmVzb3VyY2VJRDtcbiAgfVxuXG4gIGdldCBvcmdhbml6YXRpb25SZXNvdXJjZUlEKCkge1xuICAgIHJldHVybiB0aGlzLl9vcmdhbml6YXRpb25SZXNvdXJjZUlEO1xuICB9XG5cbiAgZ2V0IG9yZ2FuaXphdGlvbk5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX29yZ2FuaXphdGlvbk5hbWU7XG4gIH1cblxuICBnZXQgZW1haWwoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2VtYWlsO1xuICB9XG5cbiAgZ2V0IGZpcnN0TmFtZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fZmlyc3ROYW1lO1xuICB9XG5cbiAgZ2V0IGxhc3ROYW1lKCkge1xuICAgIHJldHVybiB0aGlzLl9sYXN0TmFtZTtcbiAgfVxuXG4gIGdldCB0b2tlbigpIHtcbiAgICByZXR1cm4gdGhpcy5fdG9rZW47XG4gIH1cblxuICBzdGF0aWMgZmluZEJ5VXNlckFuZE9yZ2FuaXphdGlvbih1c2VySUQsIG9yZ2FuaXphdGlvbklELCBjYWxsYmFjaykge1xuICAgIHJldHVybiBBY2NvdW50LmZpbmRGaXJzdCh7dXNlcl9yZXNvdXJjZV9pZDogdXNlcklELFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JnYW5pemF0aW9uX3Jlc291cmNlX2lkOiBvcmdhbml6YXRpb25JRH0sIGNhbGxiYWNrKTtcbiAgfVxuXG4gIGZpbmRGb3Jtcyh3aGVyZSkge1xuICAgIHJldHVybiBGb3JtLmZpbmRBbGwodGhpcy5kYiwgey4uLndoZXJlLCBhY2NvdW50X2lkOiB0aGlzLnJvd0lEfSwgJ25hbWUgQVNDJyk7XG4gIH1cblxuICBmaW5kUHJvamVjdHMod2hlcmUpIHtcbiAgICByZXR1cm4gUHJvamVjdC5maW5kQWxsKHRoaXMuZGIsIHsuLi53aGVyZSwgYWNjb3VudF9pZDogdGhpcy5yb3dJRH0sICduYW1lIEFTQycpO1xuICB9XG5cbiAgZmluZENob2ljZUxpc3RzKHdoZXJlKSB7XG4gICAgcmV0dXJuIENob2ljZUxpc3QuZmluZEFsbCh0aGlzLmRiLCB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9LCAnbmFtZSBBU0MnKTtcbiAgfVxuXG4gIGZpbmRDbGFzc2lmaWNhdGlvblNldHMod2hlcmUpIHtcbiAgICByZXR1cm4gQ2xhc3NpZmljYXRpb25TZXQuZmluZEFsbCh0aGlzLmRiLCB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9LCAnbmFtZSBBU0MnKTtcbiAgfVxuXG4gIGZpbmRSb2xlcyh3aGVyZSkge1xuICAgIHJldHVybiBSb2xlLmZpbmRBbGwodGhpcy5kYiwgey4uLndoZXJlLCBhY2NvdW50X2lkOiB0aGlzLnJvd0lEfSwgJ25hbWUgQVNDJyk7XG4gIH1cblxuICBmaW5kTWVtYmVyc2hpcHMod2hlcmUpIHtcbiAgICByZXR1cm4gTWVtYmVyc2hpcC5maW5kQWxsKHRoaXMuZGIsIHsuLi53aGVyZSwgYWNjb3VudF9pZDogdGhpcy5yb3dJRH0sICdlbWFpbCBBU0MnKTtcbiAgfVxuXG4gIGZpbmRGaXJzdEZvcm0od2hlcmUpIHtcbiAgICByZXR1cm4gRm9ybS5maW5kRmlyc3QodGhpcy5kYiwgey4uLndoZXJlLCBhY2NvdW50X2lkOiB0aGlzLnJvd0lEfSwgJ25hbWUgQVNDJyk7XG4gIH1cblxuICBmaW5kRmlyc3RSZWNvcmQod2hlcmUpIHtcbiAgICByZXR1cm4gUmVjb3JkLmZpbmRGaXJzdCh0aGlzLmRiLCB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9KTtcbiAgfVxuXG4gIGZpbmRFYWNoUmVjb3JkKHdoZXJlLCBjYWxsYmFjaykge1xuICAgIHJldHVybiBSZWNvcmQuZmluZEVhY2godGhpcy5kYiwge3doZXJlOiB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9fSwgY2FsbGJhY2spO1xuICB9XG5cbiAgZmluZEVhY2hQaG90byh3aGVyZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gUGhvdG8uZmluZEVhY2godGhpcy5kYiwge3doZXJlOiB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9fSwgY2FsbGJhY2spO1xuICB9XG5cbiAgZmluZEVhY2hWaWRlbyh3aGVyZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gVmlkZW8uZmluZEVhY2godGhpcy5kYiwge3doZXJlOiB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9fSwgY2FsbGJhY2spO1xuICB9XG5cbiAgZmluZEVhY2hBdWRpbyh3aGVyZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gQXVkaW8uZmluZEVhY2godGhpcy5kYiwge3doZXJlOiB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9fSwgY2FsbGJhY2spO1xuICB9XG5cbiAgZmluZEVhY2hTaWduYXR1cmUod2hlcmUsIGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIFNpZ25hdHVyZS5maW5kRWFjaCh0aGlzLmRiLCB7d2hlcmU6IHsuLi53aGVyZSwgYWNjb3VudF9pZDogdGhpcy5yb3dJRH19LCBjYWxsYmFjayk7XG4gIH1cblxuICBmaW5kRWFjaENoYW5nZXNldCh3aGVyZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gQ2hhbmdlc2V0LmZpbmRFYWNoKHRoaXMuZGIsIHt3aGVyZTogey4uLndoZXJlLCBhY2NvdW50X2lkOiB0aGlzLnJvd0lEfX0sIGNhbGxiYWNrKTtcbiAgfVxuXG4gIGZpbmRFYWNoUm9sZSh3aGVyZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gUm9sZS5maW5kRWFjaCh0aGlzLmRiLCB7d2hlcmU6IHsuLi53aGVyZSwgYWNjb3VudF9pZDogdGhpcy5yb3dJRH19LCBjYWxsYmFjayk7XG4gIH1cblxuICBmaW5kRWFjaENob2ljZUxpc3Qod2hlcmUsIGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIENob2ljZUxpc3QuZmluZEVhY2godGhpcy5kYiwge3doZXJlOiB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9fSwgY2FsbGJhY2spO1xuICB9XG5cbiAgZmluZEVhY2hDbGFzc2lmaWNhdGlvblNldCh3aGVyZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gQ2xhc3NpZmljYXRpb25TZXQuZmluZEVhY2godGhpcy5kYiwge3doZXJlOiB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9fSwgY2FsbGJhY2spO1xuICB9XG5cbiAgZmluZEVhY2hGb3JtKHdoZXJlLCBjYWxsYmFjaykge1xuICAgIHJldHVybiBGb3JtLmZpbmRFYWNoKHRoaXMuZGIsIHt3aGVyZTogey4uLndoZXJlLCBhY2NvdW50X2lkOiB0aGlzLnJvd0lEfX0sIGNhbGxiYWNrKTtcbiAgfVxuXG4gIGZpbmRFYWNoUHJvamVjdCh3aGVyZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gUHJvamVjdC5maW5kRWFjaCh0aGlzLmRiLCB7d2hlcmU6IHsuLi53aGVyZSwgYWNjb3VudF9pZDogdGhpcy5yb3dJRH19LCBjYWxsYmFjayk7XG4gIH1cblxuICBmaW5kRWFjaE1lbWJlcnNoaXAod2hlcmUsIGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIE1lbWJlcnNoaXAuZmluZEVhY2godGhpcy5kYiwge3doZXJlOiB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9fSwgY2FsbGJhY2spO1xuICB9XG5cbiAgZmluZEVhY2hCeVNRTChzcWwsIHZhbHVlcywgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5kYi5lYWNoKHNxbCwgdmFsdWVzLCBjYWxsYmFjayk7XG4gIH1cblxuICBmaW5kQnlTUUwoc3FsLCB2YWx1ZXMsIGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZGIuYWxsKHNxbCwgdmFsdWVzLCBjYWxsYmFjayk7XG4gIH1cblxuICBmaW5kQWN0aXZlRm9ybXMod2hlcmUpIHtcbiAgICByZXR1cm4gRm9ybS5maW5kQWxsKHRoaXMuZGIsIHsuLi53aGVyZSwgYWNjb3VudF9pZDogdGhpcy5yb3dJRCwgZGVsZXRlZF9hdDogbnVsbH0sICduYW1lIEFTQycpO1xuICB9XG5cbiAgcHJvamVjdEJ5UmVzb3VyY2VJRChwcm9qZWN0SWQpIHtcbiAgICByZXR1cm4gUHJvamVjdC5maW5kRmlyc3QodGhpcy5kYiwge2FjY291bnRfaWQ6IHRoaXMucm93SUR9KTtcbiAgfVxuXG4gIGZpbmRTeW5jU3RhdGUod2hlcmUpIHtcbiAgICByZXR1cm4gU3luY1N0YXRlLmZpbmRPckNyZWF0ZSh0aGlzLmRiLCB7Li4ud2hlcmUsIGFjY291bnRfaWQ6IHRoaXMucm93SUR9KTtcbiAgfVxuXG4gIGFzeW5jIHJlc2V0KCkge1xuICAgIGF3YWl0IHRoaXMuZGIuZXhlY3V0ZShgXG4gICAgICBERUxFVEUgRlJPTSBjb2x1bW5zIFdIRVJFIHRhYmxlX25hbWUgSU4gKFxuICAgICAgICBTRUxFQ1QgbmFtZSBGUk9NIHRhYmxlcyBXSEVSRSBuYW1lIExJS0UgJ2FjY291bnRfJHt0aGlzLnJvd0lEfV8lJ1xuICAgICAgKTtcbiAgICBgKTtcblxuICAgIGF3YWl0IHRoaXMuZGIuZXhlY3V0ZShgXG4gICAgICBERUxFVEUgRlJPTSB0YWJsZXMgV0hFUkUgbmFtZSBMSUtFICdhY2NvdW50XyR7dGhpcy5yb3dJRH1fJSc7XG4gICAgYCk7XG5cbiAgICBjb25zdCB2aWV3TmFtZXMgPSAoYXdhaXQgdGhpcy5kYi5hbGwoYFxuICAgICAgU0VMRUNUIHRibF9uYW1lIEFTIG5hbWUgRlJPTSBzcWxpdGVfbWFzdGVyXG4gICAgICBXSEVSRSB0eXBlID0gJ3ZpZXcnIEFORCB0YmxfbmFtZSBMSUtFICdhY2NvdW50XyR7dGhpcy5yb3dJRH1fJSdcbiAgICAgIE9SREVSIEJZIHRibF9uYW1lO1xuICAgIGApKS5tYXAobyA9PiBvLm5hbWUpO1xuXG4gICAgZm9yIChjb25zdCB2aWV3TmFtZSBvZiB2aWV3TmFtZXMpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGIuZXhlY3V0ZShgRFJPUCBWSUVXICR7dGhpcy5kYi5pZGVudCh2aWV3TmFtZSl9O2ApO1xuICAgIH1cblxuICAgIGNvbnN0IHRhYmxlTmFtZXMgPSAoYXdhaXQgdGhpcy5kYi5hbGwoYFxuICAgICAgU0VMRUNUIHRibF9uYW1lIEFTIG5hbWUgRlJPTSBzcWxpdGVfbWFzdGVyXG4gICAgICBXSEVSRSB0eXBlID0gJ3RhYmxlJyBBTkQgdGJsX25hbWUgTElLRSAnYWNjb3VudF8ke3RoaXMucm93SUR9XyUnXG4gICAgICBPUkRFUiBCWSB0YmxfbmFtZTtcbiAgICBgKSkubWFwKG8gPT4gby5uYW1lKTtcblxuICAgIGZvciAoY29uc3QgdGFibGVOYW1lIG9mIHRhYmxlTmFtZXMpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGIuZXhlY3V0ZShgRFJPUCBUQUJMRSAke3RoaXMuZGIuaWRlbnQodGFibGVOYW1lKX07YCk7XG4gICAgfVxuXG4gICAgY29uc3QgYWNjb3VudFRhYmxlcyA9IFtcbiAgICAgICdhdWRpbycsXG4gICAgICAnY2hhbmdlc2V0cycsXG4gICAgICAnY2hvaWNlX2xpc3RzJyxcbiAgICAgICdjbGFzc2lmaWNhdGlvbl9zZXRzJyxcbiAgICAgICdmb3JtcycsXG4gICAgICAnbWVtYmVyc2hpcHMnLFxuICAgICAgJ3Bob3RvcycsXG4gICAgICAncHJvamVjdHMnLFxuICAgICAgJ3JlY29yZHMnLFxuICAgICAgJ3JvbGVzJyxcbiAgICAgICdzaWduYXR1cmVzJyxcbiAgICAgICd2aWRlb3MnXG4gICAgXTtcblxuICAgIGZvciAoY29uc3QgdGFibGVOYW1lIG9mIGFjY291bnRUYWJsZXMpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGIuZXhlY3V0ZShgREVMRVRFIEZST00gJHt0aGlzLmRiLmlkZW50KHRhYmxlTmFtZSl9IFdIRVJFIGFjY291bnRfaWQgPSAke3RoaXMucm93SUR9O2ApO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuZGIuZXhlY3V0ZShgREVMRVRFIEZST00gc3luY19zdGF0ZSBXSEVSRSBhY2NvdW50X2lkID0gJHt0aGlzLnJvd0lEfTtgKTtcblxuICAgIHRoaXMuX2xhc3RTeW5jUGhvdG9zID0gbnVsbDtcbiAgICB0aGlzLl9sYXN0U3luY1ZpZGVvcyA9IG51bGw7XG4gICAgdGhpcy5fbGFzdFN5bmNBdWRpbyA9IG51bGw7XG4gICAgdGhpcy5fbGFzdFN5bmNTaWduYXR1cmVzID0gbnVsbDtcbiAgICB0aGlzLl9sYXN0U3luY0NoYW5nZXNldHMgPSBudWxsO1xuXG4gICAgYXdhaXQgdGhpcy5zYXZlKCk7XG5cbiAgICBhd2FpdCB0aGlzLmRiLmV4ZWN1dGUoJ1ZBQ1VVTScpO1xuICB9XG59XG5cblBlcnNpc3RlbnRPYmplY3QucmVnaXN0ZXIoQWNjb3VudCk7XG4iXX0=
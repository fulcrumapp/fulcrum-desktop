"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _uuid = _interopRequireDefault(require("uuid"));

var _lodash = _interopRequireDefault(require("lodash"));

var _fs = _interopRequireDefault(require("fs"));

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _child_process = require("child_process");

var _async = _interopRequireDefault(require("async"));

var _rimraf = _interopRequireDefault(require("rimraf"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_MARGIN = '0.75in';
const DEFAULT_PAGE_SIZE = 'Letter';
const DEFAULT_IMAGE_QUALITY = '85';
const DEFAULT_ORIENTATION = 'Portrait';

class HtmlToPdf {
  constructor(html, {
    header,
    footer,
    cover,
    marginTop,
    marginBottom,
    marginLeft,
    marginRight,
    pageSize,
    imageQuality,
    orientation,
    wkhtmltopdf
  }) {
    this.tempID = _uuid.default.v4();
    this.debug = false;
    this.html = html;
    this.header = header;
    this.footer = footer;
    this.cover = cover;
    this.wkhtmltopdf = wkhtmltopdf;
    this.marginTop = marginTop || DEFAULT_MARGIN;
    this.marginBottom = marginBottom || DEFAULT_MARGIN;
    this.marginLeft = marginLeft || DEFAULT_MARGIN;
    this.marginRight = marginRight || DEFAULT_MARGIN;
    this.pageSize = pageSize || DEFAULT_PAGE_SIZE;
    this.imageQuality = imageQuality || DEFAULT_IMAGE_QUALITY;
    this.orientation = orientation || DEFAULT_ORIENTATION;
  }

  get binary() {
    return this.wkhtmltopdf || '/usr/local/bin/wkhtmltopdf';
  }

  get command() {
    const parts = ['--page-size', this.pageSize, '--margin-top', this.marginTop, '--margin-left', this.marginLeft, '--margin-bottom', this.marginBottom, '--margin-right', this.marginRight, '--image-quality', this.imageQuality, '--orientation', this.orientation, '--encoding', 'UTF-8', this.quietArgument, ...this.coverArgument, ...this.headerArgument, ...this.footerArgument, this.inputArgument, this.outputArgument];
    return _lodash.default.compact(parts);
  }

  tempFilePath(part, ext = 'html') {
    return _path.default.join(_os.default.tmpdir(), `${this.tempID}_${part}.${ext}`);
  }

  get quietArgument() {
    return '--quiet'; // return this.debug ? null : '--quiet';
  }

  get inputArgument() {
    return '-';
  }

  get outputArgument() {
    return this.tempFilePath(this.tempID + '_output', 'pdf');
  }

  get coverArgument() {
    if (this.cover) {
      const coverPath = this.tempFilePath('cover');

      _fs.default.writeFileSync(coverPath, this.cover);

      return ['cover', coverPath];
    }

    return [];
  }

  get headerArgument() {
    if (this.header) {
      const headerPath = this.tempFilePath('header');

      _fs.default.writeFileSync(headerPath, this.header);

      return ['--header-html', headerPath];
    }

    return [];
  }

  get footerArgument() {
    if (this.footer) {
      const footerPath = this.tempFilePath('footer');

      _fs.default.writeFileSync(footerPath, this.footer);

      return ['--footer-html', footerPath];
    }

    return [];
  }

  run() {
    return new Promise((resolve, reject) => {
      const cmd = this.command;
      const process = (0, _child_process.spawn)(this.binary, cmd, {});
      const stdout = [];
      const stderr = [];
      process.stdin.setEncoding('utf8');
      process.stdin.end(this.html);
      process.stdout.on('data', data => {
        stdout.push(data.toString());
      });
      process.stderr.on('data', data => {
        stderr.push(data.toString());
      });
      process.on('close', code => {
        _fs.default.stat(this.outputArgument, (err, stat) => {
          if (err) {
            return reject(err);
          }

          return resolve({
            code: code,
            stdout: stdout,
            stderr: stderr,
            size: stat.size,
            file: this.outputArgument
          });
        });
      });
    });
  }

  cleanup() {
    const files = [this.tempFilePath('header'), this.tempFilePath('cover'), this.tempFilePath('content'), this.tempFilePath('footer'), this.tempFilePath('toc', 'xml'), this.tempFilePath('output', 'pdf')];
    return new Promise((resolve, reject) => {
      _async.default.each(files, _rimraf.default, err => {
        if (err) {
          return reject(err);
        } else {
          return resolve();
        }
      });
    });
  }

}

exports.default = HtmlToPdf;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYWluL3JlcG9ydHMvaHRtbC10by1wZGYuanMiXSwibmFtZXMiOlsiREVGQVVMVF9NQVJHSU4iLCJERUZBVUxUX1BBR0VfU0laRSIsIkRFRkFVTFRfSU1BR0VfUVVBTElUWSIsIkRFRkFVTFRfT1JJRU5UQVRJT04iLCJIdG1sVG9QZGYiLCJjb25zdHJ1Y3RvciIsImh0bWwiLCJoZWFkZXIiLCJmb290ZXIiLCJjb3ZlciIsIm1hcmdpblRvcCIsIm1hcmdpbkJvdHRvbSIsIm1hcmdpbkxlZnQiLCJtYXJnaW5SaWdodCIsInBhZ2VTaXplIiwiaW1hZ2VRdWFsaXR5Iiwib3JpZW50YXRpb24iLCJ3a2h0bWx0b3BkZiIsInRlbXBJRCIsInV1aWQiLCJ2NCIsImRlYnVnIiwiYmluYXJ5IiwiY29tbWFuZCIsInBhcnRzIiwicXVpZXRBcmd1bWVudCIsImNvdmVyQXJndW1lbnQiLCJoZWFkZXJBcmd1bWVudCIsImZvb3RlckFyZ3VtZW50IiwiaW5wdXRBcmd1bWVudCIsIm91dHB1dEFyZ3VtZW50IiwiXyIsImNvbXBhY3QiLCJ0ZW1wRmlsZVBhdGgiLCJwYXJ0IiwiZXh0IiwicGF0aCIsImpvaW4iLCJvcyIsInRtcGRpciIsImNvdmVyUGF0aCIsImZzIiwid3JpdGVGaWxlU3luYyIsImhlYWRlclBhdGgiLCJmb290ZXJQYXRoIiwicnVuIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJjbWQiLCJwcm9jZXNzIiwic3Rkb3V0Iiwic3RkZXJyIiwic3RkaW4iLCJzZXRFbmNvZGluZyIsImVuZCIsIm9uIiwiZGF0YSIsInB1c2giLCJ0b1N0cmluZyIsImNvZGUiLCJzdGF0IiwiZXJyIiwic2l6ZSIsImZpbGUiLCJjbGVhbnVwIiwiZmlsZXMiLCJhc3luYyIsImVhY2giLCJyaW1yYWYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLGNBQWMs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QUxZLEVBTVosS0FBS0EsWUFBTCxDQUFrQixRQUFsQixFQUE0QixLQUE1QixDQU5ZLENBQWQ7QUFTQSxXQUFPLElBQUlhLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDdENtQixxQkFBTUMsSUFBTixDQUFXRixLQUFYLEVBQWtCRyxlQUFsQixFQUEyQlAsR0FBRCxJQUFTO0FBQ2pDLFlBQUlBLEdBQUosRUFBUztBQUNQLGlCQUFPZCxNQUFNLENBQUNjLEdBQUQsQ0FBYjtBQUNELFNBRkQsTUFFTztBQUNMLGlCQUFPZixPQUFPLEVBQWQ7QUFDRDtBQUNGLE9BTkQ7QUFPRCxLQVJNLENBQVA7QUFTRDs7QUF0SjRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHV1aWQgZnJvbSAndXVpZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHNwYXduIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgYXN5bmMgZnJvbSAnYXN5bmMnO1xuaW1wb3J0IHJpbXJhZiBmcm9tICdyaW1yYWYnO1xuXG5jb25zdCBERUZBVUxUX01BUkdJTiA9ICcwLjc1aW4nO1xuY29uc3QgREVGQVVMVF9QQUdFX1NJWkUgPSAnTGV0dGVyJztcbmNvbnN0IERFRkFVTFRfSU1BR0VfUVVBTElUWSA9ICc4NSc7XG5jb25zdCBERUZBVUxUX09SSUVOVEFUSU9OID0gJ1BvcnRyYWl0JztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSHRtbFRvUGRmIHtcbiAgY29uc3RydWN0b3IoaHRtbCwge2hlYWRlciwgZm9vdGVyLCBjb3ZlciwgbWFyZ2luVG9wLCBtYXJnaW5Cb3R0b20sIG1hcmdpbkxlZnQsIG1hcmdpblJpZ2h0LCBwYWdlU2l6ZSwgaW1hZ2VRdWFsaXR5LCBvcmllbnRhdGlvbiwgd2todG1sdG9wZGZ9KSB7XG4gICAgdGhpcy50ZW1wSUQgPSB1dWlkLnY0KCk7XG4gICAgdGhpcy5kZWJ1ZyA9IGZhbHNlO1xuICAgIHRoaXMuaHRtbCA9IGh0bWw7XG4gICAgdGhpcy5oZWFkZXIgPSBoZWFkZXI7XG4gICAgdGhpcy5mb290ZXIgPSBmb290ZXI7XG4gICAgdGhpcy5jb3ZlciA9IGNvdmVyO1xuICAgIHRoaXMud2todG1sdG9wZGYgPSB3a2h0bWx0b3BkZjtcbiAgICB0aGlzLm1hcmdpblRvcCA9IG1hcmdpblRvcCB8fCBERUZBVUxUX01BUkdJTjtcbiAgICB0aGlzLm1hcmdpbkJvdHRvbSA9IG1hcmdpbkJvdHRvbSB8fCBERUZBVUxUX01BUkdJTjtcbiAgICB0aGlzLm1hcmdpbkxlZnQgPSBtYXJnaW5MZWZ0IHx8IERFRkFVTFRfTUFSR0lOO1xuICAgIHRoaXMubWFyZ2luUmlnaHQgPSBtYXJnaW5SaWdodCB8fCBERUZBVUxUX01BUkdJTjtcbiAgICB0aGlzLnBhZ2VTaXplID0gcGFnZVNpemUgfHwgREVGQVVMVF9QQUdFX1NJWkU7XG4gICAgdGhpcy5pbWFnZVF1YWxpdHkgPSBpbWFnZVF1YWxpdHkgfHwgREVGQVVMVF9JTUFHRV9RVUFMSVRZO1xuICAgIHRoaXMub3JpZW50YXRpb24gPSBvcmllbnRhdGlvbiB8fCBERUZBVUxUX09SSUVOVEFUSU9OO1xuICB9XG5cbiAgZ2V0IGJpbmFyeSgpIHtcbiAgICByZXR1cm4gdGhpcy53a2h0bWx0b3BkZiB8fCAnL3Vzci9sb2NhbC9iaW4vd2todG1sdG9wZGYnO1xuICB9XG5cbiAgZ2V0IGNvbW1hbmQoKSB7XG4gICAgY29uc3QgcGFydHMgPSBbXG4gICAgICAnLS1wYWdlLXNpemUnLCB0aGlzLnBhZ2VTaXplLFxuICAgICAgJy0tbWFyZ2luLXRvcCcsIHRoaXMubWFyZ2luVG9wLFxuICAgICAgJy0tbWFyZ2luLWxlZnQnLCB0aGlzLm1hcmdpbkxlZnQsXG4gICAgICAnLS1tYXJnaW4tYm90dG9tJywgdGhpcy5tYXJnaW5Cb3R0b20sXG4gICAgICAnLS1tYXJnaW4tcmlnaHQnLCB0aGlzLm1hcmdpblJpZ2h0LFxuICAgICAgJy0taW1hZ2UtcXVhbGl0eScsIHRoaXMuaW1hZ2VRdWFsaXR5LFxuICAgICAgJy0tb3JpZW50YXRpb24nLCB0aGlzLm9yaWVudGF0aW9uLFxuICAgICAgJy0tZW5jb2RpbmcnLCAnVVRGLTgnLFxuICAgICAgdGhpcy5xdWlldEFyZ3VtZW50LFxuICAgICAgLi4udGhpcy5jb3ZlckFyZ3VtZW50LFxuICAgICAgLi4udGhpcy5oZWFkZXJBcmd1bWVudCxcbiAgICAgIC4uLnRoaXMuZm9vdGVyQXJndW1lbnQsXG4gICAgICB0aGlzLmlucHV0QXJndW1lbnQsXG4gICAgICB0aGlzLm91dHB1dEFyZ3VtZW50IF07XG5cbiAgICByZXR1cm4gXy5jb21wYWN0KHBhcnRzKTtcbiAgfVxuXG4gIHRlbXBGaWxlUGF0aChwYXJ0LCBleHQgPSAnaHRtbCcpIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKG9zLnRtcGRpcigpLCBgJHt0aGlzLnRlbXBJRH1fJHtwYXJ0fS4ke2V4dH1gKTtcbiAgfVxuXG4gIGdldCBxdWlldEFyZ3VtZW50KCkge1xuICAgIHJldHVybiAnLS1xdWlldCc7XG4gICAgLy8gcmV0dXJuIHRoaXMuZGVidWcgPyBudWxsIDogJy0tcXVpZXQnO1xuICB9XG5cbiAgZ2V0IGlucHV0QXJndW1lbnQoKSB7XG4gICAgcmV0dXJuICctJztcbiAgfVxuXG4gIGdldCBvdXRwdXRBcmd1bWVudCgpIHtcbiAgICByZXR1cm4gdGhpcy50ZW1wRmlsZVBhdGgodGhpcy50ZW1wSUQgKyAnX291dHB1dCcsICdwZGYnKTtcbiAgfVxuXG4gIGdldCBjb3ZlckFyZ3VtZW50KCkge1xuICAgIGlmICh0aGlzLmNvdmVyKSB7XG4gICAgICBjb25zdCBjb3ZlclBhdGggPSB0aGlzLnRlbXBGaWxlUGF0aCgnY292ZXInKTtcblxuICAgICAgZnMud3JpdGVGaWxlU3luYyhjb3ZlclBhdGgsIHRoaXMuY292ZXIpO1xuXG4gICAgICByZXR1cm4gWyAnY292ZXInLCBjb3ZlclBhdGggXTtcbiAgICB9XG5cbiAgICByZXR1cm4gW107XG4gIH1cblxuICBnZXQgaGVhZGVyQXJndW1lbnQoKSB7XG4gICAgaWYgKHRoaXMuaGVhZGVyKSB7XG4gICAgICBjb25zdCBoZWFkZXJQYXRoID0gdGhpcy50ZW1wRmlsZVBhdGgoJ2hlYWRlcicpO1xuXG4gICAgICBmcy53cml0ZUZpbGVTeW5jKGhlYWRlclBhdGgsIHRoaXMuaGVhZGVyKTtcblxuICAgICAgcmV0dXJuIFsgJy0taGVhZGVyLWh0bWwnLCBoZWFkZXJQYXRoIF07XG4gICAgfVxuXG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgZ2V0IGZvb3RlckFyZ3VtZW50KCkge1xuICAgIGlmICh0aGlzLmZvb3Rlcikge1xuICAgICAgY29uc3QgZm9vdGVyUGF0aCA9IHRoaXMudGVtcEZpbGVQYXRoKCdmb290ZXInKTtcblxuICAgICAgZnMud3JpdGVGaWxlU3luYyhmb290ZXJQYXRoLCB0aGlzLmZvb3Rlcik7XG5cbiAgICAgIHJldHVybiBbICctLWZvb3Rlci1odG1sJywgZm9vdGVyUGF0aCBdO1xuICAgIH1cblxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHJ1bigpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgY21kID0gdGhpcy5jb21tYW5kO1xuXG4gICAgICBjb25zdCBwcm9jZXNzID0gc3Bhd24odGhpcy5iaW5hcnksIGNtZCwge30pO1xuXG4gICAgICBjb25zdCBzdGRvdXQgPSBbXTtcbiAgICAgIGNvbnN0IHN0ZGVyciA9IFtdO1xuXG4gICAgICBwcm9jZXNzLnN0ZGluLnNldEVuY29kaW5nKCd1dGY4Jyk7XG4gICAgICBwcm9jZXNzLnN0ZGluLmVuZCh0aGlzLmh0bWwpO1xuXG4gICAgICBwcm9jZXNzLnN0ZG91dC5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgIHN0ZG91dC5wdXNoKGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICB9KTtcblxuICAgICAgcHJvY2Vzcy5zdGRlcnIub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgICBzdGRlcnIucHVzaChkYXRhLnRvU3RyaW5nKCkpO1xuICAgICAgfSk7XG5cbiAgICAgIHByb2Nlc3Mub24oJ2Nsb3NlJywgKGNvZGUpID0+IHtcbiAgICAgICAgZnMuc3RhdCh0aGlzLm91dHB1dEFyZ3VtZW50LCAoZXJyLCBzdGF0KSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiByZXNvbHZlKHtjb2RlOiBjb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQ6IHN0ZG91dCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RkZXJyOiBzdGRlcnIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU6IHN0YXQuc2l6ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZTogdGhpcy5vdXRwdXRBcmd1bWVudH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgY2xlYW51cCgpIHtcbiAgICBjb25zdCBmaWxlcyA9IFtcbiAgICAgIHRoaXMudGVtcEZpbGVQYXRoKCdoZWFkZXInKSxcbiAgICAgIHRoaXMudGVtcEZpbGVQYXRoKCdjb3ZlcicpLFxuICAgICAgdGhpcy50ZW1wRmlsZVBhdGgoJ2NvbnRlbnQnKSxcbiAgICAgIHRoaXMudGVtcEZpbGVQYXRoKCdmb290ZXInKSxcbiAgICAgIHRoaXMudGVtcEZpbGVQYXRoKCd0b2MnLCAneG1sJyksXG4gICAgICB0aGlzLnRlbXBGaWxlUGF0aCgnb3V0cHV0JywgJ3BkZicpXG4gICAgXTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBhc3luYy5lYWNoKGZpbGVzLCByaW1yYWYsIChlcnIpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuIl19
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _downloadResource = _interopRequireDefault(require("./download-resource"));

var _client = _interopRequireDefault(require("../../api/client"));

var _fs = _interopRequireDefault(require("fs"));

var _tempy = _interopRequireDefault(require("tempy"));

var _jsonseq = require("../../../jsonseq");

var _util = require("util");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const QUERY_PAGE_SIZE = 5000;

class DownloadQuerySequence extends _downloadResource.default {
  get useRestAPI() {
    return true;
  }

  async run({
    dataSource
  }) {
    const state = await this.checkSyncState();

    if (!state.needsUpdate) {
      return;
    }

    const lastSync = this.lastSync;
    const sequence = lastSync ? lastSync.getTime() : null;
    this.dataSource = dataSource;
    await this.download(lastSync, sequence, state);
  }

  async download(lastSync, sequence, state) {
    let nextSequence = sequence || 0;

    while (nextSequence != null) {
      if (this.useRestAPI && lastSync != null) {
        nextSequence = await this.downloadRestAPIPage(lastSync, nextSequence, state);
      } else {
        nextSequence = await this.downloadQueryAPIPage(lastSync, nextSequence, state);
      }

      await this.account.save();
    }

    await state.update();
    await this.finish();
  }

  async downloadRestAPIPage(lastSync, sequence, state) {
    const beginFetchTime = new Date();
    this.progress({
      message: this.downloading + ' ' + this.syncLabel.blue
    });
    const results = await this.fetchObjects(lastSync, sequence);
    const totalFetchTime = new Date().getTime() - beginFetchTime.getTime();

    if (results.statusCode !== 200) {
      this.fail(results);
      return null;
    }

    const data = JSON.parse(results.body);
    const objects = data[this.resourceName];
    const db = this.db;
    let now = new Date();
    this.progress({
      message: this.processing + ' ' + this.syncLabel.blue,
      count: 0,
      total: objects.length
    });
    await db.transaction(async database => {
      for (let index = 0; index < objects.length; ++index) {
        const attributes = objects[index];
        const object = await this.findOrCreate(database, attributes);
        await this.process(object, attributes);
        this.progress({
          message: this.processing + ' ' + this.syncLabel.blue,
          count: index + 1,
          total: objects.length
        });
      }
    });
    const totalTime = new Date().getTime() - now.getTime();
    const message = (0, _util.format)(this.finished + ' %s | %s | %s', this.syncLabel.blue, (totalFetchTime + 'ms').cyan, (totalTime + 'ms').red);
    this.progress({
      message,
      count: objects.length,
      total: objects.length
    });
    return data.next_sequence;
  }

  async downloadQueryAPIPage(lastSync, sequence, state) {
    const sql = this.generateQuery(sequence || 0, QUERY_PAGE_SIZE);

    const options = _client.default.getQueryURL(this.account, sql);

    const filePath = _tempy.default.file({
      extension: 'jsonseq'
    });

    this.progress({
      message: this.downloading + ' ' + this.syncLabel.blue
    });
    await this.downloadQuery(options, filePath);
    const {
      count,
      lastObject
    } = await this.processQueryResponse(filePath);
    const message = (0, _util.format)(this.finished + ' %s', this.syncLabel.blue);
    this.progress({
      message,
      count: count,
      total: -1
    });

    if (count >= QUERY_PAGE_SIZE) {
      return Math.ceil(lastObject.updatedAt.getTime() - 1);
    }

    return null;
  }

  async processQueryResponse(filePath) {
    this.progress({
      message: this.processing + ' ' + this.syncLabel.blue,
      count: 0,
      total: -1
    });
    let index = 0;
    let lastObject = null;
    await this.db.transaction(async database => {
      await new Promise((resolve, reject) => {
        const onObject = (json, done) => {
          if (json.row) {
            this.processQueryObject(json, database, (err, object) => {
              if (err) {
                fulcrum.logger.error('Error', err.message, err.stack);
                return done(err);
              }

              lastObject = object;
              this.progress({
                message: this.processing + ' ' + this.syncLabel.blue,
                count: index + 1,
                total: -1
              });
              ++index;
              done();
            });
          } else {
            done();
          }
        };

        const onInvalid = (data, done) => {
          fulcrum.logger.error('Invalid', data && data.toString());
          done(new Error('invalid JSON sequence'));
        };

        const onTruncated = (data, done) => {
          fulcrum.logger.error('Truncated:', data && data.toString());
          done(new Error('truncated JSON sequence'));
        };

        const onEnd = () => {
          resolve();
        };

        const onError = err => {
          reject(err);
        };

        (0, _jsonseq.parseFile)(filePath, {
          onObject,
          onInvalid,
          onTruncated
        }).on('end', onEnd).on('error', onError);
      });
    });
    return {
      count: index,
      lastObject
    };
  }

  processQueryObject(attributes, database, done) {
    this.processObjectAsync(attributes, database).then(o => done(null, o)).catch(done);
  }

  async processObjectAsync(json, database) {
    const attributes = this.attributesForQueryRow(json.row);
    const object = await this.findOrCreate(database, attributes);
    await this.process(object, attributes);
    return object;
  }

  async downloadQuery(options, to) {
    return new Promise((resolve, reject) => {
      const rq = _client.default.rawRequest(options).pipe(_fs.default.createWriteStream(to));

      rq.on('close', () => resolve(rq));
      rq.on('error', reject);
    });
  }

  async finish() {
    await this.account.save();
  }

}

exports.default = DownloadQuerySequence;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tYWluL3N5bmMvdGFza3MvZG93bmxvYWQtcXVlcnktc2VxdWVuY2UuanMiXSwibmFtZXMiOlsiUVVFUllfUEFHRV9TSVpFIiwiRG93bmxvYWRRdWVyeVNlcXVlbmNlIiwiRG93bmxvYWRSZXNvdXJjZSIsInVzZVJlc3RBUEkiLCJydW4iLCJkYXRhU291cmNlIiwic3RhdGUiLCJjaGVja1N5bmNTdGF0ZSIsIm5lZWRzVXBkYXRlIiwibGFzdFN5bmMiLCJzZXF1ZW5jZSIsImdldFRpbWUiLCJkb3dubG9hZCIsIm5leHRTZXF1ZW5jZSIsImRvd25sb2FkUmVzdEFQSVBhZ2UiLCJkb3dubG9hZFF1ZXJ5QVBJUGFnZSIsImFjY291bnQiLCJzYXZlIiwidXBkYXRlIiwiZmluaXNoIiwiYmVnaW5GZXRjaFRpbWUiLCJEYXRlIiwicHJvZ3Jlc3MiLCJtZXNzYWdlIiwiZG93bmxvYWRpbmciLCJzeW5jTGFiZWwiLCJibHVlIiwicmVzdWx0cyIsImZldGNoT2JqZWN0cyIsInRvdGFsRmV0Y2hUaW1lIiwic3RhdHVzQ29kZSIsImZhaWwiLCJkYXRhIiwiSlNPTiIsInBhcnNlIiwiYm9keSIsIm9iamVjdHMiLCJyZXNvdXJjZU5hbWUiLCJkYiIsIm5vdyIsInByb2Nlc3NpbmciLCJjb3VudCIsInRvdGFsIiwibGVuZ3RoIiwidHJhbnNhY3Rpb24iLCJkYXRhYmFzZSIsImluZGV4IiwiYXR0cmlidXRlcyIsIm9iamVjdCIsImZpbmRPckNyZWF0ZSIsInByb2Nlc3MiLCJ0b3RhbFRpbWUiLCJmaW5pc2hlZCIsImN5YW4iLCJyZWQiLCJuZXh0X3NlcXVlbmNlIiwic3FsIiwiZ2VuZXJhdGVRdWVyeSIsIm9wdGlvbnMiLCJDbGllbnQiLCJnZXRRdWVyeVVSTCIsImZpbGVQYXRoIiwidGVtcHkiLCJmaWxlIiwiZXh0ZW5zaW9uIiwiZG93bmxvYWRRdWVyeSIsImxhc3RPYmplY3QiLCJwcm9jZXNzUXVlcnlSZXNwb25zZSIsIk1hdGgiLCJjZWlsIiwidXBkYXRlZEF0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJvbk9iamVjdCIsImpzb24iLCJkb25lIiwicm93IiwicHJvY2Vzc1F1ZXJ5T2JqZWN0IiwiZXJyIiwiZnVsY3J1bSIsImxvZ2dlciIsImVycm9yIiwic3RhY2siLCJvbkludmFsaWQiLCJ0b1N0cmluZyIsIkVycm9yIiwib25UcnVuY2F0ZWQiLCJvbkVuZCIsIm9uRXJyb3IiLCJvbiIsInByb2Nlc3NPYmplY3RBc3luYyIsInRoZW4iLCJvIiwiY2F0Y2giLCJhdHRyaWJ1dGVzRm9yUXVlcnlSb3ciLCJ0byIsInJxIiwicmF3UmVxdWVzdCIsInBpcGUiLCJmcyIsImNyZWF0ZVdyaXRlU3RyZWFtIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxlQUFlLEdBQUcsSUFBeEI7O0FBRWUsTUFBTUMscUJBQU4sU0FBb0NDLHlCQUFwQyxDQUFxRDtBQUNwRCxNQUFWQyxVQUFVLEdBQUc7QUFDZixXQUFPLElBQVA7QUFDRDs7QUFFUSxRQUFIQyxHQUFHLENBQUM7QUFBQ0MsSUFBQUE7QUFBRCxHQUFELEVBQWU7QUFDdEIsVUFBTUMsS0FBSyxHQUFHLE1BQU0sS0FBS0MsY0FBTCxFQUFwQjs7QUFFQSxRQUFJLENBQUNELEtBQUssQ0FBQ0UsV0FBWCxFQUF3QjtBQUN0QjtBQUNEOztBQUVELFVBQU1DLFFBQVEsR0FBRyxLQUFLQSxRQUF0QjtBQUVBLFVBQU1DLFFBQVEsR0FBR0QsUUFBUSxHQUFHQSxRQUFRLENBQUNFLE9BQVQsRUFBSCxHQUF3QixJQUFqRDtBQUVBLFNBQUtOLFVBQUwsR0FBa0JBLFVBQWxCO0FBRUEsVUFBTSxLQUFLTyxRQUFMLENBQWNILFFBQWQsRUFBd0JDLFFBQXhCLEVBQWtDSixLQUFsQyxDQUFOO0FBQ0Q7O0FBRWEsUUFBUk0sUUFBUSxDQUFDSCxRQUFELEVBQVdDLFFBQVgsRUFBcUJKLEtBQXJCLEVBQTRCO0FBQ3hDLFFBQUlPLFlBQVks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bEIsRUFBMkJ5QyxJQUEzQixDQUFnQ0MsWUFBR0MsaUJBQUgsQ0FBcUJMLEVBQXJCLENBQWhDLENBQVg7O0FBQ0FDLE1BQUFBLEVBQUUsQ0FBQ1AsRUFBSCxDQUFNLE9BQU4sRUFBZSxNQUFNbEIsT0FBTyxDQUFDeUIsRUFBRCxDQUE1QjtBQUNBQSxNQUFBQSxFQUFFLENBQUNQLEVBQUgsQ0FBTSxPQUFOLEVBQWVqQixNQUFmO0FBQ0QsS0FKTSxDQUFQO0FBS0Q7O0FBRVcsUUFBTnRELE1BQU0sR0FBRztBQUNiLFVBQU0sS0FBS0gsT0FBTCxDQUFhQyxJQUFiLEVBQU47QUFDRDs7QUE1TGlFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IERvd25sb2FkUmVzb3VyY2UgZnJvbSAnLi9kb3dubG9hZC1yZXNvdXJjZSc7XG5pbXBvcnQgQ2xpZW50IGZyb20gJy4uLy4uL2FwaS9jbGllbnQnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCB0ZW1weSBmcm9tICd0ZW1weSc7XG5pbXBvcnQgeyBwYXJzZUZpbGUgfSBmcm9tICcuLi8uLi8uLi9qc29uc2VxJztcbmltcG9ydCB7IGZvcm1hdCB9IGZyb20gJ3V0aWwnO1xuXG5jb25zdCBRVUVSWV9QQUdFX1NJWkUgPSA1MDAwO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEb3dubG9hZFF1ZXJ5U2VxdWVuY2UgZXh0ZW5kcyBEb3dubG9hZFJlc291cmNlIHtcbiAgZ2V0IHVzZVJlc3RBUEkoKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBydW4oe2RhdGFTb3VyY2V9KSB7XG4gICAgY29uc3Qgc3RhdGUgPSBhd2FpdCB0aGlzLmNoZWNrU3luY1N0YXRlKCk7XG5cbiAgICBpZiAoIXN0YXRlLm5lZWRzVXBkYXRlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgbGFzdFN5bmMgPSB0aGlzLmxhc3RTeW5jO1xuXG4gICAgY29uc3Qgc2VxdWVuY2UgPSBsYXN0U3luYyA/IGxhc3RTeW5jLmdldFRpbWUoKSA6IG51bGw7XG5cbiAgICB0aGlzLmRhdGFTb3VyY2UgPSBkYXRhU291cmNlO1xuXG4gICAgYXdhaXQgdGhpcy5kb3dubG9hZChsYXN0U3luYywgc2VxdWVuY2UsIHN0YXRlKTtcbiAgfVxuXG4gIGFzeW5jIGRvd25sb2FkKGxhc3RTeW5jLCBzZXF1ZW5jZSwgc3RhdGUpIHtcbiAgICBsZXQgbmV4dFNlcXVlbmNlID0gc2VxdWVuY2UgfHwgMDtcblxuICAgIHdoaWxlIChuZXh0U2VxdWVuY2UgIT0gbnVsbCkge1xuICAgICAgaWYgKHRoaXMudXNlUmVzdEFQSSAmJiBsYXN0U3luYyAhPSBudWxsKSB7XG4gICAgICAgIG5leHRTZXF1ZW5jZSA9IGF3YWl0IHRoaXMuZG93bmxvYWRSZXN0QVBJUGFnZShsYXN0U3luYywgbmV4dFNlcXVlbmNlLCBzdGF0ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXh0U2VxdWVuY2UgPSBhd2FpdCB0aGlzLmRvd25sb2FkUXVlcnlBUElQYWdlKGxhc3RTeW5jLCBuZXh0U2VxdWVuY2UsIHN0YXRlKTtcbiAgICAgIH1cblxuICAgICAgYXdhaXQgdGhpcy5hY2NvdW50LnNhdmUoKTtcbiAgICB9XG5cbiAgICBhd2FpdCBzdGF0ZS51cGRhdGUoKTtcbiAgICBhd2FpdCB0aGlzLmZpbmlzaCgpO1xuICB9XG5cbiAgYXN5bmMgZG93bmxvYWRSZXN0QVBJUGFnZShsYXN0U3luYywgc2VxdWVuY2UsIHN0YXRlKSB7XG4gICAgY29uc3QgYmVnaW5GZXRjaFRpbWUgPSBuZXcgRGF0ZSgpO1xuXG4gICAgdGhpcy5wcm9ncmVzcyh7bWVzc2FnZTogdGhpcy5kb3dubG9hZGluZyArICcgJyArIHRoaXMuc3luY0xhYmVsLmJsdWV9KTtcblxuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLmZldGNoT2JqZWN0cyhsYXN0U3luYywgc2VxdWVuY2UpO1xuXG4gICAgY29uc3QgdG90YWxGZXRjaFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIGJlZ2luRmV0Y2hUaW1lLmdldFRpbWUoKTtcblxuICAgIGlmIChyZXN1bHRzLnN0YXR1c0NvZGUgIT09IDIwMCkge1xuICAgICAgdGhpcy5mYWlsKHJlc3VsdHMpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UocmVzdWx0cy5ib2R5KTtcblxuICAgIGNvbnN0IG9iamVjdHMgPSBkYXRhW3RoaXMucmVzb3VyY2VOYW1lXTtcblxuICAgIGNvbnN0IGRiID0gdGhpcy5kYjtcblxuICAgIGxldCBub3cgPSBuZXcgRGF0ZSgpO1xuXG4gICAgdGhpcy5wcm9ncmVzcyh7bWVzc2FnZTogdGhpcy5wcm9jZXNzaW5nICsgJyAnICsgdGhpcy5zeW5jTGFiZWwuYmx1ZSwgY291bnQ6IDAsIHRvdGFsOiBvYmplY3RzLmxlbmd0aH0pO1xuXG4gICAgYXdhaXQgZGIudHJhbnNhY3Rpb24oYXN5bmMgKGRhdGFiYXNlKSA9PiB7XG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgb2JqZWN0cy5sZW5ndGg7ICsraW5kZXgpIHtcbiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG9iamVjdHNbaW5kZXhdO1xuXG4gICAgICAgIGNvbnN0IG9iamVjdCA9IGF3YWl0IHRoaXMuZmluZE9yQ3JlYXRlKGRhdGFiYXNlLCBhdHRyaWJ1dGVzKTtcblxuICAgICAgICBhd2FpdCB0aGlzLnByb2Nlc3Mob2JqZWN0LCBhdHRyaWJ1dGVzKTtcblxuICAgICAgICB0aGlzLnByb2dyZXNzKHttZXNzYWdlOiB0aGlzLnByb2Nlc3NpbmcgKyAnICcgKyB0aGlzLnN5bmNMYWJlbC5ibHVlLCBjb3VudDogaW5kZXggKyAxLCB0b3RhbDogb2JqZWN0cy5sZW5ndGh9KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHRvdGFsVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gbm93LmdldFRpbWUoKTtcblxuICAgIGNvbnN0IG1lc3NhZ2UgPSBmb3JtYXQodGhpcy5maW5pc2hlZCArICcgJXMgfCAlcyB8ICVzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3luY0xhYmVsLmJsdWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAodG90YWxGZXRjaFRpbWUgKyAnbXMnKS5jeWFuLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRvdGFsVGltZSArICdtcycpLnJlZCk7XG5cbiAgICB0aGlzLnByb2dyZXNzKHttZXNzYWdlLCBjb3VudDogb2JqZWN0cy5sZW5ndGgsIHRvdGFsOiBvYmplY3RzLmxlbmd0aH0pO1xuXG4gICAgcmV0dXJuIGRhdGEubmV4dF9zZXF1ZW5jZTtcbiAgfVxuXG4gIGFzeW5jIGRvd25sb2FkUXVlcnlBUElQYWdlKGxhc3RTeW5jLCBzZXF1ZW5jZSwgc3RhdGUpIHtcbiAgICBjb25zdCBzcWwgPSB0aGlzLmdlbmVyYXRlUXVlcnkoc2VxdWVuY2UgfHwgMCwgUVVFUllfUEFHRV9TSVpFKTtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSBDbGllbnQuZ2V0UXVlcnlVUkwodGhpcy5hY2NvdW50LCBzcWwpO1xuXG4gICAgY29uc3QgZmlsZVBhdGggPSB0ZW1weS5maWxlKHtleHRlbnNpb246ICdqc29uc2VxJ30pO1xuXG4gICAgdGhpcy5wcm9ncmVzcyh7bWVzc2FnZTogdGhpcy5kb3dubG9hZGluZyArICcgJyArIHRoaXMuc3luY0xhYmVsLmJsdWV9KTtcblxuICAgIGF3YWl0IHRoaXMuZG93bmxvYWRRdWVyeShvcHRpb25zLCBmaWxlUGF0aCk7XG5cbiAgICBjb25zdCB7Y291bnQsIGxhc3RPYmplY3R9ID0gYXdhaXQgdGhpcy5wcm9jZXNzUXVlcnlSZXNwb25zZShmaWxlUGF0aCk7XG5cbiAgICBjb25zdCBtZXNzYWdlID0gZm9ybWF0KHRoaXMuZmluaXNoZWQgKyAnICVzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3luY0xhYmVsLmJsdWUpO1xuXG4gICAgdGhpcy5wcm9ncmVzcyh7bWVzc2FnZSwgY291bnQ6IGNvdW50LCB0b3RhbDogLTF9KTtcblxuICAgIGlmIChjb3VudCA+PSBRVUVSWV9QQUdFX1NJWkUpIHtcbiAgICAgIHJldHVybiBNYXRoLmNlaWwobGFzdE9iamVjdC51cGRhdGVkQXQuZ2V0VGltZSgpIC0gMSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBhc3luYyBwcm9jZXNzUXVlcnlSZXNwb25zZShmaWxlUGF0aCkge1xuICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMucHJvY2Vzc2luZyArICcgJyArIHRoaXMuc3luY0xhYmVsLmJsdWUsIGNvdW50OiAwLCB0b3RhbDogLTF9KTtcblxuICAgIGxldCBpbmRleCA9IDA7XG4gICAgbGV0IGxhc3RPYmplY3QgPSBudWxsO1xuXG4gICAgYXdhaXQgdGhpcy5kYi50cmFuc2FjdGlvbihhc3luYyAoZGF0YWJhc2UpID0+IHtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3Qgb25PYmplY3QgPSAoanNvbiwgZG9uZSkgPT4ge1xuICAgICAgICAgIGlmIChqc29uLnJvdykge1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzUXVlcnlPYmplY3QoanNvbiwgZGF0YWJhc2UsIChlcnIsIG9iamVjdCkgPT4ge1xuICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgZnVsY3J1bS5sb2dnZXIuZXJyb3IoJ0Vycm9yJywgZXJyLm1lc3NhZ2UsIGVyci5zdGFjayk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUoZXJyKTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGxhc3RPYmplY3QgPSBvYmplY3Q7XG4gICAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMucHJvY2Vzc2luZyArICcgJyArIHRoaXMuc3luY0xhYmVsLmJsdWUsIGNvdW50OiBpbmRleCArIDEsIHRvdGFsOiAtMX0pO1xuICAgICAgICAgICAgICArK2luZGV4O1xuICAgICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBvbkludmFsaWQgPSAoZGF0YSwgZG9uZSkgPT4ge1xuICAgICAgICAgIGZ1bGNydW0ubG9nZ2VyLmVycm9yKCdJbnZhbGlkJywgZGF0YSAmJiBkYXRhLnRvU3RyaW5nKCkpO1xuICAgICAgICAgIGRvbmUobmV3IEVycm9yKCdpbnZhbGlkIEpTT04gc2VxdWVuY2UnKSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgb25UcnVuY2F0ZWQgPSAoZGF0YSwgZG9uZSkgPT4ge1xuICAgICAgICAgIGZ1bGNydW0ubG9nZ2VyLmVycm9yKCdUcnVuY2F0ZWQ6JywgZGF0YSAmJiBkYXRhLnRvU3RyaW5nKCkpO1xuICAgICAgICAgIGRvbmUobmV3IEVycm9yKCd0cnVuY2F0ZWQgSlNPTiBzZXF1ZW5jZScpKTtcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBvbkVuZCA9ICgpID0+IHtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgb25FcnJvciA9IChlcnIpID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfTtcblxuICAgICAgICBwYXJzZUZpbGUoZmlsZVBhdGgsIHtvbk9iamVjdCwgb25JbnZhbGlkLCBvblRydW5jYXRlZH0pXG4gICAgICAgICAgLm9uKCdlbmQnLCBvbkVuZClcbiAgICAgICAgICAub24oJ2Vycm9yJywgb25FcnJvcik7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHJldHVybiB7Y291bnQ6IGluZGV4LCBsYXN0T2JqZWN0fTtcbiAgfVxuXG4gIHByb2Nlc3NRdWVyeU9iamVjdChhdHRyaWJ1dGVzLCBkYXRhYmFzZSwgZG9uZSkge1xuICAgIHRoaXMucHJvY2Vzc09iamVjdEFzeW5jKGF0dHJpYnV0ZXMsIGRhdGFiYXNlKS50aGVuKG8gPT4gZG9uZShudWxsLCBvKSkuY2F0Y2goZG9uZSk7XG4gIH1cblxuICBhc3luYyBwcm9jZXNzT2JqZWN0QXN5bmMoanNvbiwgZGF0YWJhc2UpIHtcbiAgICBjb25zdCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzRm9yUXVlcnlSb3coanNvbi5yb3cpO1xuXG4gICAgY29uc3Qgb2JqZWN0ID0gYXdhaXQgdGhpcy5maW5kT3JDcmVhdGUoZGF0YWJhc2UsIGF0dHJpYnV0ZXMpO1xuXG4gICAgYXdhaXQgdGhpcy5wcm9jZXNzKG9iamVjdCwgYXR0cmlidXRlcyk7XG5cbiAgICByZXR1cm4gb2JqZWN0O1xuICB9XG5cbiAgYXN5bmMgZG93bmxvYWRRdWVyeShvcHRpb25zLCB0bykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBycSA9IENsaWVudC5yYXdSZXF1ZXN0KG9wdGlvbnMpLnBpcGUoZnMuY3JlYXRlV3JpdGVTdHJlYW0odG8pKTtcbiAgICAgIHJxLm9uKCdjbG9zZScsICgpID0+IHJlc29sdmUocnEpKTtcbiAgICAgIHJxLm9uKCdlcnJvcicsIHJlamVjdCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5pc2goKSB7XG4gICAgYXdhaXQgdGhpcy5hY2NvdW50LnNhdmUoKTtcbiAgfVxufVxuIl19
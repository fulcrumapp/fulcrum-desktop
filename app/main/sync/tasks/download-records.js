"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _downloadQuerySequence = _interopRequireDefault(require("./download-query-sequence"));

var _client = _interopRequireDefault(require("../../api/client"));

var _record = _interopRequireDefault(require("../../models/record"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class DownloadRecords extends _downloadQuerySequence.default {
  constructor({
    form,
    ...args
  }) {
    super(args);
    this.form = form;
  }

  get syncResourceScope() {
    return this.form.id;
  }

  get syncLabel() {
    return this.form.name;
  }

  get resourceName() {
    return 'records';
  }

  get typeName() {
    return 'record';
  }

  get lastSync() {
    return this.form._lastSync;
  }

  async fetchObjects(lastSync, sequence) {
    return lastSync == null ? await _client.default.getRecords(this.account, this.form, sequence, this.pageSize) : await _client.default.getRecordsHistory(this.account, this.form, sequence, this.pageSize);
  }

  findOrCreate(database, attributes) {
    return _record.default.findOrCreate(database, {
      account_id: this.account.rowID,
      resource_id: attributes.id
    });
  }

  async process(object, attributes) {
    if (attributes.history_change_type === 'd') {
      if (object) {
        object._form = this.form;
        object._formRowID = this.form.rowID;
        await object.delete();
        this._hasChanges = true;
        await this.trigger('record:delete', {
          record: object
        });
      }
    } else {
      const isChanged = !object.isPersisted || attributes.version !== object.version;
      object.updateFromAPIAttributes(attributes);
      object._form = this.form;
      object._formRowID = this.form.rowID;
      this.form._lastSync = object.updatedAt;
      await this.lookup(object, attributes.project_id, '_projectRowID', 'getProject');
      await this.lookup(object, attributes.assigned_to_id, '_assignedToRowID', 'getUser');
      await this.lookup(object, attributes.created_by_id, '_createdByRowID', 'getUser');
      await this.lookup(object, attributes.updated_by_id, '_updatedByRowID', 'getUser');
      await this.lookup(object, attributes.changeset_id, '_changesetRowID', 'getChangeset');
      await object.save();

      if (isChanged) {
        this._hasChanges = true;
        this.synchronizer.incrementRecordCount();
        await this.trigger('record:save', {
          record: object
        });
      }
    }
  }

  async finish() {
    // update the lastSync date
    await this.form.save();

    if (this._hasChanges) {
      await this.trigger('records:finish', {
        form: this.form
      });
    }
  }

  attributesForQueryRow(row) {
    const hasCreatedLocation = row[28] != null || row[29] != null || row[30] != null || row[31] != null;
    const hasUpdatedLocation = row[32] != null || row[33] != null || row[34] != null || row[35] != null;
    return {
      status: row[0],
      version: row[1],
      id: row[2],
      created_at: row[3],
      updated_at: row[4],
      client_created_at: row[5],
      client_updated_at: row[6],
      created_by_id: row[7],
      updated_by_id: row[8],
      form_id: row[9],
      project_id: row[10],
      assigned_to_id: row[11],
      form_values: JSON.parse(row[12]),
      latitude: row[13],
      longitude: row[14],
      altitude: row[15],
      speed: row[16],
      course: row[17],
      horizontal_accuracy: row[18],
      vertical_accuracy: row[19],
      edited_duration: row[20],
      updated_duration: row[21],
      created_duration: row[22],
      created_by: row[23],
      updated_by: row[24],
      assigned_to: row[25],
      project: row[26],
      changeset_id: row[27],
      created_location: hasCreatedLocation && {
        latitude: row[28],
        longitude: row[29],
        altitude: row[30],
        horizontal_accuracy: row[31]
      },
      updated_location: hasUpdatedLocation && {
        latitude: row[32],
        longitude: row[33],
        altitude: row[34],
        horizontal_accuracy: row[35]
      }
    };
  }

  generateQuery(sequence, limit) {
    const sequenceString = new Date(+sequence).toISOString();
    return `
SELECT
  "_status" AS "status",
  "_version" AS "version",
  "_record_id" AS "id",
  to_char(pg_catalog.timezone('UTC', "_server_created_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "created_at",
  to_char(pg_catalog.timezone('UTC', "_server_updated_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "updated_at",
  to_char(pg_catalog.timezone('UTC', "_created_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "client_created_at",
  to_char(pg_catalog.timezone('UTC', "_updated_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "client_updated_at",
  "_created_by_id" AS "created_by_id",
  "_updated_by_id" AS "updated_by_id",
  '${this.form.id}'::text AS "form_id",
  "_project_id" AS "project_id",
  "_assigned_to_id" AS "assigned_to_id",
  "_form_values" AS "form_values",
  "_latitude" AS "latitude",
  "_longitude" AS "longitude",
  "_altitude" AS "altitude",
  "_speed" AS "speed",
  "_course" AS "course",
  "_horizontal_accuracy" AS "horizontal_accuracy",
  "_vertical_accuracy" AS "vertical_accuracy",
  "_edited_duration" AS "edited_duration",
  "_updated_duration" AS "updated_duration",
  "_created_duration" AS "created_duration",
  NULL AS "created_by",
  NULL AS "updated_by",
  NULL AS "assigned_to",
  NULL AS "project",
  "_changeset_id" AS "changeset_id",
  "_created_latitude" AS "created_latitude",
  "_created_longitude" AS "created_longitude",
  "_created_altitude" AS "created_altitude",
  "_created_horizontal_accuracy" AS "created_horizontal_accuracy",
  "_updated_latitude" AS "updated_latitude",
  "_updated_longitude" AS "updated_longitude",
  "_updated_altitude" AS "updated_altitude",
  "_updated_horizontal_accuracy" AS "updated_horizontal_accuracy"
FROM "${this.form.id}/_full" AS "records"
WHERE
  _server_updated_at > '${sequenceString}'
ORDER BY
  _server_updated_at ASC
LIMIT ${limit} OFFSET 0
`;
  }

}

exports.default = DownloadRecords;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tYWluL3N5bmMvdGFza3MvZG93bmxvYWQtcmVjb3Jkcy5qcyJdLCJuYW1lcyI6WyJEb3dubG9hZFJlY29yZHMiLCJEb3dubG9hZFF1ZXJ5U2VxdWVuY2UiLCJjb25zdHJ1Y3RvciIsImZvcm0iLCJhcmdzIiwic3luY1Jlc291cmNlU2NvcGUiLCJpZCIsInN5bmNMYWJlbCIsIm5hbWUiLCJyZXNvdXJjZU5hbWUiLCJ0eXBlTmFtZSIsImxhc3RTeW5jIiwiX2xhc3RTeW5jIiwiZmV0Y2hPYmplY3RzIiwic2VxdWVuY2UiLCJDbGllbnQiLCJnZXRSZWNvcmRzIiwiYWNjb3VudCIsInBhZ2VTaXplIiwiZ2V0UmVjb3Jkc0hpc3RvcnkiLCJmaW5kT3JDcmVhdGUiLCJkYXRhYmFzZSIsImF0dHJpYnV0ZXMiLCJSZWNvcmQiLCJhY2NvdW50X2lkIiwicm93SUQiLCJyZXNvdXJjZV9pZCIsInByb2Nlc3MiLCJvYmplY3QiLCJoaXN0b3J5X2NoYW5nZV90eXBlIiwiX2Zvcm0iLCJfZm9ybVJvd0lEIiwiZGVsZXRlIiwiX2hhc0NoYW5nZXMiLCJ0cmlnZ2VyIiwicmVjb3JkIiwiaXNDaGFuZ2VkIiwiaXNQZXJzaXN0ZWQiLCJ2ZXJzaW9uIiwidXBkYXRlRnJvbUFQSUF0dHJpYnV0ZXMiLCJ1cGRhdGVkQXQiLCJsb29rdXAiLCJwcm9qZWN0X2lkIiwiYXNzaWduZWRfdG9faWQiLCJjcmVhdGVkX2J5X2lkIiwidXBkYXRlZF9ieV9pZCIsImNoYW5nZXNldF9pZCIsInNhdmUiLCJzeW5jaHJvbml6ZXIiLCJpbmNyZW1lbnRSZWNvcmRDb3VudCIsImZpbmlzaCIsImF0dHJpYnV0ZXNGb3JRdWVyeVJvdyIsInJvdyIsImhhc0NyZWF0ZWRMb2NhdGlvbiIsImhhc1VwZGF0ZWRMb2NhdGlvbiIsInN0YXR1cyIsImNyZWF0ZWRfYXQiLCJ1cGRhdGVkX2F0IiwiY2xpZW50X2NyZWF0ZWRfYXQiLCJjbGllbnRfdXBkYXRlZF9hdCIsImZvcm1faWQiLCJmb3JtX3ZhbHVlcyIsIkpTT04iLCJwYXJzZSIsImxhdGl0dWRlIiwibG9uZ2l0dWRlIiwiYWx0aXR1ZGUiLCJzcGVlZCIsImNvdXJzZSIsImhvcml6b250YWxfYWNjdXJhY3kiLCJ2ZXJ0aWNhbF9hY2N1cmFjeSIsImVkaXRlZF9kdXJhdGlvbiIsInVwZGF0ZWRfZHVyYXRpb24iLCJjcmVhdGVkX2R1cmF0aW9uIiwiY3JlYXRlZF9ieSIsInVwZGF0ZWRfYnkiLCJhc3NpZ25lZF90byIsInByb2plY3QiLCJjcmVhdGVkX2xvY2F0aW9uIiwidXBkYXRlZF9sb2NhdGlvbiIsImdlbmVyYXRlUXVlcnkiLCJsaW1pdCIsInNlcXVlbmNlU3RyaW5nIiwiRGF0ZSIsInRvSVNPU3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFZSxNQUFNQSxlQUFOLFNBQThCQyw4QkFBOUIsQ0FBb0Q7QUFDakVDLEVBQUFBLFdBQVcsQ0FBQztBQUFDQyxJQUFBQSxJQUFEO0FBQU8sT0FBR0M7QUFBVixHQUFELEVBQWtCO0FBQzNCLFVBQU1BLElBQU47QUFFQSxTQUFLRCxJQUFMLEdBQVlBLElBQVo7QUFDRDs7QUFFb0IsTUFBakJFLGlCQUFpQixHQUFHO0FBQ3RCLFdBQU8sS0FBS0YsSUFBTCxDQUFVRyxFQUFqQjtBQUNEOztBQUVZLE1BQVRDLFNBQVMsR0FBRztBQUNkLFdBQU8sS0FBS0osSUFBTCxDQUFVSyxJQUFqQjtBQUNEOztBQUVlLE1BQVpDLFlBQVksR0FBRztBQUNqQixXQUFPLFNBQVA7QUFDRDs7QUFFVyxNQUFSQyxRQUFRLEdBQUc7QUFDYixXQUFPLFFBQVA7QUFDRDs7QUFFVyxNQUFSQyxRQUFRLEdBQUc7QUFDYixXQUFPLEtBQUtSLElBQUwsQ0FBVVMsU0FBakI7QUFDRDs7QUFFaUIsUUFBWkMsWUFBWSxDQUFDRixRQUFELEVBQVdHLFFBQVgsRUFBcUI7QUFDckMsV0FBT0gsUUFBUSxJQUFJLElBQVosR0FBb0IsTUFBTUksZ0JBQU9DLFVBQVAsQ0FBa0IsS0FBS0MsT0FB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Li9kb3dubG9hZC1xdWVyeS1zZXF1ZW5jZSc7XG5pbXBvcnQgQ2xpZW50IGZyb20gJy4uLy4uL2FwaS9jbGllbnQnO1xuaW1wb3J0IFJlY29yZCBmcm9tICcuLi8uLi9tb2RlbHMvcmVjb3JkJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRG93bmxvYWRSZWNvcmRzIGV4dGVuZHMgRG93bmxvYWRRdWVyeVNlcXVlbmNlIHtcbiAgY29uc3RydWN0b3Ioe2Zvcm0sIC4uLmFyZ3N9KSB7XG4gICAgc3VwZXIoYXJncyk7XG5cbiAgICB0aGlzLmZvcm0gPSBmb3JtO1xuICB9XG5cbiAgZ2V0IHN5bmNSZXNvdXJjZVNjb3BlKCkge1xuICAgIHJldHVybiB0aGlzLmZvcm0uaWQ7XG4gIH1cblxuICBnZXQgc3luY0xhYmVsKCkge1xuICAgIHJldHVybiB0aGlzLmZvcm0ubmFtZTtcbiAgfVxuXG4gIGdldCByZXNvdXJjZU5hbWUoKSB7XG4gICAgcmV0dXJuICdyZWNvcmRzJztcbiAgfVxuXG4gIGdldCB0eXBlTmFtZSgpIHtcbiAgICByZXR1cm4gJ3JlY29yZCc7XG4gIH1cblxuICBnZXQgbGFzdFN5bmMoKSB7XG4gICAgcmV0dXJuIHRoaXMuZm9ybS5fbGFzdFN5bmM7XG4gIH1cblxuICBhc3luYyBmZXRjaE9iamVjdHMobGFzdFN5bmMsIHNlcXVlbmNlKSB7XG4gICAgcmV0dXJuIGxhc3RTeW5jID09IG51bGwgPyAoYXdhaXQgQ2xpZW50LmdldFJlY29yZHModGhpcy5hY2NvdW50LCB0aGlzLmZvcm0sIHNlcXVlbmNlLCB0aGlzLnBhZ2VTaXplKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IChhd2FpdCBDbGllbnQuZ2V0UmVjb3Jkc0hpc3RvcnkodGhpcy5hY2NvdW50LCB0aGlzLmZvcm0sIHNlcXVlbmNlLCB0aGlzLnBhZ2VTaXplKSk7XG4gIH1cblxuICBmaW5kT3JDcmVhdGUoZGF0YWJhc2UsIGF0dHJpYnV0ZXMpIHtcbiAgICByZXR1cm4gUmVjb3JkLmZpbmRPckNyZWF0ZShkYXRhYmFzZSwge2FjY291bnRfaWQ6IHRoaXMuYWNjb3VudC5yb3dJRCwgcmVzb3VyY2VfaWQ6IGF0dHJpYnV0ZXMuaWR9KTtcbiAgfVxuXG4gIGFzeW5jIHByb2Nlc3Mob2JqZWN0LCBhdHRyaWJ1dGVzKSB7XG4gICAgaWYgKGF0dHJpYnV0ZXMuaGlzdG9yeV9jaGFuZ2VfdHlwZSA9PT0gJ2QnKSB7XG4gICAgICBpZiAob2JqZWN0KSB7XG4gICAgICAgIG9iamVjdC5fZm9ybSA9IHRoaXMuZm9ybTtcbiAgICAgICAgb2JqZWN0Ll9mb3JtUm93SUQgPSB0aGlzLmZvcm0ucm93SUQ7XG5cbiAgICAgICAgYXdhaXQgb2JqZWN0LmRlbGV0ZSgpO1xuXG4gICAgICAgIHRoaXMuX2hhc0NoYW5nZXMgPSB0cnVlO1xuXG4gICAgICAgIGF3YWl0IHRoaXMudHJpZ2dlcigncmVjb3JkOmRlbGV0ZScsIHtyZWNvcmQ6IG9iamVjdH0pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBpc0NoYW5nZWQgPSAhb2JqZWN0LmlzUGVyc2lzdGVkIHx8IGF0dHJpYnV0ZXMudmVyc2lvbiAhPT0gb2JqZWN0LnZlcnNpb247XG5cbiAgICAgIG9iamVjdC51cGRhdGVGcm9tQVBJQXR0cmlidXRlcyhhdHRyaWJ1dGVzKTtcbiAgICAgIG9iamVjdC5fZm9ybSA9IHRoaXMuZm9ybTtcbiAgICAgIG9iamVjdC5fZm9ybVJvd0lEID0gdGhpcy5mb3JtLnJvd0lEO1xuXG4gICAgICB0aGlzLmZvcm0uX2xhc3RTeW5jID0gb2JqZWN0LnVwZGF0ZWRBdDtcblxuICAgICAgYXdhaXQgdGhpcy5sb29rdXAob2JqZWN0LCBhdHRyaWJ1dGVzLnByb2plY3RfaWQsICdfcHJvamVjdFJvd0lEJywgJ2dldFByb2plY3QnKTtcbiAgICAgIGF3YWl0IHRoaXMubG9va3VwKG9iamVjdCwgYXR0cmlidXRlcy5hc3NpZ25lZF90b19pZCwgJ19hc3NpZ25lZFRvUm93SUQnLCAnZ2V0VXNlcicpO1xuICAgICAgYXdhaXQgdGhpcy5sb29rdXAob2JqZWN0LCBhdHRyaWJ1dGVzLmNyZWF0ZWRfYnlfaWQsICdfY3JlYXRlZEJ5Um93SUQnLCAnZ2V0VXNlcicpO1xuICAgICAgYXdhaXQgdGhpcy5sb29rdXAob2JqZWN0LCBhdHRyaWJ1dGVzLnVwZGF0ZWRfYnlfaWQsICdfdXBkYXRlZEJ5Um93SUQnLCAnZ2V0VXNlcicpO1xuICAgICAgYXdhaXQgdGhpcy5sb29rdXAob2JqZWN0LCBhdHRyaWJ1dGVzLmNoYW5nZXNldF9pZCwgJ19jaGFuZ2VzZXRSb3dJRCcsICdnZXRDaGFuZ2VzZXQnKTtcblxuICAgICAgYXdhaXQgb2JqZWN0LnNhdmUoKTtcblxuICAgICAgaWYgKGlzQ2hhbmdlZCkge1xuICAgICAgICB0aGlzLl9oYXNDaGFuZ2VzID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5zeW5jaHJvbml6ZXIuaW5jcmVtZW50UmVjb3JkQ291bnQoKTtcbiAgICAgICAgYXdhaXQgdGhpcy50cmlnZ2VyKCdyZWNvcmQ6c2F2ZScsIHtyZWNvcmQ6IG9iamVjdH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZpbmlzaCgpIHtcbiAgICAvLyB1cGRhdGUgdGhlIGxhc3RTeW5jIGRhdGVcbiAgICBhd2FpdCB0aGlzLmZvcm0uc2F2ZSgpO1xuXG4gICAgaWYgKHRoaXMuX2hhc0NoYW5nZXMpIHtcbiAgICAgIGF3YWl0IHRoaXMudHJpZ2dlcigncmVjb3JkczpmaW5pc2gnLCB7Zm9ybTogdGhpcy5mb3JtfSk7XG4gICAgfVxuICB9XG5cbiAgYXR0cmlidXRlc0ZvclF1ZXJ5Um93KHJvdykge1xuICAgIGNvbnN0IGhhc0NyZWF0ZWRMb2NhdGlvbiA9XG4gICAgICByb3dbMjhdICE9IG51bGwgfHxcbiAgICAgIHJvd1syOV0gIT0gbnVsbCB8fFxuICAgICAgcm93WzMwXSAhPSBudWxsIHx8XG4gICAgICByb3dbMzFdICE9IG51bGw7XG5cbiAgICBjb25zdCBoYXNVcGRhdGVkTG9jYXRpb24gPVxuICAgICAgcm93WzMyXSAhPSBudWxsIHx8XG4gICAgICByb3dbMzNdICE9IG51bGwgfHxcbiAgICAgIHJvd1szNF0gIT0gbnVsbCB8fFxuICAgICAgcm93WzM1XSAhPSBudWxsO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1czogcm93WzBdLFxuICAgICAgdmVyc2lvbjogcm93WzFdLFxuICAgICAgaWQ6IHJvd1syXSxcbiAgICAgIGNyZWF0ZWRfYXQ6IHJvd1szXSxcbiAgICAgIHVwZGF0ZWRfYXQ6IHJvd1s0XSxcbiAgICAgIGNsaWVudF9jcmVhdGVkX2F0OiByb3dbNV0sXG4gICAgICBjbGllbnRfdXBkYXRlZF9hdDogcm93WzZdLFxuICAgICAgY3JlYXRlZF9ieV9pZDogcm93WzddLFxuICAgICAgdXBkYXRlZF9ieV9pZDogcm93WzhdLFxuICAgICAgZm9ybV9pZDogcm93WzldLFxuICAgICAgcHJvamVjdF9pZDogcm93WzEwXSxcbiAgICAgIGFzc2lnbmVkX3RvX2lkOiByb3dbMTFdLFxuICAgICAgZm9ybV92YWx1ZXM6IEpTT04ucGFyc2Uocm93WzEyXSksXG4gICAgICBsYXRpdHVkZTogcm93WzEzXSxcbiAgICAgIGxvbmdpdHVkZTogcm93WzE0XSxcbiAgICAgIGFsdGl0dWRlOiByb3dbMTVdLFxuICAgICAgc3BlZWQ6IHJvd1sxNl0sXG4gICAgICBjb3Vyc2U6IHJvd1sxN10sXG4gICAgICBob3Jpem9udGFsX2FjY3VyYWN5OiByb3dbMThdLFxuICAgICAgdmVydGljYWxfYWNjdXJhY3k6IHJvd1sxOV0sXG4gICAgICBlZGl0ZWRfZHVyYXRpb246IHJvd1syMF0sXG4gICAgICB1cGRhdGVkX2R1cmF0aW9uOiByb3dbMjFdLFxuICAgICAgY3JlYXRlZF9kdXJhdGlvbjogcm93WzIyXSxcbiAgICAgIGNyZWF0ZWRfYnk6IHJvd1syM10sXG4gICAgICB1cGRhdGVkX2J5OiByb3dbMjRdLFxuICAgICAgYXNzaWduZWRfdG86IHJvd1syNV0sXG4gICAgICBwcm9qZWN0OiByb3dbMjZdLFxuICAgICAgY2hhbmdlc2V0X2lkOiByb3dbMjddLFxuICAgICAgY3JlYXRlZF9sb2NhdGlvbjogaGFzQ3JlYXRlZExvY2F0aW9uICYmIHtcbiAgICAgICAgbGF0aXR1ZGU6IHJvd1syOF0sXG4gICAgICAgIGxvbmdpdHVkZTogcm93WzI5XSxcbiAgICAgICAgYWx0aXR1ZGU6IHJvd1szMF0sXG4gICAgICAgIGhvcml6b250YWxfYWNjdXJhY3k6IHJvd1szMV1cbiAgICAgIH0sXG4gICAgICB1cGRhdGVkX2xvY2F0aW9uOiBoYXNVcGRhdGVkTG9jYXRpb24gJiYge1xuICAgICAgICBsYXRpdHVkZTogcm93WzMyXSxcbiAgICAgICAgbG9uZ2l0dWRlOiByb3dbMzNdLFxuICAgICAgICBhbHRpdHVkZTogcm93WzM0XSxcbiAgICAgICAgaG9yaXpvbnRhbF9hY2N1cmFjeTogcm93WzM1XVxuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBnZW5lcmF0ZVF1ZXJ5KHNlcXVlbmNlLCBsaW1pdCkge1xuICAgIGNvbnN0IHNlcXVlbmNlU3RyaW5nID0gbmV3IERhdGUoK3NlcXVlbmNlKS50b0lTT1N0cmluZygpO1xuXG4gICAgcmV0dXJuIGBcblNFTEVDVFxuICBcIl9zdGF0dXNcIiBBUyBcInN0YXR1c1wiLFxuICBcIl92ZXJzaW9uXCIgQVMgXCJ2ZXJzaW9uXCIsXG4gIFwiX3JlY29yZF9pZFwiIEFTIFwiaWRcIixcbiAgdG9fY2hhcihwZ19jYXRhbG9nLnRpbWV6b25lKCdVVEMnLCBcIl9zZXJ2ZXJfY3JlYXRlZF9hdFwiKSwgJ1lZWVktTU0tRERcIlRcIkhIMjQ6TUk6U1NcIlpcIicpIEFTIFwiY3JlYXRlZF9hdFwiLFxuICB0b19jaGFyKHBnX2NhdGFsb2cudGltZXpvbmUoJ1VUQycsIFwiX3NlcnZlcl91cGRhdGVkX2F0XCIpLCAnWVlZWS1NTS1ERFwiVFwiSEgyNDpNSTpTU1wiWlwiJykgQVMgXCJ1cGRhdGVkX2F0XCIsXG4gIHRvX2NoYXIocGdfY2F0YWxvZy50aW1lem9uZSgnVVRDJywgXCJfY3JlYXRlZF9hdFwiKSwgJ1lZWVktTU0tRERcIlRcIkhIMjQ6TUk6U1NcIlpcIicpIEFTIFwiY2xpZW50X2NyZWF0ZWRfYXRcIixcbiAgdG9fY2hhcihwZ19jYXRhbG9nLnRpbWV6b25lKCdVVEMnLCBcIl91cGRhdGVkX2F0XCIpLCAnWVlZWS1NTS1ERFwiVFwiSEgyNDpNSTpTU1wiWlwiJykgQVMgXCJjbGllbnRfdXBkYXRlZF9hdFwiLFxuICBcIl9jcmVhdGVkX2J5X2lkXCIgQVMgXCJjcmVhdGVkX2J5X2lkXCIsXG4gIFwiX3VwZGF0ZWRfYnlfaWRcIiBBUyBcInVwZGF0ZWRfYnlfaWRcIixcbiAgJyR7IHRoaXMuZm9ybS5pZCB9Jzo6dGV4dCBBUyBcImZvcm1faWRcIixcbiAgXCJfcHJvamVjdF9pZFwiIEFTIFwicHJvamVjdF9pZFwiLFxuICBcIl9hc3NpZ25lZF90b19pZFwiIEFTIFwiYXNzaWduZWRfdG9faWRcIixcbiAgXCJfZm9ybV92YWx1ZXNcIiBBUyBcImZvcm1fdmFsdWVzXCIsXG4gIFwiX2xhdGl0dWRlXCIgQVMgXCJsYXRpdHVkZVwiLFxuICBcIl9sb25naXR1ZGVcIiBBUyBcImxvbmdpdHVkZVwiLFxuICBcIl9hbHRpdHVkZVwiIEFTIFwiYWx0aXR1ZGVcIixcbiAgXCJfc3BlZWRcIiBBUyBcInNwZWVkXCIsXG4gIFwiX2NvdXJzZVwiIEFTIFwiY291cnNlXCIsXG4gIFwiX2hvcml6b250YWxfYWNjdXJhY3lcIiBBUyBcImhvcml6b250YWxfYWNjdXJhY3lcIixcbiAgXCJfdmVydGljYWxfYWNjdXJhY3lcIiBBUyBcInZlcnRpY2FsX2FjY3VyYWN5XCIsXG4gIFwiX2VkaXRlZF9kdXJhdGlvblwiIEFTIFwiZWRpdGVkX2R1cmF0aW9uXCIsXG4gIFwiX3VwZGF0ZWRfZHVyYXRpb25cIiBBUyBcInVwZGF0ZWRfZHVyYXRpb25cIixcbiAgXCJfY3JlYXRlZF9kdXJhdGlvblwiIEFTIFwiY3JlYXRlZF9kdXJhdGlvblwiLFxuICBOVUxMIEFTIFwiY3JlYXRlZF9ieVwiLFxuICBOVUxMIEFTIFwidXBkYXRlZF9ieVwiLFxuICBOVUxMIEFTIFwiYXNzaWduZWRfdG9cIixcbiAgTlVMTCBBUyBcInByb2plY3RcIixcbiAgXCJfY2hhbmdlc2V0X2lkXCIgQVMgXCJjaGFuZ2VzZXRfaWRcIixcbiAgXCJfY3JlYXRlZF9sYXRpdHVkZVwiIEFTIFwiY3JlYXRlZF9sYXRpdHVkZVwiLFxuICBcIl9jcmVhdGVkX2xvbmdpdHVkZVwiIEFTIFwiY3JlYXRlZF9sb25naXR1ZGVcIixcbiAgXCJfY3JlYXRlZF9hbHRpdHVkZVwiIEFTIFwiY3JlYXRlZF9hbHRpdHVkZVwiLFxuICBcIl9jcmVhdGVkX2hvcml6b250YWxfYWNjdXJhY3lcIiBBUyBcImNyZWF0ZWRfaG9yaXpvbnRhbF9hY2N1cmFjeVwiLFxuICBcIl91cGRhdGVkX2xhdGl0dWRlXCIgQVMgXCJ1cGRhdGVkX2xhdGl0dWRlXCIsXG4gIFwiX3VwZGF0ZWRfbG9uZ2l0dWRlXCIgQVMgXCJ1cGRhdGVkX2xvbmdpdHVkZVwiLFxuICBcIl91cGRhdGVkX2FsdGl0dWRlXCIgQVMgXCJ1cGRhdGVkX2FsdGl0dWRlXCIsXG4gIFwiX3VwZGF0ZWRfaG9yaXpvbnRhbF9hY2N1cmFjeVwiIEFTIFwidXBkYXRlZF9ob3Jpem9udGFsX2FjY3VyYWN5XCJcbkZST00gXCIkeyB0aGlzLmZvcm0uaWQgfS9fZnVsbFwiIEFTIFwicmVjb3Jkc1wiXG5XSEVSRVxuICBfc2VydmVyX3VwZGF0ZWRfYXQgPiAnJHtzZXF1ZW5jZVN0cmluZ30nXG5PUkRFUiBCWVxuICBfc2VydmVyX3VwZGF0ZWRfYXQgQVNDXG5MSU1JVCAke2xpbWl0fSBPRkZTRVQgMFxuYDtcbiAgfVxufVxuIl19
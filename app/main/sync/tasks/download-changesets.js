"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _downloadQuerySequence = _interopRequireDefault(require("./download-query-sequence"));

var _changeset = _interopRequireDefault(require("../../models/changeset"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class DownloadChangesets extends _downloadQuerySequence.default {
  get resourceName() {
    return 'changesets';
  }

  get typeName() {
    return 'changeset';
  }

  get lastSync() {
    return this.account._lastSyncChangesets;
  }

  get useRestAPI() {
    return false;
  }

  findOrCreate(database, attributes) {
    return _changeset.default.findOrCreate(database, {
      account_id: this.account.rowID,
      resource_id: attributes.id
    });
  }

  async loadObject(object, attributes) {
    await this.lookup(object, attributes.form_id, '_formRowID', 'getForm');
    await this.lookup(object, attributes.closed_by_id, '_closedByRowID', 'getUser');
    await this.lookup(object, attributes.created_by_id, '_createdByRowID', 'getUser');
    this.account._lastSyncChangesets = object._updatedAt;
  }

  attributesForQueryRow(row) {
    return {
      id: row[0],
      created_at: row[1],
      updated_at: row[2],
      closed_at: row[3],
      metadata: row[4] && JSON.parse(row[4]),
      min_lat: row[5],
      max_lat: row[6],
      min_lon: row[7],
      max_lon: row[8],
      number_of_changes: row[9],
      number_created: row[10],
      number_updated: row[11],
      number_deleted: row[12],
      form_id: row[13],
      created_by_id: row[14],
      updated_by_id: row[15],
      closed_by_id: row[16],
      created_by: row[17],
      updated_by: row[18],
      closed_by: row[19]
    };
  }

  generateQuery(sequence, limit) {
    const sequenceString = new Date(+sequence).toISOString();
    return `
SELECT
  "changeset_id" AS "id",
  to_char(pg_catalog.timezone('UTC', "records"."created_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "created_at",
  to_char(pg_catalog.timezone('UTC', "records"."updated_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "updated_at",
  to_char(pg_catalog.timezone('UTC', "records"."closed_at"), 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS "closed_at",
  "metadata" AS "metadata",
  "min_lat" AS min_lat,
  "max_lat" AS max_lat,
  "min_lon" AS min_lon,
  "max_lon" AS max_lon,
  "number_of_changes" AS number_of_changes,
  "number_of_creates" AS number_created,
  "number_of_updates" AS number_updated,
  "number_of_deletes" AS number_deleted,
  "form_id" AS form_id,
  "created_by_id" AS "created_by_id",
  "updated_by_id" AS "updated_by_id",
  "closed_by_id" AS "closed_by_id",
  NULL AS "created_by",
  NULL AS "updated_by",
  NULL AS "closed_by"
FROM "changesets" AS "records"
WHERE
  "records".updated_at > '${sequenceString}'
ORDER BY
  "records".updated_at ASC
LIMIT ${limit} OFFSET 0
`;
  }

}

exports.default = DownloadChangesets;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tYWluL3N5bmMvdGFza3MvZG93bmxvYWQtY2hhbmdlc2V0cy5qcyJdLCJuYW1lcyI6WyJEb3dubG9hZENoYW5nZXNldHMiLCJEb3dubG9hZFF1ZXJ5U2VxdWVuY2UiLCJyZXNvdXJjZU5hbWUiLCJ0eXBlTmFtZSIsImxhc3RTeW5jIiwiYWNjb3VudCIsIl9sYXN0U3luY0NoYW5nZXNldHMiLCJ1c2VSZXN0QVBJIiwiZmluZE9yQ3JlYXRlIiwiZGF0YWJhc2UiLCJhdHRyaWJ1dGVzIiwiQ2hhbmdlc2V0IiwiYWNjb3VudF9pZCIsInJvd0lEIiwicmVzb3VyY2VfaWQiLCJpZCIsImxvYWRPYmplY3QiLCJvYmplY3QiLCJsb29rdXAiLCJmb3JtX2lkIiwiY2xvc2VkX2J5X2lkIiwiY3JlYXRlZF9ieV9pZCIsIl91cGRhdGVkQXQiLCJhdHRyaWJ1dGVzRm9yUXVlcnlSb3ciLCJyb3ciLCJjcmVhdGVkX2F0IiwidXBkYXRlZF9hdCIsImNsb3NlZF9hdCIsIm1ldGFkYXRhIiwiSlNPTiIsInBhcnNlIiwibWluX2xhdCIsIm1heF9sYXQiLCJtaW5fbG9uIiwibWF4X2xvbiIsIm51bWJlcl9vZl9jaGFuZ2VzIiwibnVtYmVyX2NyZWF0ZWQiLCJudW1iZXJfdXBkYXRlZCIsIm51bWJlcl9kZWxldGVkIiwidXBkYXRlZF9ieV9pZCIsImNyZWF0ZWRfYnkiLCJ1cGRhdGVkX2J5IiwiY2xvc2VkX2J5IiwiZ2VuZXJhdGVRdWVyeSIsInNlcXVlbmNlIiwibGltaXQiLCJzZXF1ZW5jZVN0cmluZyIsIkRhdGUiLCJ0b0lTT1N0cmluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOzs7O0FBRWUsTUFBTUEsa0JBQU4sU0FBaUNDLDhCQUFqQyxDQUF1RDtBQUNwRCxNQUFaQyxZQUFZLEdBQUc7QUFDakIsV0FBTyxZQUFQO0FBQ0Q7O0FBRVcsTUFBUkMsUUFBUSxHQUFHO0FBQ2IsV0FBTyxXQUFQO0FBQ0Q7O0FBRVcsTUFBUkMsUUFBUSxH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QTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNEJBQTRCRixjQUFlO0FBQzNDO0FBQ0E7QUFDQSxRQUFRRCxLQUFNO0FBQ2QsQ0E1Qkk7QUE2QkQ7O0FBdEZtRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBEb3dubG9hZFF1ZXJ5U2VxdWVuY2UgZnJvbSAnLi9kb3dubG9hZC1xdWVyeS1zZXF1ZW5jZSc7XG5pbXBvcnQgQ2hhbmdlc2V0IGZyb20gJy4uLy4uL21vZGVscy9jaGFuZ2VzZXQnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEb3dubG9hZENoYW5nZXNldHMgZXh0ZW5kcyBEb3dubG9hZFF1ZXJ5U2VxdWVuY2Uge1xuICBnZXQgcmVzb3VyY2VOYW1lKCkge1xuICAgIHJldHVybiAnY2hhbmdlc2V0cyc7XG4gIH1cblxuICBnZXQgdHlwZU5hbWUoKSB7XG4gICAgcmV0dXJuICdjaGFuZ2VzZXQnO1xuICB9XG5cbiAgZ2V0IGxhc3RTeW5jKCkge1xuICAgIHJldHVybiB0aGlzLmFjY291bnQuX2xhc3RTeW5jQ2hhbmdlc2V0cztcbiAgfVxuXG4gIGdldCB1c2VSZXN0QVBJKCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGZpbmRPckNyZWF0ZShkYXRhYmFzZSwgYXR0cmlidXRlcykge1xuICAgIHJldHVybiBDaGFuZ2VzZXQuZmluZE9yQ3JlYXRlKGRhdGFiYXNlLCB7YWNjb3VudF9pZDogdGhpcy5hY2NvdW50LnJvd0lELCByZXNvdXJjZV9pZDogYXR0cmlidXRlcy5pZH0pO1xuICB9XG5cbiAgYXN5bmMgbG9hZE9iamVjdChvYmplY3QsIGF0dHJpYnV0ZXMpIHtcbiAgICBhd2FpdCB0aGlzLmxvb2t1cChvYmplY3QsIGF0dHJpYnV0ZXMuZm9ybV9pZCwgJ19mb3JtUm93SUQnLCAnZ2V0Rm9ybScpO1xuICAgIGF3YWl0IHRoaXMubG9va3VwKG9iamVjdCwgYXR0cmlidXRlcy5jbG9zZWRfYnlfaWQsICdfY2xvc2VkQnlSb3dJRCcsICdnZXRVc2VyJyk7XG4gICAgYXdhaXQgdGhpcy5sb29rdXAob2JqZWN0LCBhdHRyaWJ1dGVzLmNyZWF0ZWRfYnlfaWQsICdfY3JlYXRlZEJ5Um93SUQnLCAnZ2V0VXNlcicpO1xuXG4gICAgdGhpcy5hY2NvdW50Ll9sYXN0U3luY0NoYW5nZXNldHMgPSBvYmplY3QuX3VwZGF0ZWRBdDtcbiAgfVxuXG4gIGF0dHJpYnV0ZXNGb3JRdWVyeVJvdyhyb3cpIHtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHJvd1swXSxcbiAgICAgIGNyZWF0ZWRfYXQ6IHJvd1sxXSxcbiAgICAgIHVwZGF0ZWRfYXQ6IHJvd1syXSxcbiAgICAgIGNsb3NlZF9hdDogcm93WzNdLFxuICAgICAgbWV0YWRhdGE6IHJvd1s0XSAmJiBKU09OLnBhcnNlKHJvd1s0XSksXG4gICAgICBtaW5fbGF0OiByb3dbNV0sXG4gICAgICBtYXhfbGF0OiByb3dbNl0sXG4gICAgICBtaW5fbG9uOiByb3dbN10sXG4gICAgICBtYXhfbG9uOiByb3dbOF0sXG4gICAgICBudW1iZXJfb2ZfY2hhbmdlczogcm93WzldLFxuICAgICAgbnVtYmVyX2NyZWF0ZWQ6IHJvd1sxMF0sXG4gICAgICBudW1iZXJfdXBkYXRlZDogcm93WzExXSxcbiAgICAgIG51bWJlcl9kZWxldGVkOiByb3dbMTJdLFxuICAgICAgZm9ybV9pZDogcm93WzEzXSxcbiAgICAgIGNyZWF0ZWRfYnlfaWQ6IHJvd1sxNF0sXG4gICAgICB1cGRhdGVkX2J5X2lkOiByb3dbMTVdLFxuICAgICAgY2xvc2VkX2J5X2lkOiByb3dbMTZdLFxuICAgICAgY3JlYXRlZF9ieTogcm93WzE3XSxcbiAgICAgIHVwZGF0ZWRfYnk6IHJvd1sxOF0sXG4gICAgICBjbG9zZWRfYnk6IHJvd1sxOV1cbiAgICB9O1xuICB9XG5cbiAgZ2VuZXJhdGVRdWVyeShzZXF1ZW5jZSwgbGltaXQpIHtcbiAgICBjb25zdCBzZXF1ZW5jZVN0cmluZyA9IG5ldyBEYXRlKCtzZXF1ZW5jZSkudG9JU09TdHJpbmcoKTtcblxuICAgIHJldHVybiBgXG5TRUxFQ1RcbiAgXCJjaGFuZ2VzZXRfaWRcIiBBUyBcImlkXCIsXG4gIHRvX2NoYXIocGdfY2F0YWxvZy50aW1lem9uZSgnVVRDJywgXCJyZWNvcmRzXCIuXCJjcmVhdGVkX2F0XCIpLCAnWVlZWS1NTS1ERFwiVFwiSEgyNDpNSTpTU1wiWlwiJykgQVMgXCJjcmVhdGVkX2F0XCIsXG4gIHRvX2NoYXIocGdfY2F0YWxvZy50aW1lem9uZSgnVVRDJywgXCJyZWNvcmRzXCIuXCJ1cGRhdGVkX2F0XCIpLCAnWVlZWS1NTS1ERFwiVFwiSEgyNDpNSTpTU1wiWlwiJykgQVMgXCJ1cGRhdGVkX2F0XCIsXG4gIHRvX2NoYXIocGdfY2F0YWxvZy50aW1lem9uZSgnVVRDJywgXCJyZWNvcmRzXCIuXCJjbG9zZWRfYXRcIiksICdZWVlZLU1NLUREXCJUXCJISDI0Ok1JOlNTXCJaXCInKSBBUyBcImNsb3NlZF9hdFwiLFxuICBcIm1ldGFkYXRhXCIgQVMgXCJtZXRhZGF0YVwiLFxuICBcIm1pbl9sYXRcIiBBUyBtaW5fbGF0LFxuICBcIm1heF9sYXRcIiBBUyBtYXhfbGF0LFxuICBcIm1pbl9sb25cIiBBUyBtaW5fbG9uLFxuICBcIm1heF9sb25cIiBBUyBtYXhfbG9uLFxuICBcIm51bWJlcl9vZl9jaGFuZ2VzXCIgQVMgbnVtYmVyX29mX2NoYW5nZXMsXG4gIFwibnVtYmVyX29mX2NyZWF0ZXNcIiBBUyBudW1iZXJfY3JlYXRlZCxcbiAgXCJudW1iZXJfb2ZfdXBkYXRlc1wiIEFTIG51bWJlcl91cGRhdGVkLFxuICBcIm51bWJlcl9vZl9kZWxldGVzXCIgQVMgbnVtYmVyX2RlbGV0ZWQsXG4gIFwiZm9ybV9pZFwiIEFTIGZvcm1faWQsXG4gIFwiY3JlYXRlZF9ieV9pZFwiIEFTIFwiY3JlYXRlZF9ieV9pZFwiLFxuICBcInVwZGF0ZWRfYnlfaWRcIiBBUyBcInVwZGF0ZWRfYnlfaWRcIixcbiAgXCJjbG9zZWRfYnlfaWRcIiBBUyBcImNsb3NlZF9ieV9pZFwiLFxuICBOVUxMIEFTIFwiY3JlYXRlZF9ieVwiLFxuICBOVUxMIEFTIFwidXBkYXRlZF9ieVwiLFxuICBOVUxMIEFTIFwiY2xvc2VkX2J5XCJcbkZST00gXCJjaGFuZ2VzZXRzXCIgQVMgXCJyZWNvcmRzXCJcbldIRVJFXG4gIFwicmVjb3Jkc1wiLnVwZGF0ZWRfYXQgPiAnJHtzZXF1ZW5jZVN0cmluZ30nXG5PUkRFUiBCWVxuICBcInJlY29yZHNcIi51cGRhdGVkX2F0IEFTQ1xuTElNSVQgJHtsaW1pdH0gT0ZGU0VUIDBcbmA7XG4gIH1cbn1cbiJdfQ==
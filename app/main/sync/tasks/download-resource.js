"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _task = _interopRequireDefault(require("./task"));

var _fulcrumCore = require("fulcrum-core");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const PAGE_SIZE = 500;

class DownloadResource extends _task.default {
  get syncResourceName() {
    return this.resourceName;
  }

  get pageSize() {
    return PAGE_SIZE;
  }

  get syncResourceScope() {
    return null;
  }

  get resourceName() {
    throw new Error('must implement resourceName');
  }

  get typeName() {
    throw new Error('must implement typeName');
  }

  get propertyName() {
    return this.typeName;
  }

  get syncLabel() {
    return this.resourceName.replace('_', ' ');
  }

  fetchObjects(lastSync, sequence) {
    throw new Error('must implement fetchObjects');
  }

  fetchLocalObjects() {
    throw new Error('must implement fetchLocalObjects');
  }

  findOrCreate(database, attributes) {
    throw new Error('must implement findOrCreate');
  }

  loadObject(object, attributes) {}

  async process(object, attributes) {
    const isChanged = !object.isPersisted || _fulcrumCore.DateUtils.parseISOTimestamp(attributes.updated_at).getTime() !== object.updatedAt.getTime();
    object.updateFromAPIAttributes(attributes);

    if (object._deletedAt != null) {
      object._deletedAt = null;
    }

    await this.loadObject(object, attributes);
    await object.save();

    if (isChanged) {
      await this.triggerEvent('save', {
        [this.propertyName]: object
      });
    }
  }

  triggerEvent(name, args) {
    return this.trigger(`${this.typeName}:${name}`, args);
  }

  fail(account, results) {
    fulcrum.logger.log(account.organizationName.green, 'failed'.red);
  }

  async run({
    dataSource
  }) {
    const sync = await this.checkSyncState();

    if (!sync.needsUpdate) {
      return;
    }

    this.progress({
      message: this.downloading + ' ' + this.syncLabel
    });
    const response = await this.fetchObjects();
    const objects = JSON.parse(response.body)[this.resourceName];
    this.progress({
      message: this.processing + ' ' + this.syncLabel,
      count: 0,
      total: objects.length
    });
    const localObjects = await this.fetchLocalObjects();
    this.markDeletedObjects(localObjects, objects, this.typeName, this.propertyName);

    for (let index = 0; index < objects.length; ++index) {
      const attributes = objects[index];
      const object = await this.findOrCreate(this.account.db, attributes);
      await this.process(object, attributes);
      this.progress({
        message: this.processing + ' ' + this.syncLabel,
        count: index + 1,
        total: objects.length
      });
    }

    await sync.update();
    dataSource.source.invalidate(this.resourceName);
    this.progress({
      message: this.finished + ' ' + this.syncLabel,
      count: objects.length,
      total: objects.length
    });
  }

}

exports.default = DownloadResource;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tYWluL3N5bmMvdGFza3MvZG93bmxvYWQtcmVzb3VyY2UuanMiXSwibmFtZXMiOlsiUEFHRV9TSVpFIiwiRG93bmxvYWRSZXNvdXJjZSIsIlRhc2siLCJzeW5jUmVzb3VyY2VOYW1lIiwicmVzb3VyY2VOYW1lIiwicGFnZVNpemUiLCJzeW5jUmVzb3VyY2VTY29wZSIsIkVycm9yIiwidHlwZU5hbWUiLCJwcm9wZXJ0eU5hbWUiLCJzeW5jTGFiZWwiLCJyZXBsYWNlIiwiZmV0Y2hPYmplY3RzIiwibGFzdFN5bmMiLCJzZXF1ZW5jZSIsImZldGNoTG9jYWxPYmplY3RzIiwiZmluZE9yQ3JlYXRlIiwiZGF0YWJhc2UiLCJhdHRyaWJ1dGVzIiwibG9hZE9iamVjdCIsIm9iamVjdCIsInByb2Nlc3MiLCJpc0NoYW5nZWQiLCJpc1BlcnNpc3RlZCIsIkRhdGVVdGlscyIsInBhcnNlSVNPVGltZXN0YW1wIiwidXBkYXRlZF9hdCIsImdldFRpbWUiLCJ1cGRhdGVkQXQiLCJ1cGRhdGVGcm9tQVBJQXR0cmlidXRlcyIsIl9kZWxldGVkQXQiLCJzYXZlIiwidHJpZ2dlckV2ZW50IiwibmFtZSIsImFyZ3MiLCJ0cmlnZ2VyIiwiZmFpbCIsImFjY291bnQiLCJyZXN1bHRzIiwiZnVsY3J1bSIsImxvZ2dlciIsImxvZyIsIm9yZ2FuaXphdGlvbk5hbWUiLCJncmVlbiIsInJlZCIsInJ1biIsImRhdGFTb3VyY2UiLCJzeW5jIiwiY2hlY2tTeW5jU3RhdGUiLCJuZWVkc1VwZGF0ZSIsInByb2dyZXNzIiwibWVzc2FnZSIsImRvd25sb2FkaW5nIiwicmVzcG9uc2UiLCJvYmplY3RzIiwiSlNPTiIsInBhcnNlIiwiYm9keSIsInByb2Nlc3NpbmciLCJjb3VudCIsInRvdGFsIiwibGVuZ3RoIiwibG9jYWxPYmplY3RzIiwibWFya0RlbGV0ZWRPYmplY3RzIiwiaW5kZXgiLCJkYiIsInVwZGF0ZSIsInNvdXJjZSIsImludmFsaWRhdGUiLCJmaW5pc2hl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Q087QUFBbkYsT0FBZDtBQUNEOztBQUVELFVBQU1kLElBQUksQ0FBQ21CLE1BQUwsRUFBTjtBQUVBcEIsSUFBQUEsVUFBVSxDQUFDcUIsTUFBWCxDQUFrQkMsVUFBbEIsQ0FBNkIsS0FBS2hFLFlBQWxDO0FBRUEsU0FBSzhDLFFBQUwsQ0FBYztBQUFDQyxNQUFBQSxPQUFPLEVBQUUsS0FBS2tCLFFBQUwsR0FBZ0IsR0FBaEIsR0FBc0IsS0FBSzNELFNBQXJDO0FBQWdEaUQsTUFBQUEsS0FBSyxFQUFFTCxPQUFPLENBQUNPLE1BQS9EO0FBQXVFRCxNQUFBQSxLQUFLLEVBQUVOLE9BQU8sQ0FBQ087QUFBdEYsS0FBZDtBQUNEOztBQXpHZ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVGFzayBmcm9tICcuL3Rhc2snO1xuaW1wb3J0IHsgRGF0ZVV0aWxzIH0gZnJvbSAnZnVsY3J1bS1jb3JlJztcblxuY29uc3QgUEFHRV9TSVpFID0gNTAwO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEb3dubG9hZFJlc291cmNlIGV4dGVuZHMgVGFzayB7XG4gIGdldCBzeW5jUmVzb3VyY2VOYW1lKCkge1xuICAgIHJldHVybiB0aGlzLnJlc291cmNlTmFtZTtcbiAgfVxuXG4gIGdldCBwYWdlU2l6ZSgpIHtcbiAgICByZXR1cm4gUEFHRV9TSVpFO1xuICB9XG5cbiAgZ2V0IHN5bmNSZXNvdXJjZVNjb3BlKCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZ2V0IHJlc291cmNlTmFtZSgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ211c3QgaW1wbGVtZW50IHJlc291cmNlTmFtZScpO1xuICB9XG5cbiAgZ2V0IHR5cGVOYW1lKCkge1xuICAgIHRocm93IG5ldyBFcnJvcignbXVzdCBpbXBsZW1lbnQgdHlwZU5hbWUnKTtcbiAgfVxuXG4gIGdldCBwcm9wZXJ0eU5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMudHlwZU5hbWU7XG4gIH1cblxuICBnZXQgc3luY0xhYmVsKCkge1xuICAgIHJldHVybiB0aGlzLnJlc291cmNlTmFtZS5yZXBsYWNlKCdfJywgJyAnKTtcbiAgfVxuXG4gIGZldGNoT2JqZWN0cyhsYXN0U3luYywgc2VxdWVuY2UpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ211c3QgaW1wbGVtZW50IGZldGNoT2JqZWN0cycpO1xuICB9XG5cbiAgZmV0Y2hMb2NhbE9iamVjdHMoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdtdXN0IGltcGxlbWVudCBmZXRjaExvY2FsT2JqZWN0cycpO1xuICB9XG5cbiAgZmluZE9yQ3JlYXRlKGRhdGFiYXNlLCBhdHRyaWJ1dGVzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdtdXN0IGltcGxlbWVudCBmaW5kT3JDcmVhdGUnKTtcbiAgfVxuXG4gIGxvYWRPYmplY3Qob2JqZWN0LCBhdHRyaWJ1dGVzKSB7XG4gIH1cblxuICBhc3luYyBwcm9jZXNzKG9iamVjdCwgYXR0cmlidXRlcykge1xuICAgIGNvbnN0IGlzQ2hhbmdlZCA9ICFvYmplY3QuaXNQZXJzaXN0ZWQgfHxcbiAgICAgICAgICAgICAgICAgICAgICBEYXRlVXRpbHMucGFyc2VJU09UaW1lc3RhbXAoYXR0cmlidXRlcy51cGRhdGVkX2F0KS5nZXRUaW1lKCkgIT09IG9iamVjdC51cGRhdGVkQXQuZ2V0VGltZSgpO1xuXG4gICAgb2JqZWN0LnVwZGF0ZUZyb21BUElBdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpO1xuXG4gICAgaWYgKG9iamVjdC5fZGVsZXRlZEF0ICE9IG51bGwpIHtcbiAgICAgIG9iamVjdC5fZGVsZXRlZEF0ID0gbnVsbDtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmxvYWRPYmplY3Qob2JqZWN0LCBhdHRyaWJ1dGVzKTtcblxuICAgIGF3YWl0IG9iamVjdC5zYXZlKCk7XG5cbiAgICBpZiAoaXNDaGFuZ2VkKSB7XG4gICAgICBhd2FpdCB0aGlzLnRyaWdnZXJFdmVudCgnc2F2ZScsIHtbdGhpcy5wcm9wZXJ0eU5hbWVdOiBvYmplY3R9KTtcbiAgICB9XG4gIH1cblxuICB0cmlnZ2VyRXZlbnQobmFtZSwgYXJncykge1xuICAgIHJldHVybiB0aGlzLnRyaWdnZXIoYCR7IHRoaXMudHlwZU5hbWUgfTokeyBuYW1lIH1gLCBhcmdzKTtcbiAgfVxuXG4gIGZhaWwoYWNjb3VudCwgcmVzdWx0cykge1xuICAgIGZ1bGNydW0ubG9nZ2VyLmxvZyhhY2NvdW50Lm9yZ2FuaXphdGlvbk5hbWUuZ3JlZW4sICdmYWlsZWQnLnJlZCk7XG4gIH1cblxuICBhc3luYyBydW4oe2RhdGFTb3VyY2V9KSB7XG4gICAgY29uc3Qgc3luYyA9IGF3YWl0IHRoaXMuY2hlY2tTeW5jU3RhdGUoKTtcblxuICAgIGlmICghc3luYy5uZWVkc1VwZGF0ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMuZG93bmxvYWRpbmcgKyAnICcgKyB0aGlzLnN5bmNMYWJlbH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmZldGNoT2JqZWN0cygpO1xuXG4gICAgY29uc3Qgb2JqZWN0cyA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSlbdGhpcy5yZXNvdXJjZU5hbWVdO1xuXG4gICAgdGhpcy5wcm9ncmVzcyh7bWVzc2FnZTogdGhpcy5wcm9jZXNzaW5nICsgJyAnICsgdGhpcy5zeW5jTGFiZWwsIGNvdW50OiAwLCB0b3RhbDogb2JqZWN0cy5sZW5ndGh9KTtcblxuICAgIGNvbnN0IGxvY2FsT2JqZWN0cyA9IGF3YWl0IHRoaXMuZmV0Y2hMb2NhbE9iamVjdHMoKTtcblxuICAgIHRoaXMubWFya0RlbGV0ZWRPYmplY3RzKGxvY2FsT2JqZWN0cywgb2JqZWN0cywgdGhpcy50eXBlTmFtZSwgdGhpcy5wcm9wZXJ0eU5hbWUpO1xuXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IG9iamVjdHMubGVuZ3RoOyArK2luZGV4KSB7XG4gICAgICBjb25zdCBhdHRyaWJ1dGVzID0gb2JqZWN0c1tpbmRleF07XG5cbiAgICAgIGNvbnN0IG9iamVjdCA9IGF3YWl0IHRoaXMuZmluZE9yQ3JlYXRlKHRoaXMuYWNjb3VudC5kYiwgYXR0cmlidXRlcyk7XG5cbiAgICAgIGF3YWl0IHRoaXMucHJvY2VzcyhvYmplY3QsIGF0dHJpYnV0ZXMpO1xuXG4gICAgICB0aGlzLnByb2dyZXNzKHttZXNzYWdlOiB0aGlzLnByb2Nlc3NpbmcgKyAnICcgKyB0aGlzLnN5bmNMYWJlbCwgY291bnQ6IGluZGV4ICsgMSwgdG90YWw6IG9iamVjdHMubGVuZ3RofSk7XG4gICAgfVxuXG4gICAgYXdhaXQgc3luYy51cGRhdGUoKTtcblxuICAgIGRhdGFTb3VyY2Uuc291cmNlLmludmFsaWRhdGUodGhpcy5yZXNvdXJjZU5hbWUpO1xuXG4gICAgdGhpcy5wcm9ncmVzcyh7bWVzc2FnZTogdGhpcy5maW5pc2hlZCArICcgJyArIHRoaXMuc3luY0xhYmVsLCBjb3VudDogb2JqZWN0cy5sZW5ndGgsIHRvdGFsOiBvYmplY3RzLmxlbmd0aH0pO1xuICB9XG59XG4iXX0=
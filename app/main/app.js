"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _glob = _interopRequireDefault(require("glob"));

var _path = _interopRequireDefault(require("path"));

var _yargs = _interopRequireDefault(require("yargs"));

var _mkdirp = _interopRequireDefault(require("mkdirp"));

var _os = _interopRequireDefault(require("os"));

var _database = _interopRequireDefault(require("./db/database"));

var _api = _interopRequireDefault(require("./api"));

var _environment = _interopRequireDefault(require("./environment"));

var _account = _interopRequireDefault(require("./models/account"));

var _localDatabaseDataSource = _interopRequireDefault(require("./local-database-data-source"));

var _fulcrumCore = require("fulcrum-core");

var _applicationPaths = _interopRequireDefault(require("../application-paths"));

var _pluginLogger = _interopRequireDefault(require("./plugin-logger"));

var _logger = _interopRequireDefault(require("./logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let app = null;

class App {
  static get instance() {
    return app;
  }

  constructor() {
    this._plugins = [];
    this._pluginsByName = [];
    this._listeners = {};
    this._api = _api.default;
    const pathOverride = this.args.homePath;
    this._appPath = pathOverride || _applicationPaths.default.userData;
    this._homePath = pathOverride || _path.default.join(_os.default.homedir(), '.fulcrum');
    this._dataPath = this.args.dataPath || this.appPath('data');
    this._logPath = this.args.logPath || this.appPath('log');
    this._pluginPath = this.path('plugins');

    _mkdirp.default.sync(this._appPath);

    _mkdirp.default.sync(this._homePath);

    _mkdirp.default.sync(this._dataPath);

    _mkdirp.default.sync(this._logPath);

    _mkdirp.default.sync(this._pluginPath);

    this._logger = new _logger.default(this._logPath);
    this._environment = new _environment.default({
      app: this
    });
  }

  get pluginsByName() {
    return this._pluginsByName;
  }

  get environment() {
    return this._environment;
  }

  get api() {
    return this._api;
  }

  get yargs() {
    if (!this._yargs) {
      this._yargs = _yargs.default.env('FULCRUM');
    }

    return this._yargs;
  }

  get args() {
    return this.yargs.argv;
  }

  appPath(name) {
    return _path.default.join(this._appPath, name);
  }

  appDir(name) {
    return this.appPath(name);
  }

  path(name) {
    return _path.default.join(this._homePath, name);
  }

  dir(name) {
    return this.path(name);
  }

  mkdirp(name) {
    _mkdirp.default.sync(this.path(name));
  }

  get pluginPath() {
    return this._pluginPath;
  }

  get dataPath() {
    return this._dataPath;
  }

  get databaseFilePath() {
    return _path.default.join(this.dataPath, 'fulcrum.db');
  }

  get logPath() {
    return this._logPath;
  }

  get db() {
    return this._db;
  }

  on(name, func) {
    if (!this._listeners[name]) {
      this._listeners[name] = [];
    }

    this._listeners[name].push(func);
  }

  off(name, func) {
    if (this._listeners[name]) {
      const index = this._listeners.indexOf(func);

      if (index > -1) {
        this._listeners.splice(index, 1);
      }
    }
  }

  async emit(name, ...args) {
    if (this._listeners[name]) {
      for (const listener of this._listeners[name]) {
        await listener(...args);
      }
    }
  }

  async initialize() {
    this._db = await (0, _database.default)({
      file: this.databaseFilePath
    });

    if (!this.args.safe) {
      await this.initializePlugins();
    }
  }

  async dispose() {
    for (const plugin of this._plugins) {
      if (plugin.deactivate) {
        await plugin.deactivate();
      }
    }

    if (this._db) {
      await this._db.close();
    }
  }

  async initializePlugins() {
    const pluginPaths = _glob.default.sync(_path.default.join(this.pluginPath, '*'));

    for (const pluginPath of pluginPaths) {
      const fullPath = _path.default.resolve(pluginPath);

      const logger = (0, _pluginLogger.default)(pluginPath);

      try {
        const pluginModule = require(fullPath);

        const PluginClass = pluginModule.default || pluginModule;
        const plugin = new PluginClass();
        const nameParts = fullPath.split(_path.default.sep);
        const name = nameParts[nameParts.length - 1].replace(/^fulcrum-desktop-/, '');
        this._pluginsByName[name] = plugin;

        this._plugins.push(plugin);

        if (this.args.debug) {
          logger.error('Loading plugin', fullPath);
        }
      } catch (ex) {
        logger.error('Failed to load plugin', ex);
        logger.error('This is most likely an error in the plugin.');
      }
    }
  }

  async activatePlugins() {
    for (const plugin of this._plugins) {
      await plugin.activate();
    }
  }

  async fetchAccount(name) {
    const where = {};

    if (name) {
      where.organization_name = name;
    }

    const accounts = await _account.default.findAll(this.db, where, 'updated_at DESC');
    return accounts[0];
  }

  async createDataSource(account) {
    let dataSource = new _fulcrumCore.DataSource();
    const localDatabase = new _localDatabaseDataSource.default(account);
    dataSource.add(localDatabase);
    await localDatabase.load(this.db);
    return dataSource;
  }

}

app = new App();
_environment.default.app = app;
global.__app__ = app;
global.__api__ = _api.default;
global.fulcrum = app.environment;
var _default = app;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWluL2FwcC5qcyJdLCJuYW1lcyI6WyJhcHAiLCJBcHAiLCJpbnN0YW5jZSIsImNvbnN0cnVjdG9yIiwiX3BsdWdpbnMiLCJfcGx1Z2luc0J5TmFtZSIsIl9saXN0ZW5lcnMiLCJfYXBpIiwiYXBpIiwicGF0aE92ZXJyaWRlIiwiYXJncyIsImhvbWVQYXRoIiwiX2FwcFBhdGgiLCJwYXRocyIsInVzZXJEYXRhIiwiX2hvbWVQYXRoIiwicGF0aCIsImpvaW4iLCJvcyIsImhvbWVkaXIiLCJfZGF0YVBhdGgiLCJkYXRhUGF0aCIsImFwcFBhdGgiLCJfbG9nUGF0aCIsImxvZ1BhdGgiLCJfcGx1Z2luUGF0aCIsIm1rZGlycCIsInN5bmMiLCJfbG9nZ2VyIiwiTG9nZ2VyIiwiX2Vudmlyb25tZW50IiwiRW52aXJvbm1lbnQiLCJwbHVnaW5zQnlOYW1lIiwiZW52aXJvbm1lbnQiLCJ5YXJncyIsIl95YXJncyIsImVudiIsImFyZ3YiLCJuYW1lIiwiYXBwRGlyIiwiZGlyIiwicGx1Z2luUGF0aCIsImRhdGFiYXNlRmlsZVBhdGgiLCJkYiIsIl9kYiIsIm9uIiwiZnVuYyIsInB1c2giLCJvZmYiLCJpbmRleCIsImluZGV4T2YiLCJzcGxpY2UiLCJlbWl0IiwibGlzdGVuZXIiLCJpbml0aWFsaXplIiwiZmlsZSIsInNhZmUiLCJpbml0aWFsaXplUGx1Z2lucyIsImRpc3Bvc2UiLCJwbHVnaW4iLCJkZWFjdGl2YXRlIiwiY2xvc2UiLCJwbHVnaW5QYXRocyIsImdsb2IiLCJmdWxsUGF0aCIsInJlc29sdmUiLCJsb2dnZXIiLCJwbHVnaW5Nb2R1bGUiLCJyZXF1aXJlIiwiUGx1Z2luQ2xhc3MiLCJkZWZhdWx0IiwibmFtZVBhcnRzIiwic3BsaXQiLCJzZXAiLCJsZW5ndGgiLCJyZXBsYWNlIiwiZGVidWciLCJlcnJvciIsImV4IiwiYWN0aXZhdGVQbHVnaW5zIiwiYWN0aXZhdGUiLCJmZXRjaEFjY291bnQiLCJ3aGVyZSIsIm9yZ2FuaXphdGlvbl9uYW1lIiwiYWNjb3VudHMiLCJBY2NvdW50IiwiZmluZEFsbCIsImNyZWF0ZURhdGFTb3VyY2UiLCJhY2NvdW50IiwiZGF0YVNvdXJjZSIsIkRhdGFTb3VyY2UiLCJsb2NhbERhdGFiYXNlIiwiTG9jYWxEYXRhYmFzZURhdGFTb3VyY2UiLCJhZGQiLCJsb2FkIiwiZ2xvYmFsIiwiX19hcHBfXyIsIl9fYXBpX18iLCJmdWxjcnVtIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxJQUFJQSxHQUFHLEdBQUcsSUFBVjs7QUFFQSxNQUFNQyxHQUFOLENBQVU7QUFDVyxhQUFSQyxRQUFRLEdBQUc7QUFDcEIsV0FBT0YsR0FBUDtBQUNEOztBQUVERyxFQUFBQSxXQUFXLEdBQUc7QUFDWixTQUFLQyxRQUFMLEdBQWdCLEVBQWhCO0FBQ0EsU0FBS0MsY0FBTCxHQUFzQixFQUF0QjtBQUNBLFNBQUtDLFVBQUwsR0FBa0IsRUFBbEI7QUFDQSxTQUFLQyxJQUFMLEdBQVlDLFlBQVo7QUFFQSxVQUFNQyxZQUFZLEdBQUcsS0FBS0MsSUFBTCxDQUFVQyxRQUEvQjtBQUVBLFNBQUtDLFFBQUwsR0FBZ0JILFlBQVksSUFBSUksMEJBQU1DLFFBQXRDO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQk4sWUFBWSxJQUFJTyxjQUFLQyxJQUFMLENBQVVDLFlBQUdDLE9BQUgsRUFBVixFQUF3QixVQUF4QixDQUFqQztBQUNBLFNBQUtDLFNBQUwsR0FBaUIsS0FBS1YsSUFBTCxDQUFVVyxRQUFWLElBQXNCLEtBQUtDLE9BQUwsQ0FBYSxNQUFiLENBQXZDO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQixLQUFLYixJQUFMLENBQVVjLE9BQVYsSUFBcUIsS0FBS0YsT0FBTCxDQUFhLEtBQWIsQ0FBckM7QUFDQSxTQUFLRyxXQUFMLEdBQW1CLEtBQUtULElBQUwsQ0FBVSxTQUFWLENBQW5COztBQUVB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TUFBQUEsS0FBSyxDQUFDQyxpQkFBTixHQUEwQjdDLElBQTFCO0FBQ0Q7O0FBRUQsVUFBTThDLFFBQVEsR0FBRyxNQUFNQyxpQkFBUUMsT0FBUixDQUFnQixLQUFLM0MsRUFBckIsRUFBeUJ1QyxLQUF6QixFQUFnQyxpQkFBaEMsQ0FBdkI7QUFFQSxXQUFPRSxRQUFRLENBQUMsQ0FBRCxDQUFmO0FBQ0Q7O0FBRXFCLFFBQWhCRyxnQkFBZ0IsQ0FBQ0MsT0FBRCxFQUFVO0FBQzlCLFFBQUlDLFVBQVUsR0FBRyxJQUFJQyx1QkFBSixFQUFqQjtBQUVBLFVBQU1DLGFBQWEsR0FBRyxJQUFJQyxnQ0FBSixDQUE0QkosT0FBNUIsQ0FBdEI7QUFFQUMsSUFBQUEsVUFBVSxDQUFDSSxHQUFYLENBQWVGLGFBQWY7QUFFQSxVQUFNQSxhQUFhLENBQUNHLElBQWQsQ0FBbUIsS0FBS25ELEVBQXhCLENBQU47QUFFQSxXQUFPOEMsVUFBUDtBQUNEOztBQXRNTzs7QUF5TVZ6RixHQUFHLEdBQUcsSUFBSUMsR0FBSixFQUFOO0FBRUE4QixxQkFBWS9CLEdBQVosR0FBa0JBLEdBQWxCO0FBRUErRixNQUFNLENBQUNDLE9BQVAsR0FBaUJoRyxHQUFqQjtBQUNBK0YsTUFBTSxDQUFDRSxPQUFQLEdBQWlCekYsWUFBakI7QUFDQXVGLE1BQU0sQ0FBQ0csT0FBUCxHQUFpQmxHLEdBQUcsQ0FBQ2lDLFdBQXJCO2VBRWVqQyxHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGdsb2IgZnJvbSAnZ2xvYic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB5YXJncyBmcm9tICd5YXJncyc7XG5pbXBvcnQgbWtkaXJwIGZyb20gJ21rZGlycCc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IGRhdGFiYXNlIGZyb20gJy4vZGIvZGF0YWJhc2UnO1xuaW1wb3J0IGFwaSBmcm9tICcuL2FwaSc7XG5pbXBvcnQgRW52aXJvbm1lbnQgZnJvbSAnLi9lbnZpcm9ubWVudCc7XG5pbXBvcnQgQWNjb3VudCBmcm9tICcuL21vZGVscy9hY2NvdW50JztcbmltcG9ydCBMb2NhbERhdGFiYXNlRGF0YVNvdXJjZSBmcm9tICcuL2xvY2FsLWRhdGFiYXNlLWRhdGEtc291cmNlJztcbmltcG9ydCB7IERhdGFTb3VyY2UgfSBmcm9tICdmdWxjcnVtLWNvcmUnO1xuaW1wb3J0IHBhdGhzIGZyb20gJy4uL2FwcGxpY2F0aW9uLXBhdGhzJztcbmltcG9ydCBwbHVnaW5Mb2dnZXIgZnJvbSAnLi9wbHVnaW4tbG9nZ2VyJztcbmltcG9ydCBMb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5sZXQgYXBwID0gbnVsbDtcblxuY2xhc3MgQXBwIHtcbiAgc3RhdGljIGdldCBpbnN0YW5jZSgpIHtcbiAgICByZXR1cm4gYXBwO1xuICB9XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5fcGx1Z2lucyA9IFtdO1xuICAgIHRoaXMuX3BsdWdpbnNCeU5hbWUgPSBbXTtcbiAgICB0aGlzLl9saXN0ZW5lcnMgPSB7fTtcbiAgICB0aGlzLl9hcGkgPSBhcGk7XG5cbiAgICBjb25zdCBwYXRoT3ZlcnJpZGUgPSB0aGlzLmFyZ3MuaG9tZVBhdGg7XG5cbiAgICB0aGlzLl9hcHBQYXRoID0gcGF0aE92ZXJyaWRlIHx8IHBhdGhzLnVzZXJEYXRhO1xuICAgIHRoaXMuX2hvbWVQYXRoID0gcGF0aE92ZXJyaWRlIHx8IHBhdGguam9pbihvcy5ob21lZGlyKCksICcuZnVsY3J1bScpO1xuICAgIHRoaXMuX2RhdGFQYXRoID0gdGhpcy5hcmdzLmRhdGFQYXRoIHx8IHRoaXMuYXBwUGF0aCgnZGF0YScpO1xuICAgIHRoaXMuX2xvZ1BhdGggPSB0aGlzLmFyZ3MubG9nUGF0aCB8fCB0aGlzLmFwcFBhdGgoJ2xvZycpO1xuICAgIHRoaXMuX3BsdWdpblBhdGggPSB0aGlzLnBhdGgoJ3BsdWdpbnMnKTtcblxuICAgIG1rZGlycC5zeW5jKHRoaXMuX2FwcFBhdGgpO1xuICAgIG1rZGlycC5zeW5jKHRoaXMuX2hvbWVQYXRoKTtcbiAgICBta2RpcnAuc3luYyh0aGlzLl9kYXRhUGF0aCk7XG4gICAgbWtkaXJwLnN5bmModGhpcy5fbG9nUGF0aCk7XG4gICAgbWtkaXJwLnN5bmModGhpcy5fcGx1Z2luUGF0aCk7XG5cbiAgICB0aGlzLl9sb2dnZXIgPSBuZXcgTG9nZ2VyKHRoaXMuX2xvZ1BhdGgpO1xuXG4gICAgdGhpcy5fZW52aXJvbm1lbnQgPSBuZXcgRW52aXJvbm1lbnQoe2FwcDogdGhpc30pO1xuICB9XG5cbiAgZ2V0IHBsdWdpbnNCeU5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3BsdWdpbnNCeU5hbWU7XG4gIH1cblxuICBnZXQgZW52aXJvbm1lbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Vudmlyb25tZW50O1xuICB9XG5cbiAgZ2V0IGFwaSgpIHtcbiAgICByZXR1cm4gdGhpcy5fYXBpO1xuICB9XG5cbiAgZ2V0IHlhcmdzKCkge1xuICAgIGlmICghdGhpcy5feWFyZ3MpIHtcbiAgICAgIHRoaXMuX3lhcmdzID0geWFyZ3MuZW52KCdGVUxDUlVNJyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl95YXJncztcbiAgfVxuXG4gIGdldCBhcmdzKCkge1xuICAgIHJldHVybiB0aGlzLnlhcmdzLmFyZ3Y7XG4gIH1cblxuICBhcHBQYXRoKG5hbWUpIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMuX2FwcFBhdGgsIG5hbWUpO1xuICB9XG5cbiAgYXBwRGlyKG5hbWUpIHtcbiAgICByZXR1cm4gdGhpcy5hcHBQYXRoKG5hbWUpO1xuICB9XG5cbiAgcGF0aChuYW1lKSB7XG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLl9ob21lUGF0aCwgbmFtZSk7XG4gIH1cblxuICBkaXIobmFtZSkge1xuICAgIHJldHVybiB0aGlzLnBhdGgobmFtZSk7XG4gIH1cblxuICBta2RpcnAobmFtZSkge1xuICAgIG1rZGlycC5zeW5jKHRoaXMucGF0aChuYW1lKSk7XG4gIH1cblxuICBnZXQgcGx1Z2luUGF0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5fcGx1Z2luUGF0aDtcbiAgfVxuXG4gIGdldCBkYXRhUGF0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5fZGF0YVBhdGg7XG4gIH1cblxuICBnZXQgZGF0YWJhc2VGaWxlUGF0aCgpIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMuZGF0YVBhdGgsICdmdWxjcnVtLmRiJyk7XG4gIH1cblxuICBnZXQgbG9nUGF0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5fbG9nUGF0aDtcbiAgfVxuXG4gIGdldCBkYigpIHtcbiAgICByZXR1cm4gdGhpcy5fZGI7XG4gIH1cblxuICBvbihuYW1lLCBmdW5jKSB7XG4gICAgaWYgKCF0aGlzLl9saXN0ZW5lcnNbbmFtZV0pIHtcbiAgICAgIHRoaXMuX2xpc3RlbmVyc1tuYW1lXSA9IFtdO1xuICAgIH1cblxuICAgIHRoaXMuX2xpc3RlbmVyc1tuYW1lXS5wdXNoKGZ1bmMpO1xuICB9XG5cbiAgb2ZmKG5hbWUsIGZ1bmMpIHtcbiAgICBpZiAodGhpcy5fbGlzdGVuZXJzW25hbWVdKSB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuX2xpc3RlbmVycy5pbmRleE9mKGZ1bmMpO1xuXG4gICAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgICB0aGlzLl9saXN0ZW5lcnMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBlbWl0KG5hbWUsIC4uLmFyZ3MpIHtcbiAgICBpZiAodGhpcy5fbGlzdGVuZXJzW25hbWVdKSB7XG4gICAgICBmb3IgKGNvbnN0IGxpc3RlbmVyIG9mIHRoaXMuX2xpc3RlbmVyc1tuYW1lXSkge1xuICAgICAgICBhd2FpdCBsaXN0ZW5lciguLi5hcmdzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBpbml0aWFsaXplKCkge1xuICAgIHRoaXMuX2RiID0gYXdhaXQgZGF0YWJhc2Uoe2ZpbGU6IHRoaXMuZGF0YWJhc2VGaWxlUGF0aH0pO1xuXG4gICAgaWYgKCF0aGlzLmFyZ3Muc2FmZSkge1xuICAgICAgYXdhaXQgdGhpcy5pbml0aWFsaXplUGx1Z2lucygpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRpc3Bvc2UoKSB7XG4gICAgZm9yIChjb25zdCBwbHVnaW4gb2YgdGhpcy5fcGx1Z2lucykge1xuICAgICAgaWYgKHBsdWdpbi5kZWFjdGl2YXRlKSB7XG4gICAgICAgIGF3YWl0IHBsdWdpbi5kZWFjdGl2YXRlKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX2RiKSB7XG4gICAgICBhd2FpdCB0aGlzLl9kYi5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluaXRpYWxpemVQbHVnaW5zKCkge1xuICAgIGNvbnN0IHBsdWdpblBhdGhzID0gZ2xvYi5zeW5jKHBhdGguam9pbih0aGlzLnBsdWdpblBhdGgsICcqJykpO1xuXG4gICAgZm9yIChjb25zdCBwbHVnaW5QYXRoIG9mIHBsdWdpblBhdGhzKSB7XG4gICAgICBjb25zdCBmdWxsUGF0aCA9IHBhdGgucmVzb2x2ZShwbHVnaW5QYXRoKTtcblxuICAgICAgY29uc3QgbG9nZ2VyID0gcGx1Z2luTG9nZ2VyKHBsdWdpblBhdGgpO1xuXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwbHVnaW5Nb2R1bGUgPSByZXF1aXJlKGZ1bGxQYXRoKTtcblxuICAgICAgICBjb25zdCBQbHVnaW5DbGFzcyA9IHBsdWdpbk1vZHVsZS5kZWZhdWx0IHx8IHBsdWdpbk1vZHVsZTtcblxuICAgICAgICBjb25zdCBwbHVnaW4gPSBuZXcgUGx1Z2luQ2xhc3MoKTtcblxuICAgICAgICBjb25zdCBuYW1lUGFydHMgPSBmdWxsUGF0aC5zcGxpdChwYXRoLnNlcCk7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBuYW1lUGFydHNbbmFtZVBhcnRzLmxlbmd0aCAtIDFdLnJlcGxhY2UoL15mdWxjcnVtLWRlc2t0b3AtLywgJycpO1xuXG4gICAgICAgIHRoaXMuX3BsdWdpbnNCeU5hbWVbbmFtZV0gPSBwbHVnaW47XG4gICAgICAgIHRoaXMuX3BsdWdpbnMucHVzaChwbHVnaW4pO1xuXG4gICAgICAgIGlmICh0aGlzLmFyZ3MuZGVidWcpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0xvYWRpbmcgcGx1Z2luJywgZnVsbFBhdGgpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChleCkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBsb2FkIHBsdWdpbicsIGV4KTtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdUaGlzIGlzIG1vc3QgbGlrZWx5IGFuIGVycm9yIGluIHRoZSBwbHVnaW4uJyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgYWN0aXZhdGVQbHVnaW5zKCkge1xuICAgIGZvciAoY29uc3QgcGx1Z2luIG9mIHRoaXMuX3BsdWdpbnMpIHtcbiAgICAgIGF3YWl0IHBsdWdpbi5hY3RpdmF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZldGNoQWNjb3VudChuYW1lKSB7XG4gICAgY29uc3Qgd2hlcmUgPSB7fTtcblxuICAgIGlmIChuYW1lKSB7XG4gICAgICB3aGVyZS5vcmdhbml6YXRpb25fbmFtZSA9IG5hbWU7XG4gICAgfVxuXG4gICAgY29uc3QgYWNjb3VudHMgPSBhd2FpdCBBY2NvdW50LmZpbmRBbGwodGhpcy5kYiwgd2hlcmUsICd1cGRhdGVkX2F0IERFU0MnKTtcblxuICAgIHJldHVybiBhY2NvdW50c1swXTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZURhdGFTb3VyY2UoYWNjb3VudCkge1xuICAgIGxldCBkYXRhU291cmNlID0gbmV3IERhdGFTb3VyY2UoKTtcblxuICAgIGNvbnN0IGxvY2FsRGF0YWJhc2UgPSBuZXcgTG9jYWxEYXRhYmFzZURhdGFTb3VyY2UoYWNjb3VudCk7XG5cbiAgICBkYXRhU291cmNlLmFkZChsb2NhbERhdGFiYXNlKTtcblxuICAgIGF3YWl0IGxvY2FsRGF0YWJhc2UubG9hZCh0aGlzLmRiKTtcblxuICAgIHJldHVybiBkYXRhU291cmNlO1xuICB9XG59XG5cbmFwcCA9IG5ldyBBcHAoKTtcblxuRW52aXJvbm1lbnQuYXBwID0gYXBwO1xuXG5nbG9iYWwuX19hcHBfXyA9IGFwcDtcbmdsb2JhbC5fX2FwaV9fID0gYXBpO1xuZ2xvYmFsLmZ1bGNydW0gPSBhcHAuZW52aXJvbm1lbnQ7XG5cbmV4cG9ydCBkZWZhdWx0IGFwcDtcbiJdfQ==
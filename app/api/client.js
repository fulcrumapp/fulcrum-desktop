"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _request = _interopRequireDefault(require("request"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _fs = _interopRequireDefault(require("fs"));

var _lodash = require("lodash");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const reqPromise = _bluebird.default.promisify(_request.default);

const req = options => reqPromise({
  forever: true,
  ...options
});

const defaultOptions = {
  headers: {
    'User-Agent': 'Fulcrum Sync',
    'Accept': 'application/json'
  }
};
const BASE_URL = 'https://api.fulcrumapp.com';

class Client {
  urlForResource(resource) {
    return BASE_URL + resource;
  }

  rawRequest(options) {
    return (0, _request.default)({
      forever: true,
      ...options
    });
  }

  request(options) {
    return req(options);
  }

  optionsForAuthenticatedRequest(token, options) {
    const result = (0, _lodash.extend)({}, defaultOptions, options);

    if (token) {
      result.headers['X-ApiToken'] = token;
    }

    return result;
  }

  authenticate(userName, password) {
    const options = {
      method: 'GET',
      uri: this.urlForResource('/api/v2/users.json'),
      auth: {
        username: userName,
        password: password,
        sendImmediately: true
      },
      headers: defaultOptions.headers
    };
    return this.request(options);
  }

  authenticateWithToken(token) {
    return this.request(this.getRequestOptions(token, '/api/v2/users.json'));
  }

  getRequestOptions(token, path, opts) {
    return this.optionsForAuthenticatedRequest(token, {
      url: this.urlForResource(path),
      ...opts
    });
  }

  getResource(account, path, opts = {}) {
    return this.request(this.getRequestOptions(account.token, path, opts));
  }

  getSync(account) {
    return this.getResource(account, '/api/_private/sync.json');
  }

  getRoles(account) {
    return this.getResource(account, '/api/v2/roles.json');
  }

  getMemberships(account) {
    return this.getResource(account, '/api/v2/memberships.json');
  }

  getForms(account) {
    return this.getResource(account, '/api/v2/forms.json');
  }

  getChoiceLists(account) {
    return this.getResource(account, '/api/v2/choice_lists.json');
  }

  getClassificationSets(account) {
    return this.getResource(account, '/api/v2/classification_sets.json');
  }

  getProjects(account) {
    return this.getResource(account, '/api/v2/projects.json');
  }

  getPhotos(account, sequence, perPage) {
    const qs = {
      per_page: perPage,
      sequence: sequence || 0,
      full: '1'
    };
    return this.getResource(account, '/api/v2/photos.json', {
      qs
    });
  }

  getVideos(account, sequence, perPage) {
    const qs = {
      per_page: perPage,
      sequence: sequence || 0,
      full: '1'
    };
    return this.getResource(account, '/api/v2/videos.json', {
      qs
    });
  }

  getAudio(account, sequence, perPage) {
    const qs = {
      per_page: perPage,
      sequence: sequence || 0,
      full: '1'
    };
    return this.getResource(account, '/api/v2/audio.json', {
      qs
    });
  }

  getSignatures(account, sequence, perPage) {
    const qs = {
      per_page: perPage,
      sequence: sequence || 0,
      full: '1'
    };
    return this.getResource(account, '/api/v2/signatures.json', {
      qs
    });
  }

  getChangesets(account, sequence, perPage) {
    const qs = {
      per_page: perPage,
      sequence: sequence || 0,
      counts: '0'
    };
    return this.getResource(account, '/api/v2/changesets.json', {
      qs
    });
  }

  getQueryURL(account, sql) {
    const qs = {
      q: sql,
      format: 'jsonseq',
      arrays: 1
    };
    return this.getRequestOptions(account.token, '/api/v2/query', {
      qs
    });
  }

  getPhotoURL(account, media) {
    return this.urlForResource(`/api/v2/photos/${media.id}?token=${account.token}`);
  }

  getVideoURL(account, media) {
    return this.urlForResource(`/api/v2/videos/${media.id}?token=${account.token}`);
  }

  getVideoTrackURL(account, media) {
    return this.urlForResource(`/api/v2/videos/${media.id}/track.json?token=${account.token}`);
  }

  getVideoTrack(account, media) {
    return this.getResource(account, `/api/v2/videos/${media.id}/track.json`);
  }

  getAudioURL(account, media) {
    return this.urlForResource(`/api/v2/audio/${media.id}?token=${account.token}`);
  }

  getAudioTrackURL(account, media) {
    return this.urlForResource(`/api/v2/audio/${media.id}/track.json?token=${account.token}`);
  }

  getAudioTrack(account, media) {
    return this.getResource(account, `/api/v2/audio/${media.id}/track.json`);
  }

  getSignatureURL(account, media) {
    return this.urlForResource(`/api/v2/signatures/${media.id}?token=${account.token}`);
  }

  download(url, to) {
    return new _bluebird.default((resolve, reject) => {
      const rq = (0, _request.default)(url).pipe(_fs.default.createWriteStream(to));
      rq.on('close', () => resolve(rq));
      rq.on('error', reject);
    });
  }

  getRecords(account, form, sequence, pageSize) {
    const qs = {
      form_id: form.id,
      per_page: pageSize,
      sequence: sequence || 0
    };
    return this.getResource(account, '/api/v2/records.json', {
      qs
    });
  }

  getRecordsHistory(account, form, sequence, pageSize) {
    const qs = {
      form_id: form.id,
      per_page: pageSize,
      extents: 0,
      sequence: sequence || 0
    };
    return this.getResource(account, '/api/v2/records/history.json', {
      qs
    });
  }

}

const client = new Client();
var _default = client;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvY2xpZW50LmpzIl0sIm5hbWVzIjpbInJlcVByb21pc2UiLCJQcm9taXNlIiwicHJvbWlzaWZ5IiwicmVxdWVzdCIsInJlcSIsIm9wdGlvbnMiLCJmb3JldmVyIiwiZGVmYXVsdE9wdGlvbnMiLCJoZWFkZXJzIiwiQkFTRV9VUkwiLCJDbGllbnQiLCJ1cmxGb3JSZXNvdXJjZSIsInJlc291cmNlIiwicmF3UmVxdWVzdCIsIm9wdGlvbnNGb3JBdXRoZW50aWNhdGVkUmVxdWVzdCIsInRva2VuIiwicmVzdWx0IiwiYXV0aGVudGljYXRlIiwidXNlck5hbWUiLCJwYXNzd29yZCIsIm1ldGhvZCIsInVyaSIsImF1dGgiLCJ1c2VybmFtZSIsInNlbmRJbW1lZGlhdGVseSIsImF1dGhlbnRpY2F0ZVdpdGhUb2tlbiIsImdldFJlcXVlc3RPcHRpb25zIiwicGF0aCIsIm9wdHMiLCJ1cmwiLCJnZXRSZXNvdXJjZSIsImFjY291bnQiLCJnZXRTeW5jIiwiZ2V0Um9sZXMiLCJnZXRNZW1iZXJzaGlwcyIsImdldEZvcm1zIiwiZ2V0Q2hvaWNlTGlzdHMiLCJnZXRDbGFzc2lmaWNhdGlvblNldHMiLCJnZXRQcm9qZWN0cyIsImdldFBob3RvcyIsInNlcXVlbmNlIiwicGVyUGFnZSIsInFzIiwicGVyX3BhZ2UiLCJmdWxsIiwiZ2V0VmlkZW9zIiwiZ2V0QXVkaW8iLCJnZXRTaWduYXR1cmVzIiwiZ2V0Q2hhbmdlc2V0cyIsImNvdW50cyIsImdldFF1ZXJ5VVJMIiwic3FsIiwicSIsImZvcm1hdCIsImFycmF5cyIsImdldFBob3RvVVJMIiwibWVkaWEiLCJpZCIsImdldFZpZGVvVVJMIiwiZ2V0VmlkZW9UcmFja1VSTCIsImdldFZpZGVvVHJhY2siLCJnZXRBdWRpb1VSTCIsImdldEF1ZGlvVHJhY2tVUkwiLCJnZXRBdWRpb1RyYWNrIiwiZ2V0U2lnbmF0dXJlVVJMIiwiZG93bmxvYWQiLCJ0byIsInJlc29sdmUiLCJyZWplY3QiLCJycSIsInBpcGUiLCJmcyIsImNyZWF0ZVdyaXRlU3RyZWFtIiwib24iLCJnZXRSZWNvcmRzIiwiZm9ybSIsInBhZ2VTaXplIiwiZm9ybV9pZCIsImdldFJlY29yZHNIaXN0b3J5IiwiZXh0ZW50cyIsImNsaWVudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsVUFBVSxHQUFHQyxrQkFBUUMsU0FBUixDQUFrQkMsZ0JBQWxCLENBQW5COztBQUNBLE1BQU1DLEdBQUcsR0FBSUMsT0FBRCxJQUFhTCxVQUFVLENBQUM7QUFBQ00sRUFBQUEsT0FBTyxFQUFFLElBQVY7QUFBZ0IsS0FBR0Q7QUFBbkIsQ0FBRCxDQUFuQzs7QUFFQSxNQUFNRSxjQUFjLEdBQUc7QUFDckJDLEVBQUFBLE9BQU8sRUFBRTtBQUNQLGtCQUFjLGNBRFA7QUFFUCxjQUFVO0FBRkg7QUFEWSxDQUF2QjtBQU9BLE1BQU1DLFFBQVEsR0FBRyw0QkFBakI7O0FBRUEsTUFBTUMsTUFBTixDQUFhO0FBQ1hDLEVBQUFBLGNBQWMsQ0FBQ0MsUUFBRCxFQUFXO0FBQ3ZCLFdBQU9ILFFBQVEsR0FBR0csUUFBbEI7QUFDRDs7QUFFREMsRUFBQUEsVUFBVSxDQUFDUixPQUFELEVBQVU7QUFDbEIsV0FBTyxzQkFBUTtBQUFDQyxNQUFBQSxPQUFPLEVBQUUsSUFBVjtBQUFnQixTQUFHRDtBQUFuQixLQUFSLENBQVA7QUFDRDs7QUFFREYsRUFBQUEsT0FBTyxDQUFDRSxPQUFELEVBQVU7QUFDZixXQUFPRCxHQUFHLENBQUNDLE9BQUQsQ0FBVjtBQUNEOztBQUVEUyxFQUFBQSw4QkFBOEIsQ0FBQ0MsS0FBRCxFQUFRVixPQUFSLEVBQWlCO0FBQzdDLFVBQU1XLE1BQU0sR0FBRyxvQkFBTyxFQUFQLEVBQVdULGNBQVgsRUFBMkJGLE9BQTNCLENBQWY7O0FBRUEsUUFBSVUsS0FBSixFQUFXO0FBQ1RDLE1BQUFBLE1BQU0sQ0FBQ1IsT0FBUCxDQUFlLFlBQWYsSUFBK0JPLEtBQS9CO0FBQ0Q7O0FBRUQsV0FBT0MsTUFB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TCxNQUFmO0FBQ0QsS0FKTSxDQUFQO0FBS0Q7O0FBRURNLEVBQUFBLFVBQVUsQ0FBQzNDLE9BQUQsRUFBVTRDLElBQVYsRUFBZ0JuQyxRQUFoQixFQUEwQm9DLFFBQTFCLEVBQW9DO0FBQzVDLFVBQU1sQyxFQUFFLEdBQUc7QUFDVG1DLE1BQUFBLE9BQU8sRUFBRUYsSUFBSSxDQUFDbEIsRUFETDtBQUVUZCxNQUFBQSxRQUFRLEVBQUVpQyxRQUZEO0FBR1RwQyxNQUFBQSxRQUFRLEVBQUVBLFFBQVEsSUFBSTtBQUhiLEtBQVg7QUFNQSxXQUFPLEtBQUtWLFdBQUwsQ0FBaUJDLE9BQWpCLEVBQTBCLHNCQUExQixFQUFrRDtBQUFDVyxNQUFBQTtBQUFELEtBQWxELENBQVA7QUFDRDs7QUFFRG9DLEVBQUFBLGlCQUFpQixDQUFDL0MsT0FBRCxFQUFVNEMsSUFBVixFQUFnQm5DLFFBQWhCLEVBQTBCb0MsUUFBMUIsRUFBb0M7QUFDbkQsVUFBTWxDLEVBQUUsR0FBRztBQUNUbUMsTUFBQUEsT0FBTyxFQUFFRixJQUFJLENBQUNsQixFQURMO0FBRVRkLE1BQUFBLFFBQVEsRUFBRWlDLFFBRkQ7QUFHVEcsTUFBQUEsT0FBTyxFQUFFLENBSEE7QUFJVHZDLE1BQUFBLFFBQVEsRUFBRUEsUUFBUSxJQUFJO0FBSmIsS0FBWDtBQU9BLFdBQU8sS0FBS1YsV0FBTCxDQUFpQkMsT0FBakIsRUFBMEIsOEJBQTFCLEVBQTBEO0FBQUNXLE1BQUFBO0FBQUQsS0FBMUQsQ0FBUDtBQUNEOztBQXhNVTs7QUEyTWIsTUFBTXNDLE1BQU0sR0FBRyxJQUFJdEUsTUFBSixFQUFmO2VBRWVzRSxNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdCc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgZXh0ZW5kIH0gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgcmVxUHJvbWlzZSA9IFByb21pc2UucHJvbWlzaWZ5KHJlcXVlc3QpO1xuY29uc3QgcmVxID0gKG9wdGlvbnMpID0+IHJlcVByb21pc2Uoe2ZvcmV2ZXI6IHRydWUsIC4uLm9wdGlvbnN9KTtcblxuY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gIGhlYWRlcnM6IHtcbiAgICAnVXNlci1BZ2VudCc6ICdGdWxjcnVtIFN5bmMnLFxuICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbidcbiAgfVxufTtcblxuY29uc3QgQkFTRV9VUkwgPSAnaHR0cHM6Ly9hcGkuZnVsY3J1bWFwcC5jb20nO1xuXG5jbGFzcyBDbGllbnQge1xuICB1cmxGb3JSZXNvdXJjZShyZXNvdXJjZSkge1xuICAgIHJldHVybiBCQVNFX1VSTCArIHJlc291cmNlO1xuICB9XG5cbiAgcmF3UmVxdWVzdChvcHRpb25zKSB7XG4gICAgcmV0dXJuIHJlcXVlc3Qoe2ZvcmV2ZXI6IHRydWUsIC4uLm9wdGlvbnN9KTtcbiAgfVxuXG4gIHJlcXVlc3Qob3B0aW9ucykge1xuICAgIHJldHVybiByZXEob3B0aW9ucyk7XG4gIH1cblxuICBvcHRpb25zRm9yQXV0aGVudGljYXRlZFJlcXVlc3QodG9rZW4sIG9wdGlvbnMpIHtcbiAgICBjb25zdCByZXN1bHQgPSBleHRlbmQoe30sIGRlZmF1bHRPcHRpb25zLCBvcHRpb25zKTtcblxuICAgIGlmICh0b2tlbikge1xuICAgICAgcmVzdWx0LmhlYWRlcnNbJ1gtQXBpVG9rZW4nXSA9IHRva2VuO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBhdXRoZW50aWNhdGUodXNlck5hbWUsIHBhc3N3b3JkKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICB1cmk6IHRoaXMudXJsRm9yUmVzb3VyY2UoJy9hcGkvdjIvdXNlcnMuanNvbicpLFxuICAgICAgYXV0aDoge1xuICAgICAgICB1c2VybmFtZTogdXNlck5hbWUsXG4gICAgICAgIHBhc3N3b3JkOiBwYXNzd29yZCxcbiAgICAgICAgc2VuZEltbWVkaWF0ZWx5OiB0cnVlXG4gICAgICB9LFxuICAgICAgaGVhZGVyczogZGVmYXVsdE9wdGlvbnMuaGVhZGVyc1xuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KG9wdGlvbnMpO1xuICB9XG5cbiAgYXV0aGVudGljYXRlV2l0aFRva2VuKHRva2VuKSB7XG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdCh0aGlzLmdldFJlcXVlc3RPcHRpb25zKHRva2VuLCAnL2FwaS92Mi91c2Vycy5qc29uJykpO1xuICB9XG5cbiAgZ2V0UmVxdWVzdE9wdGlvbnModG9rZW4sIHBhdGgsIG9wdHMpIHtcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zRm9yQXV0aGVudGljYXRlZFJlcXVlc3QodG9rZW4sIHtcbiAgICAgIHVybDogdGhpcy51cmxGb3JSZXNvdXJjZShwYXRoKSxcbiAgICAgIC4uLm9wdHNcbiAgICB9KTtcbiAgfVxuXG4gIGdldFJlc291cmNlKGFjY291bnQsIHBhdGgsIG9wdHMgPSB7fSkge1xuICAgIHJldHVybiB0aGlzLnJlcXVlc3QodGhpcy5nZXRSZXF1ZXN0T3B0aW9ucyhhY2NvdW50LnRva2VuLCBwYXRoLCBvcHRzKSk7XG4gIH1cblxuICBnZXRTeW5jKGFjY291bnQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZXNvdXJjZShhY2NvdW50LCAnL2FwaS9fcHJpdmF0ZS9zeW5jLmpzb24nKTtcbiAgfVxuXG4gIGdldFJvbGVzKGFjY291bnQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZXNvdXJjZShhY2NvdW50LCAnL2FwaS92Mi9yb2xlcy5qc29uJyk7XG4gIH1cblxuICBnZXRNZW1iZXJzaGlwcyhhY2NvdW50KSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVzb3VyY2UoYWNjb3VudCwgJy9hcGkvdjIvbWVtYmVyc2hpcHMuanNvbicpO1xuICB9XG5cbiAgZ2V0Rm9ybXMoYWNjb3VudCkge1xuICAgIHJldHVybiB0aGlzLmdldFJlc291cmNlKGFjY291bnQsICcvYXBpL3YyL2Zvcm1zLmpzb24nKTtcbiAgfVxuXG4gIGdldENob2ljZUxpc3RzKGFjY291bnQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZXNvdXJjZShhY2NvdW50LCAnL2FwaS92Mi9jaG9pY2VfbGlzdHMuanNvbicpO1xuICB9XG5cbiAgZ2V0Q2xhc3NpZmljYXRpb25TZXRzKGFjY291bnQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZXNvdXJjZShhY2NvdW50LCAnL2FwaS92Mi9jbGFzc2lmaWNhdGlvbl9zZXRzLmpzb24nKTtcbiAgfVxuXG4gIGdldFByb2plY3RzKGFjY291bnQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRSZXNvdXJjZShhY2NvdW50LCAnL2FwaS92Mi9wcm9qZWN0cy5qc29uJyk7XG4gIH1cblxuICBnZXRQaG90b3MoYWNjb3VudCwgc2VxdWVuY2UsIHBlclBhZ2UpIHtcbiAgICBjb25zdCBxcyA9IHtcbiAgICAgIHBlcl9wYWdlOiBwZXJQYWdlLFxuICAgICAgc2VxdWVuY2U6IHNlcXVlbmNlIHx8IDAsXG4gICAgICBmdWxsOiAnMSdcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVzb3VyY2UoYWNjb3VudCwgJy9hcGkvdjIvcGhvdG9zLmpzb24nLCB7cXN9KTtcbiAgfVxuXG4gIGdldFZpZGVvcyhhY2NvdW50LCBzZXF1ZW5jZSwgcGVyUGFnZSkge1xuICAgIGNvbnN0IHFzID0ge1xuICAgICAgcGVyX3BhZ2U6IHBlclBhZ2UsXG4gICAgICBzZXF1ZW5jZTogc2VxdWVuY2UgfHwgMCxcbiAgICAgIGZ1bGw6ICcxJ1xuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5nZXRSZXNvdXJjZShhY2NvdW50LCAnL2FwaS92Mi92aWRlb3MuanNvbicsIHtxc30pO1xuICB9XG5cbiAgZ2V0QXVkaW8oYWNjb3VudCwgc2VxdWVuY2UsIHBlclBhZ2UpIHtcbiAgICBjb25zdCBxcyA9IHtcbiAgICAgIHBlcl9wYWdlOiBwZXJQYWdlLFxuICAgICAgc2VxdWVuY2U6IHNlcXVlbmNlIHx8IDAsXG4gICAgICBmdWxsOiAnMSdcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVzb3VyY2UoYWNjb3VudCwgJy9hcGkvdjIvYXVkaW8uanNvbicsIHtxc30pO1xuICB9XG5cbiAgZ2V0U2lnbmF0dXJlcyhhY2NvdW50LCBzZXF1ZW5jZSwgcGVyUGFnZSkge1xuICAgIGNvbnN0IHFzID0ge1xuICAgICAgcGVyX3BhZ2U6IHBlclBhZ2UsXG4gICAgICBzZXF1ZW5jZTogc2VxdWVuY2UgfHwgMCxcbiAgICAgIGZ1bGw6ICcxJ1xuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5nZXRSZXNvdXJjZShhY2NvdW50LCAnL2FwaS92Mi9zaWduYXR1cmVzLmpzb24nLCB7cXN9KTtcbiAgfVxuXG4gIGdldENoYW5nZXNldHMoYWNjb3VudCwgc2VxdWVuY2UsIHBlclBhZ2UpIHtcbiAgICBjb25zdCBxcyA9IHtcbiAgICAgIHBlcl9wYWdlOiBwZXJQYWdlLFxuICAgICAgc2VxdWVuY2U6IHNlcXVlbmNlIHx8IDAsXG4gICAgICBjb3VudHM6ICcwJ1xuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5nZXRSZXNvdXJjZShhY2NvdW50LCAnL2FwaS92Mi9jaGFuZ2VzZXRzLmpzb24nLCB7cXN9KTtcbiAgfVxuXG4gIGdldFF1ZXJ5VVJMKGFjY291bnQsIHNxbCkge1xuICAgIGNvbnN0IHFzID0ge1xuICAgICAgcTogc3FsLFxuICAgICAgZm9ybWF0OiAnanNvbnNlcScsXG4gICAgICBhcnJheXM6IDFcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVxdWVzdE9wdGlvbnMoYWNjb3VudC50b2tlbiwgJy9hcGkvdjIvcXVlcnknLCB7cXN9KTtcbiAgfVxuXG4gIGdldFBob3RvVVJMKGFjY291bnQsIG1lZGlhKSB7XG4gICAgcmV0dXJuIHRoaXMudXJsRm9yUmVzb3VyY2UoYC9hcGkvdjIvcGhvdG9zLyR7IG1lZGlhLmlkIH0/dG9rZW49JHthY2NvdW50LnRva2VufWApO1xuICB9XG5cbiAgZ2V0VmlkZW9VUkwoYWNjb3VudCwgbWVkaWEpIHtcbiAgICByZXR1cm4gdGhpcy51cmxGb3JSZXNvdXJjZShgL2FwaS92Mi92aWRlb3MvJHsgbWVkaWEuaWQgfT90b2tlbj0ke2FjY291bnQudG9rZW59YCk7XG4gIH1cblxuICBnZXRWaWRlb1RyYWNrVVJMKGFjY291bnQsIG1lZGlhKSB7XG4gICAgcmV0dXJuIHRoaXMudXJsRm9yUmVzb3VyY2UoYC9hcGkvdjIvdmlkZW9zLyR7IG1lZGlhLmlkIH0vdHJhY2suanNvbj90b2tlbj0ke2FjY291bnQudG9rZW59YCk7XG4gIH1cblxuICBnZXRWaWRlb1RyYWNrKGFjY291bnQsIG1lZGlhKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVzb3VyY2UoYWNjb3VudCwgYC9hcGkvdjIvdmlkZW9zLyR7IG1lZGlhLmlkIH0vdHJhY2suanNvbmApO1xuICB9XG5cbiAgZ2V0QXVkaW9VUkwoYWNjb3VudCwgbWVkaWEpIHtcbiAgICByZXR1cm4gdGhpcy51cmxGb3JSZXNvdXJjZShgL2FwaS92Mi9hdWRpby8keyBtZWRpYS5pZCB9P3Rva2VuPSR7YWNjb3VudC50b2tlbn1gKTtcbiAgfVxuXG4gIGdldEF1ZGlvVHJhY2tVUkwoYWNjb3VudCwgbWVkaWEpIHtcbiAgICByZXR1cm4gdGhpcy51cmxGb3JSZXNvdXJjZShgL2FwaS92Mi9hdWRpby8keyBtZWRpYS5pZCB9L3RyYWNrLmpzb24/dG9rZW49JHthY2NvdW50LnRva2VufWApO1xuICB9XG5cbiAgZ2V0QXVkaW9UcmFjayhhY2NvdW50LCBtZWRpYSkge1xuICAgIHJldHVybiB0aGlzLmdldFJlc291cmNlKGFjY291bnQsIGAvYXBpL3YyL2F1ZGlvLyR7IG1lZGlhLmlkIH0vdHJhY2suanNvbmApO1xuICB9XG5cbiAgZ2V0U2lnbmF0dXJlVVJMKGFjY291bnQsIG1lZGlhKSB7XG4gICAgcmV0dXJuIHRoaXMudXJsRm9yUmVzb3VyY2UoYC9hcGkvdjIvc2lnbmF0dXJlcy8keyBtZWRpYS5pZCB9P3Rva2VuPSR7YWNjb3VudC50b2tlbn1gKTtcbiAgfVxuXG4gIGRvd25sb2FkKHVybCwgdG8pIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgcnEgPSByZXF1ZXN0KHVybCkucGlwZShmcy5jcmVhdGVXcml0ZVN0cmVhbSh0bykpO1xuICAgICAgcnEub24oJ2Nsb3NlJywgKCkgPT4gcmVzb2x2ZShycSkpO1xuICAgICAgcnEub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldFJlY29yZHMoYWNjb3VudCwgZm9ybSwgc2VxdWVuY2UsIHBhZ2VTaXplKSB7XG4gICAgY29uc3QgcXMgPSB7XG4gICAgICBmb3JtX2lkOiBmb3JtLmlkLFxuICAgICAgcGVyX3BhZ2U6IHBhZ2VTaXplLFxuICAgICAgc2VxdWVuY2U6IHNlcXVlbmNlIHx8IDBcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVzb3VyY2UoYWNjb3VudCwgJy9hcGkvdjIvcmVjb3Jkcy5qc29uJywge3FzfSk7XG4gIH1cblxuICBnZXRSZWNvcmRzSGlzdG9yeShhY2NvdW50LCBmb3JtLCBzZXF1ZW5jZSwgcGFnZVNpemUpIHtcbiAgICBjb25zdCBxcyA9IHtcbiAgICAgIGZvcm1faWQ6IGZvcm0uaWQsXG4gICAgICBwZXJfcGFnZTogcGFnZVNpemUsXG4gICAgICBleHRlbnRzOiAwLFxuICAgICAgc2VxdWVuY2U6IHNlcXVlbmNlIHx8IDBcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVzb3VyY2UoYWNjb3VudCwgJy9hcGkvdjIvcmVjb3Jkcy9oaXN0b3J5Lmpzb24nLCB7cXN9KTtcbiAgfVxufVxuXG5jb25zdCBjbGllbnQgPSBuZXcgQ2xpZW50KCk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsaWVudDtcbiJdfQ==